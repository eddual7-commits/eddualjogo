<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üíô RPG Legends - Miku Edition</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    touch-action: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

body {
    background: linear-gradient(135deg, #0a1628, #1a2a4a);
    color: white;
    font-family: Arial, sans-serif;
    overflow: hidden;
}

/* TELA DE MENU */
#menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0a1628, #1a2a4a, #0d1f3c);
    z-index: 1000;
}

.hidden {
    display: none !important;
}

.logo {
    font-size: 3rem;
    font-weight: bold;
    background: linear-gradient(135deg, #39C5BB, #00BFFF, #00D4AA);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 20px;
    text-shadow: 0 0 30px rgba(57, 197, 187, 0.5);
}

.menu-box {
    background: rgba(0, 0, 0, 0.5);
    padding: 30px;
    border-radius: 20px;
    border: 2px solid #39C5BB;
    box-shadow: 0 0 30px rgba(57, 197, 187, 0.3);
}

input {
    width: 250px;
    padding: 15px;
    margin: 10px 0;
    border: 2px solid #39C5BB;
    background: rgba(57, 197, 187, 0.1);
    color: white;
    border-radius: 10px;
    font-size: 16px;
    text-align: center;
}

input:focus {
    outline: none;
    box-shadow: 0 0 20px rgba(57, 197, 187, 0.5);
}

button {
    width: 250px;
    padding: 15px;
    margin: 10px 0;
    border: none;
    background: linear-gradient(135deg, #39C5BB, #00BFFF);
    color: white;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 5px 0 #1a8a82;
}

button:active {
    transform: translateY(3px);
    box-shadow: 0 2px 0 #1a8a82;
}

/* HUD */
#hud {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    display: none;
}

.room-code {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid #39C5BB;
    font-size: 18px;
    font-weight: bold;
}

.stats {
    position: absolute;
    top: 10px;
    left: 10px;
}

.bar {
    width: 200px;
    height: 25px;
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #39C5BB;
    border-radius: 15px;
    margin: 5px 0;
    overflow: hidden;
    position: relative;
}

.bar-fill {
    height: 100%;
    transition: width 0.3s;
}

.hp-fill {
    background: linear-gradient(90deg, #E74C3C, #FF6B6B);
}

.xp-fill {
    background: linear-gradient(90deg, #39C5BB, #00D4AA);
}

.bar-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: bold;
}

.inventory {
    position: absolute;
    top: 10px;
    right: 10px;
}

.inv-item {
    background: rgba(0, 0, 0, 0.7);
    padding: 8px 15px;
    margin: 5px 0;
    border-radius: 10px;
    border: 2px solid #39C5BB;
    display: flex;
    align-items: center;
    gap: 10px;
}

.actions {
    position: absolute;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    pointer-events: auto;
}

.action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(57, 197, 187, 0.3);
    border: 3px solid #39C5BB;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
}

/* CRAFT MENU */
#craftMenu {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    padding: 30px;
    border-radius: 20px;
    border: 2px solid #39C5BB;
    z-index: 100;
}

.craft-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.craft-item {
    background: rgba(57, 197, 187, 0.2);
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #39C5BB;
    text-align: center;
    cursor: pointer;
}

/* LEVEL UP */
#levelUp {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    padding: 30px;
    border-radius: 20px;
    border: 2px solid #F1C40F;
    z-index: 100;
}

.upgrades {
    display: flex;
    gap: 15px;
    margin: 20px 0;
}

.upgrade-card {
    background: rgba(241, 196, 15, 0.2);
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #F1C40F;
    cursor: pointer;
    text-align: center;
}

/* DEATH SCREEN */
#death {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

/* MINIMAP */
#minimap {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 150px;
    height: 150px;
    border: 2px solid #39C5BB;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.7);
}

/* WAVE ALERT */
.wave-alert {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    font-weight: bold;
    color: #9B59B6;
    text-shadow: 0 0 30px #9B59B6;
    animation: waveAlert 3s forwards;
    pointer-events: none;
}

@keyframes waveAlert {
    0% { opacity: 0; scale: 0.5; }
    20% { opacity: 1; scale: 1.2; }
    80% { opacity: 1; scale: 1; }
    100% { opacity: 0; }
}

/* ENEMY SPEECH */
.enemy-speech {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    padding: 5px 10px;
    border-radius: 10px;
    border: 2px solid #E74C3C;
    font-size: 12px;
    animation: speech 2s forwards;
    pointer-events: none;
}

@keyframes speech {
    0% { opacity: 0; transform: translateY(10px); }
    20% { opacity: 1; transform: translateY(0); }
    80% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-10px); }
}

canvas {
    display: block;
}
</style>
</head>
<body>

<!-- MENU -->
<div id="menu">
    <div class="logo">‚öîÔ∏è RPG LEGENDS</div>
    <div style="color: #39C5BB; margin-bottom: 20px;">üíô Miku Edition üíô</div>
    
    <div class="menu-box">
        <input type="text" id="playerName" placeholder="Nome do Her√≥i" maxlength="12">
        <button onclick="createRoom()">üåç CRIAR MUNDO</button>
        <div style="text-align: center; margin: 10px 0;">‚Äî OU ‚Äî</div>
        <input type="text" id="roomCodeInput" placeholder="C√≥digo da Sala" maxlength="5" style="text-transform: uppercase;">
        <button onclick="joinRoom()">üö™ ENTRAR</button>
    </div>
</div>

<!-- HUD -->
<div id="hud">
    <div class="room-code">SALA: <span id="roomCodeDisplay">-----</span></div>
    
    <div class="stats">
        <div class="bar">
            <div class="bar-fill hp-fill" id="hpBar" style="width: 100%"></div>
            <div class="bar-text">‚ù§Ô∏è <span id="hpText">100/100</span></div>
        </div>
        <div class="bar">
            <div class="bar-fill xp-fill" id="xpBar" style="width: 0%"></div>
            <div class="bar-text">‚≠ê Lv.<span id="levelText">1</span></div>
        </div>
    </div>
    
    <div class="inventory">
        <div class="inv-item">ü™µ <span id="woodCount">0</span></div>
        <div class="inv-item">ü™® <span id="stoneCount">0</span></div>
        <div class="inv-item">üíé <span id="crystalCount">0</span></div>
        <div class="inv-item">üçñ <span id="foodCount">3</span></div>
    </div>
    
    <div class="actions">
        <div class="action-btn" onclick="openCraft()">üõ†Ô∏è</div>
        <div class="action-btn" onclick="useFood()">üçñ</div>
    </div>
    
    <canvas id="minimap"></canvas>
</div>

<!-- CRAFT MENU -->
<div id="craftMenu" class="hidden">
    <h2 style="text-align: center; color: #39C5BB;">üõ†Ô∏è CONSTRU√á√ÉO</h2>
    <div class="craft-grid">
        <div class="craft-item" onclick="craft('wall')">
            <div>üß± Parede</div>
            <small>ü™µ10</small>
        </div>
        <div class="craft-item" onclick="craft('turret')">
            <div>üî´ Torreta</div>
            <small>ü™µ20 ü™®10 üíé2</small>
        </div>
        <div class="craft-item" onclick="craft('campfire')">
            <div>üî• Fogueira</div>
            <small>ü™µ15 ü™®5</small>
        </div>
        <div class="craft-item" onclick="craft('spikes')">
            <div>üó°Ô∏è Espinhos</div>
            <small>ü™µ5 ü™®5</small>
        </div>
    </div>
    <button onclick="closeCraft()">FECHAR</button>
</div>

<!-- LEVEL UP -->
<div id="levelUp" class="hidden">
    <h2 style="text-align: center; color: #F1C40F;">üéâ LEVEL UP!</h2>
    <div class="upgrades">
        <div class="upgrade-card" onclick="chooseUpgrade('damage')">
            <div>‚öîÔ∏è</div>
            <div>DANO</div>
            <small>+5 Ataque</small>
        </div>
        <div class="upgrade-card" onclick="chooseUpgrade('health')">
            <div>‚ù§Ô∏è</div>
            <div>VIDA</div>
            <small>+30 HP</small>
        </div>
        <div class="upgrade-card" onclick="chooseUpgrade('speed')">
            <div>üí®</div>
            <div>VELOCIDADE</div>
            <small>+2 Speed</small>
        </div>
    </div>
</div>

<!-- DEATH -->
<div id="death" class="hidden">
    <h1 style="color: #E74C3C;">üíÄ VOC√ä MORREU</h1>
    <p>Voc√™ perdeu metade dos recursos...</p>
    <button onclick="respawn()">RENASCER</button>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
// === CONFIGURA√á√ïES ===
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const minimap = document.getElementById('minimap');
const miniCtx = minimap.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
minimap.width = 150;
minimap.height = 150;

// Resize
window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

// === VARI√ÅVEIS GLOBAIS ===
let socket;
let myId;
let roomCode;
let gameState = {
    players: {},
    enemies: [],
    resources: [],
    buildings: [],
    orbs: [],
    wave: 1
};
let player = {
    x: 1200,
    y: 1200,
    hp: 100,
    maxHp: 100,
    level: 1,
    xp: 0,
    nextXp: 100
};
let camera = { x: 0, y: 0 };
let particles = [];
let texts = [];

// Controles
let joystickLeft = { active: false, x: 0, y: 0, dx: 0, dy: 0 };
let joystickRight = { active: false, x: 0, y: 0, angle: 0 };

// === FUN√á√ïES DO MENU ===
function createRoom() {
    const name = document.getElementById('playerName').value || 'Miku';
    socket = io();
    
    socket.on('connect', () => {
        myId = socket.id;
        socket.emit('createRoom', name);
    });
    
    socket.on('roomJoined', (data) => {
        roomCode = data.roomCode;
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        startGame();
    });
    
    setupSocketEvents();
}

function joinRoom() {
    const name = document.getElementById('playerName').value || 'Miku';
    const code = document.getElementById('roomCodeInput').value.toUpperCase();
    
    if(!code) {
        alert('Digite o c√≥digo da sala!');
        return;
    }
    
    socket = io();
    
    socket.on('connect', () => {
        myId = socket.id;
        socket.emit('joinRoom', { code, name });
    });
    
    socket.on('roomJoined', (data) => {
        roomCode = data.roomCode;
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        startGame();
    });
    
    socket.on('error', (msg) => {
        alert(msg);
    });
    
    setupSocketEvents();
}

function startGame() {
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('hud').style.display = 'block';
    gameLoop();
}

// === SOCKET EVENTS ===
function setupSocketEvents() {
    socket.on('gameState', (state) => {
        gameState = state;
        
        // Atualizar player local
        if(gameState.players[myId]) {
            const p = gameState.players[myId];
            player.hp = p.hp;
            player.maxHp = p.maxHp;
            player.level = p.level;
            player.xp = p.xp;
            player.nextXp = p.nextXp;
            
            // Atualizar HUD
            updateHUD(p);
        }
    });
    
    socket.on('levelUp', (level) => {
        document.getElementById('levelUp').classList.remove('hidden');
    });
    
    socket.on('newWave', (wave) => {
        const alert = document.createElement('div');
        alert.className = 'wave-alert';
        alert.textContent = `WAVE ${wave}!`;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    });
    
    socket.on('playerDied', (playerId) => {
        if(playerId === myId) {
            document.getElementById('death').classList.remove('hidden');
        }
    });
    
    socket.on('hitEffect', (data) => {
        particles.push({
            x: data.x,
            y: data.y,
            vx: (Math.random() - 0.5) * 5,
            vy: -Math.random() * 5,
            life: 30,
            color: data.crit ? '#F1C40F' : '#E74C3C'
        });
        
        texts.push({
            x: data.x,
            y: data.y,
            text: data.damage,
            life: 30,
            crit: data.crit
        });
    });
    
    socket.on('enemySpeak', (data) => {
        const speech = document.createElement('div');
        speech.className = 'enemy-speech';
        speech.textContent = data.message;
        speech.style.left = (data.x - camera.x) + 'px';
        speech.style.top = (data.y - camera.y - 50) + 'px';
        document.body.appendChild(speech);
        setTimeout(() => speech.remove(), 2000);
    });
}

// === CONTROLES TOUCH ===
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.clientX < window.innerWidth / 2) {
            // Joystick esquerdo (movimento)
            joystickLeft.active = true;
            joystickLeft.x = touch.clientX;
            joystickLeft.y = touch.clientY;
            joystickLeft.id = touch.identifier;
        } else {
            // Joystick direito (ataque)
            joystickRight.active = true;
            joystickRight.x = touch.clientX;
            joystickRight.y = touch.clientY;
            joystickRight.id = touch.identifier;
        }
    }
});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.identifier === joystickLeft.id) {
            const dx = touch.clientX - joystickLeft.x;
            const dy = touch.clientY - joystickLeft.y;
            const dist = Math.min(Math.hypot(dx, dy), 50);
            const angle = Math.atan2(dy, dx);
            
            joystickLeft.dx = Math.cos(angle) * (dist / 50);
            joystickLeft.dy = Math.sin(angle) * (dist / 50);
        }
        
        if(touch.identifier === joystickRight.id) {
            const dx = touch.clientX - joystickRight.x;
            const dy = touch.clientY - joystickRight.y;
            joystickRight.angle = Math.atan2(dy, dx);
        }
    }
});

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.identifier === joystickLeft.id) {
            joystickLeft.active = false;
            joystickLeft.dx = 0;
            joystickLeft.dy = 0;
        }
        
        if(touch.identifier === joystickRight.id) {
            joystickRight.active = false;
        }
    }
});

// === FUN√á√ïES DO JOGO ===
function updateHUD(p) {
    document.getElementById('hpBar').style.width = (p.hp / p.maxHp * 100) + '%';
    document.getElementById('hpText').textContent = `${p.hp}/${p.maxHp}`;
    document.getElementById('xpBar').style.width = (p.xp / p.nextXp * 100) + '%';
    document.getElementById('levelText').textContent = p.level;
    document.getElementById('woodCount').textContent = p.wood;
    document.getElementById('stoneCount').textContent = p.stone;
    document.getElementById('crystalCount').textContent = p.crystal;
    document.getElementById('foodCount').textContent = p.food;
}

function openCraft() {
    document.getElementById('craftMenu').classList.remove('hidden');
}

function closeCraft() {
    document.getElementById('craftMenu').classList.add('hidden');
}

function craft(type) {
    socket.emit('build', { type });
    closeCraft();
}

function useFood() {
    socket.emit('useFood');
}

function chooseUpgrade(upgrade) {
    socket.emit('chooseUpgrade', upgrade);
    document.getElementById('levelUp').classList.add('hidden');
}

function respawn() {
    socket.emit('respawn');
    document.getElementById('death').classList.add('hidden');
}

// === DESENHO ===
function drawMikuCharacter(x, y, p) {
    ctx.save();
    ctx.translate(x, y);
    
    // Sombra
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(0, 25, 15, 8, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Corpo (vestido)
    ctx.fillStyle = '#1A1A2E';
    ctx.fillRect(-12, -10, 24, 30);
    
    // Gravata
    ctx.fillStyle = '#39C5BB';
    ctx.beginPath();
    ctx.moveTo(0, -5);
    ctx.lineTo(-5, 0);
    ctx.lineTo(0, 5);
    ctx.lineTo(5, 0);
    ctx.closePath();
    ctx.fill();
    
    // Cabe√ßa
    ctx.fillStyle = '#FDB7B2';
    ctx.beginPath();
    ctx.arc(0, -20, 12, 0, Math.PI * 2);
    ctx.fill();
    
    // Cabelo (twintails)
    ctx.fillStyle = '#39C5BB';
    ctx.fillRect(-20, -25, 8, 30);
    ctx.fillRect(12, -25, 8, 30);
    ctx.beginPath();
    ctx.arc(0, -28, 13, Math.PI, 0);
    ctx.fill();
    
    // Olhos
    ctx.fillStyle = '#FFF';
    ctx.beginPath();
    ctx.arc(-5, -20, 3, 0, Math.PI * 2);
    ctx.arc(5, -20, 3, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = '#00BFFF';
    ctx.beginPath();
    ctx.arc(-5, -20, 2, 0, Math.PI * 2);
    ctx.arc(5, -20, 2, 0, Math.PI * 2);
    ctx.fill();
    
    // Nome
    ctx.fillStyle = '#FFF';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(p.name, 0, -40);
    
    ctx.restore();
}

function drawEnemy(e) {
    ctx.save();
    ctx.translate(e.x, e.y);
    
    // Sombra
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(0, 20, 20, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Corpo baseado no tipo
    const colors = {
        slime: '#2ECC71',
        goblin: '#27AE60',
        skeleton: '#ECF0F1',
        ghost: '#9B59B6',
        demon: '#E74C3C'
    };
    
    ctx.fillStyle = colors[e.type] || '#E74C3C';
    ctx.beginPath();
    ctx.arc(0, 0, e.isBoss ? 30 : 20, 0, Math.PI * 2);
    ctx.fill();
    
    // Olhos
    ctx.fillStyle = '#FFF';
    ctx.beginPath();
    ctx.arc(-7, -5, 5, 0, Math.PI * 2);
    ctx.arc(7, -5, 5, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(-7, -5, 2, 0, Math.PI * 2);
    ctx.arc(7, -5, 2, 0, Math.PI * 2);
    ctx.fill();
    
    // HP Bar
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(-30, -40, 60, 8);
    ctx.fillStyle = '#E74C3C';
    ctx.fillRect(-30, -40, 60 * (e.hp / e.maxHp), 8);
    
    ctx.restore();
}

function drawResource(r) {
    ctx.save();
    ctx.translate(r.x, r.y);
    
    if(r.type === 'tree') {
        // Tronco
        ctx.fillStyle = '#6D4C41';
        ctx.fillRect(-10, -10, 20, 30);
        // Copa
        ctx.fillStyle = '#27AE60';
        ctx.beginPath();
        ctx.arc(0, -20, 25, 0, Math.PI * 2);
        ctx.fill();
    } else if(r.type === 'stone') {
        ctx.fillStyle = '#7F8C8D';
        ctx.beginPath();
        ctx.arc(0, 0, 20, 0, Math.PI * 2);
        ctx.fill();
    } else if(r.type === 'crystal') {
        ctx.fillStyle = '#00D4AA';
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#00D4AA';
        ctx.beginPath();
        ctx.moveTo(0, -25);
        ctx.lineTo(-10, 0);
        ctx.lineTo(0, 10);
        ctx.lineTo(10, 0);
        ctx.closePath();
        ctx.fill();
        ctx.shadowBlur = 0;
    }
    
    // HP bar se estiver sendo atacado
    if(r.hp < r.maxHp) {
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(-20, -35, 40, 5);
        ctx.fillStyle = '#2ECC71';
        ctx.fillRect(-20, -35, 40 * (r.hp / r.maxHp), 5);
    }
    
    ctx.restore();
}

function drawOrb(o) {
    ctx.fillStyle = '#00D4AA';
    ctx.shadowBlur = 20;
    ctx.shadowColor = '#00D4AA';
    ctx.beginPath();
    ctx.arc(o.x, o.y, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
}

// === GAME LOOP ===
let lastAttack = 0;

function gameLoop() {
    requestAnimationFrame(gameLoop);
    
    // Limpar canvas
    ctx.fillStyle = '#0a1628';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Movimento do player
    if(joystickLeft.active) {
        player.x += joystickLeft.dx * 5;
        player.y += joystickLeft.dy * 5;
        player.x = Math.max(0, Math.min(2400, player.x));
        player.y = Math.max(0, Math.min(2400, player.y));
    }
    
    // Ataque
    if(joystickRight.active && Date.now() - lastAttack > 200) {
        lastAttack = Date.now();
        if(socket) {
            socket.emit('playerAttack', { angle: joystickRight.angle });
        }
    }
    
    // Enviar posi√ß√£o
    if(socket) {
        socket.emit('playerMove', {
            x: player.x,
            y: player.y,
            state: joystickLeft.active ? 'run' : 'idle',
            angle: joystickRight.angle || 0,
            facing: joystickLeft.dx > 0 ? 1 : -1
        });
    }
    
    // Camera
    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;
    
    ctx.save();
    ctx.translate(-camera.x, -camera.y);
    
    // Grid
    ctx.strokeStyle = 'rgba(57, 197, 187, 0.1)';
    ctx.lineWidth = 1;
    for(let x = 0; x < 2400; x += 100) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 2400);
        ctx.stroke();
    }
    for(let y = 0; y < 2400; y += 100) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(2400, y);
        ctx.stroke();
    }
    
    // Desenhar objetos
    gameState.resources.forEach(r => drawResource(r));
    gameState.orbs.forEach(o => drawOrb(o));
    gameState.enemies.forEach(e => drawEnemy(e));
    
    // Desenhar players
    for(let id in gameState.players) {
        const p = gameState.players[id];
        if(id === myId) {
            drawMikuCharacter(player.x, player.y, p);
        } else {
            drawMikuCharacter(p.x, p.y, p);
        }
    }
    
    // Part√≠culas
    particles = particles.filter(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.3;
        p.life--;
        
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 30;
        ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
        ctx.globalAlpha = 1;
        
        return p.life > 0;
    });
    
    // Textos de dano
    texts = texts.filter(t => {
        t.y -= 2;
        t.life--;
        
        ctx.font = t.crit ? 'bold 24px Arial' : '16px Arial';
        ctx.fillStyle = t.crit ? '#F1C40F' : '#E74C3C';
        ctx.globalAlpha = t.life / 30;
        ctx.fillText(t.text, t.x, t.y);
        ctx.globalAlpha = 1;
        
        return t.life > 0;
    });
    
    ctx.restore();
    
    // Joysticks visuais
    if(joystickLeft.active) {
        ctx.strokeStyle = 'rgba(57, 197, 187, 0.5)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(joystickLeft.x, joystickLeft.y, 50, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.fillStyle = 'rgba(57, 197, 187, 0.8)';
        ctx.beginPath();
        ctx.arc(
            joystickLeft.x + joystickLeft.dx * 50,
            joystickLeft.y + joystickLeft.dy * 50,
            20, 0, Math.PI * 2
        );
        ctx.fill();
    }
    
    if(joystickRight.active) {
        ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(joystickRight.x, joystickRight.y, 50, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.fillStyle = 'rgba(231, 76, 60, 0.8)';
        ctx.beginPath();
        ctx.arc(
            joystickRight.x + Math.cos(joystickRight.angle) * 50,
            joystickRight.y + Math.sin(joystickRight.angle) * 50,
            20, 0, Math.PI * 2
        );
        ctx.fill();
    }
    
    // Minimap
    miniCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    miniCtx.fillRect(0, 0, 150, 150);
    
    // Player no minimap
    miniCtx.fillStyle = '#F1C40F';
    miniCtx.beginPath();
    miniCtx.arc(
        player.x / 2400 * 150,
        player.y / 2400 * 150,
        3, 0, Math.PI * 2
    );
    miniCtx.fill();
    
    // Inimigos no minimap
    gameState.enemies.forEach(e => {
        miniCtx.fillStyle = '#E74C3C';
        miniCtx.beginPath();
        miniCtx.arc(
            e.x / 2400 * 150,
            e.y / 2400 * 150,
            2, 0, Math.PI * 2
        );
        miniCtx.fill();
    });
}
</script>

</body>
</html>
