<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üíô RPG Legends - Miku Edition</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    touch-action: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

:root {
    --primary: #39C5BB;
    --primary-dark: #2A9D96;
    --secondary: #00BFFF;
    --bg-dark: #0a0f1a;
    --bg-medium: #0f172a;
    --bg-light: #1e293b;
    --danger: #E74C3C;
    --success: #2ECC71;
    --gold: #F1C40F;
    --text: #E2E8F0;
    --text-muted: #94A3B8;
}

body {
    background: var(--bg-dark);
    color: var(--text);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    min-height: 100vh;
}

.hidden { display: none !important; }

/* ========== MENU PRINCIPAL ========== */
#menu {
    position: fixed;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1829 50%, var(--bg-dark) 100%);
    z-index: 1000;
}

.menu-background {
    position: absolute;
    inset: 0;
    overflow: hidden;
    opacity: 0.3;
}

.particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: var(--primary);
    border-radius: 50%;
    animation: float 15s infinite linear;
}

@keyframes float {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
}

.menu-content {
    position: relative;
    z-index: 1;
    text-align: center;
}

.logo-container {
    margin-bottom: 2rem;
}

.logo {
    font-size: clamp(2rem, 8vw, 4rem);
    font-weight: 900;
    letter-spacing: 2px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, #00D4AA 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 40px rgba(57, 197, 187, 0.5);
    animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
    from { filter: drop-shadow(0 0 20px rgba(57, 197, 187, 0.5)); }
    to { filter: drop-shadow(0 0 40px rgba(57, 197, 187, 0.8)); }
}

.subtitle {
    font-size: 1.2rem;
    color: var(--primary);
    margin-top: 0.5rem;
    letter-spacing: 4px;
}

.menu-card {
    background: linear-gradient(145deg, var(--bg-light), var(--bg-medium));
    border: 1px solid rgba(57, 197, 187, 0.3);
    border-radius: 20px;
    padding: 2rem;
    width: min(90vw, 400px);
    box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
}

.input-group {
    margin-bottom: 1rem;
}

.input-label {
    display: block;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
    text-align: left;
}

.input-field {
    width: 100%;
    padding: 1rem 1.25rem;
    background: var(--bg-dark);
    border: 2px solid rgba(57, 197, 187, 0.2);
    border-radius: 12px;
    color: var(--text);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.input-field:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(57, 197, 187, 0.1);
}

.input-field::placeholder {
    color: var(--text-muted);
}

.btn {
    width: 100%;
    padding: 1rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(57, 197, 187, 0.4);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(57, 197, 187, 0.5);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-secondary {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-secondary:hover {
    background: rgba(57, 197, 187, 0.1);
}

.divider {
    display: flex;
    align-items: center;
    margin: 1.5rem 0;
    color: var(--text-muted);
    font-size: 0.85rem;
}

.divider::before,
.divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(57, 197, 187, 0.3), transparent);
}

.divider span {
    padding: 0 1rem;
}

.version {
    margin-top: 2rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* ========== HUD ========== */
#hud {
    position: fixed;
    inset: 0;
    pointer-events: none;
    display: none;
    z-index: 100;
}

.hud-top {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    padding: 15px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
}

.room-display {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    padding: 10px 20px;
    border-radius: 25px;
    border: 1px solid var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
}

.room-code {
    font-weight: bold;
    color: var(--primary);
    font-size: 1.1rem;
    letter-spacing: 2px;
}

.wave-display {
    background: linear-gradient(135deg, #9B59B6, #8E44AD);
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
}

.stats-panel {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.stat-bar {
    width: 180px;
    height: 24px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    border: 1px solid rgba(255,255,255,0.1);
}

.stat-fill {
    height: 100%;
    transition: width 0.3s ease;
    position: relative;
}

.stat-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
}

.hp-fill {
    background: linear-gradient(90deg, #C0392B, #E74C3C);
}

.xp-fill {
    background: linear-gradient(90deg, var(--primary-dark), var(--primary));
}

.stat-text {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.inventory-panel {
    display: flex;
    flex-direction: column;
    gap: 5px;
    align-items: flex-end;
}

.inv-item {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    padding: 8px 15px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    min-width: 80px;
    justify-content: space-between;
}

.inv-count {
    font-weight: bold;
    color: var(--gold);
}

/* ========== CONTROLES ========== */
.controls {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
    pointer-events: none;
}

.joystick-zone {
    width: 140px;
    height: 140px;
    pointer-events: auto;
}

.action-buttons {
    position: absolute;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    pointer-events: auto;
}

.action-btn {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 2px solid var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.action-btn:active {
    transform: scale(0.9);
    background: rgba(57, 197, 187, 0.3);
}

/* ========== MINIMAP ========== */
.minimap-container {
    position: absolute;
    bottom: 15px;
    right: 15px;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid var(--primary);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
}

#minimap {
    display: block;
}

/* ========== MODAIS ========== */
.modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 200;
}

.modal-content {
    background: linear-gradient(145deg, var(--bg-light), var(--bg-medium));
    border: 1px solid rgba(57, 197, 187, 0.3);
    border-radius: 20px;
    padding: 2rem;
    width: min(90vw, 450px);
    max-height: 80vh;
    overflow-y: auto;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 1.5rem;
    color: var(--primary);
}

/* ========== CRAFT MENU ========== */
.craft-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 1.5rem;
}

.craft-item {
    background: rgba(0, 0, 0, 0.4);
    border: 2px solid rgba(57, 197, 187, 0.2);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.craft-item:hover {
    border-color: var(--primary);
    background: rgba(57, 197, 187, 0.1);
}

.craft-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.craft-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.craft-name {
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.craft-cost {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* ========== LEVEL UP ========== */
.upgrade-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 1.5rem;
}

.upgrade-card {
    background: linear-gradient(145deg, rgba(241, 196, 15, 0.2), rgba(241, 196, 15, 0.05));
    border: 2px solid var(--gold);
    border-radius: 12px;
    padding: 20px 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.upgrade-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(241, 196, 15, 0.2);
}

.upgrade-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.upgrade-name {
    font-weight: bold;
    color: var(--gold);
    margin-bottom: 0.25rem;
}

.upgrade-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* ========== DEATH SCREEN ========== */
#death .modal-content {
    text-align: center;
    border-color: var(--danger);
}

.death-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.death-title {
    font-size: 2rem;
    color: var(--danger);
    margin-bottom: 1rem;
}

.death-stats {
    background: rgba(0,0,0,0.3);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

/* ========== ALERTAS ========== */
.wave-alert {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: clamp(2rem, 8vw, 4rem);
    font-weight: 900;
    color: #9B59B6;
    text-shadow: 
        0 0 20px #9B59B6,
        0 0 40px #9B59B6,
        0 0 60px #9B59B6;
    animation: waveIn 3s ease-out forwards;
    pointer-events: none;
    z-index: 300;
}

@keyframes waveIn {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    30% { transform: translate(-50%, -50%) scale(1); }
    80% { opacity: 1; }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
}

.enemy-speech {
    position: absolute;
    background: rgba(0, 0, 0, 0.85);
    padding: 6px 12px;
    border-radius: 10px;
    border: 2px solid var(--danger);
    font-size: 0.8rem;
    animation: speechBubble 2.5s ease-out forwards;
    pointer-events: none;
    z-index: 50;
    white-space: nowrap;
}

@keyframes speechBubble {
    0% { opacity: 0; transform: translateY(10px) scale(0.8); }
    15% { opacity: 1; transform: translateY(0) scale(1); }
    85% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-15px); }
}

.damage-text {
    position: absolute;
    font-weight: bold;
    pointer-events: none;
    animation: damageFloat 1s ease-out forwards;
    z-index: 60;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

@keyframes damageFloat {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-50px) scale(0.8); }
}

/* ========== CANVAS ========== */
#game {
    display: block;
    background: var(--bg-dark);
}
</style>
</head>
<body>

<!-- MENU PRINCIPAL -->
<div id="menu">
    <div class="menu-background" id="particles"></div>
    
    <div class="menu-content">
        <div class="logo-container">
            <h1 class="logo">‚öîÔ∏è RPG LEGENDS</h1>
            <p class="subtitle">üíô MIKU EDITION üíô</p>
        </div>
        
        <div class="menu-card">
            <div class="input-group">
                <label class="input-label">NOME DO HER√ìI</label>
                <input type="text" id="playerName" class="input-field" placeholder="Digite seu nome..." maxlength="12">
            </div>
            
            <button class="btn btn-primary" onclick="createRoom()">
                <span>üåç</span>
                <span>CRIAR MUNDO</span>
            </button>
            
            <div class="divider"><span>ou entre em um mundo</span></div>
            
            <div class="input-group">
                <label class="input-label">C√ìDIGO DA SALA</label>
                <input type="text" id="roomCodeInput" class="input-field" placeholder="Ex: ABC12" maxlength="5" style="text-transform: uppercase;">
            </div>
            
            <button class="btn btn-secondary" onclick="joinRoom()">
                <span>üö™</span>
                <span>ENTRAR</span>
            </button>
        </div>
        
        <p class="version">v9.0 ‚Ä¢ Multiplayer Online</p>
    </div>
</div>

<!-- HUD DO JOGO -->
<div id="hud">
    <div class="hud-top">
        <div class="stats-panel">
            <div class="stat-bar">
                <div class="stat-fill hp-fill" id="hpBar"></div>
                <div class="stat-text">‚ù§Ô∏è <span id="hpText">100/100</span></div>
            </div>
            <div class="stat-bar">
                <div class="stat-fill xp-fill" id="xpBar"></div>
                <div class="stat-text">‚≠ê Lv.<span id="levelText">1</span> ‚Ä¢ <span id="xpText">0/80</span></div>
            </div>
        </div>
        
        <div class="room-display">
            <span>üè†</span>
            <span class="room-code" id="roomCodeDisplay">-----</span>
            <span class="wave-display">Wave <span id="waveText">1</span></span>
        </div>
        
        <div class="inventory-panel">
            <div class="inv-item">ü™µ <span class="inv-count" id="woodCount">0</span></div>
            <div class="inv-item">ü™® <span class="inv-count" id="stoneCount">0</span></div>
            <div class="inv-item">üíé <span class="inv-count" id="crystalCount">0</span></div>
            <div class="inv-item">üçñ <span class="inv-count" id="foodCount">5</span></div>
        </div>
    </div>
    
    <div class="action-buttons">
        <div class="action-btn" onclick="openCraft()">üõ†Ô∏è</div>
        <div class="action-btn" onclick="useFood()">üçñ</div>
    </div>
    
    <div class="controls">
        <div class="joystick-zone" id="joystickLeft"></div>
        <div class="joystick-zone" id="joystickRight"></div>
    </div>
    
    <div class="minimap-container">
        <canvas id="minimap" width="130" height="130"></canvas>
    </div>
</div>

<!-- MODAL CRAFT -->
<div id="craftMenu" class="modal hidden">
    <div class="modal-content">
        <h2 class="modal-title">üõ†Ô∏è CONSTRU√á√ÉO</h2>
        
        <div class="craft-grid">
            <div class="craft-item" onclick="craft('wall')">
                <div class="craft-icon">üß±</div>
                <div class="craft-name">Parede</div>
                <div class="craft-cost">ü™µ 8</div>
            </div>
            <div class="craft-item" onclick="craft('spikes')">
                <div class="craft-icon">üó°Ô∏è</div>
                <div class="craft-name">Espinhos</div>
                <div class="craft-cost">ü™µ 5 ü™® 5</div>
            </div>
            <div class="craft-item" onclick="craft('campfire')">
                <div class="craft-icon">üî•</div>
                <div class="craft-name">Fogueira</div>
                <div class="craft-cost">ü™µ 12 ü™® 5</div>
            </div>
            <div class="craft-item" onclick="craft('turret')">
                <div class="craft-icon">üî´</div>
                <div class="craft-name">Torreta</div>
                <div class="craft-cost">ü™µ 15 ü™® 10 üíé 2</div>
            </div>
            <div class="craft-item" onclick="craft('tower')">
                <div class="craft-icon">üóº</div>
                <div class="craft-name">Torre</div>
                <div class="craft-cost">ü™µ 25 ü™® 20 üíé 5</div>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="closeCraft()">FECHAR</button>
    </div>
</div>

<!-- MODAL LEVEL UP -->
<div id="levelUp" class="modal hidden">
    <div class="modal-content">
        <h2 class="modal-title">üéâ LEVEL UP!</h2>
        <p style="text-align: center; margin-bottom: 1rem; color: var(--gold);">N√≠vel <span id="newLevel">2</span> alcan√ßado!</p>
        
        <div class="upgrade-grid">
            <div class="upgrade-card" onclick="chooseUpgrade('damage')">
                <div class="upgrade-icon">‚öîÔ∏è</div>
                <div class="upgrade-name">FOR√áA</div>
                <div class="upgrade-desc">+5 Dano</div>
            </div>
            <div class="upgrade-card" onclick="chooseUpgrade('health')">
                <div class="upgrade-icon">‚ù§Ô∏è</div>
                <div class="upgrade-name">VITALIDADE</div>
                <div class="upgrade-desc">+30 HP</div>
            </div>
            <div class="upgrade-card" onclick="chooseUpgrade('speed')">
                <div class="upgrade-icon">üí®</div>
                <div class="upgrade-name">AGILIDADE</div>
                <div class="upgrade-desc">+1 Velocidade</div>
            </div>
            <div class="upgrade-card" onclick="chooseUpgrade('defense')">
                <div class="upgrade-icon">üõ°Ô∏è</div>
                <div class="upgrade-name">DEFESA</div>
                <div class="upgrade-desc">+3 Defesa</div>
            </div>
            <div class="upgrade-card" onclick="chooseUpgrade('attackSpeed')">
                <div class="upgrade-icon">‚ö°</div>
                <div class="upgrade-name">FRENESI</div>
                <div class="upgrade-desc">Ataque mais r√°pido</div>
            </div>
            <div class="upgrade-card" onclick="chooseUpgrade('lifesteal')">
                <div class="upgrade-icon">üßõ</div>
                <div class="upgrade-name">VAMPIRISMO</div>
                <div class="upgrade-desc">+10% Roubo de vida</div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DEATH -->
<div id="death" class="modal hidden">
    <div class="modal-content">
        <div class="death-icon">üíÄ</div>
        <h2 class="death-title">VOC√ä MORREU!</h2>
        
        <div class="death-stats">
            <p>Voc√™ perdeu metade dos recursos...</p>
            <p style="margin-top: 0.5rem; color: var(--text-muted);">Mas a jornada continua!</p>
        </div>
        
        <button class="btn btn-primary" onclick="respawn()">
            <span>üîÑ</span>
            <span>RENASCER</span>
        </button>
    </div>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
// ========== INICIALIZA√á√ÉO ==========
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const minimap = document.getElementById('minimap');
const miniCtx = minimap.getContext('2d');

// Configura√ß√µes
const CONFIG = {
    MAP_SIZE: 3200,
    BIOME_SIZE: 800
};

// Cores dos biomas
const BIOME_COLORS = {
    forest: '#1a4d1a',
    desert: '#c2a645',
    snow: '#a8c8d8',
    volcano: '#4a1a1a',
    swamp: '#2d4a2d'
};

// Resize
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

// Criar part√≠culas do menu
function createParticles() {
    const container = document.getElementById('particles');
    for(let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 15 + 's';
        particle.style.animationDuration = (10 + Math.random() * 10) + 's';
        container.appendChild(particle);
    }
}
createParticles();

// ========== VARI√ÅVEIS GLOBAIS ==========
let socket = null;
let myId = null;
let roomCode = null;
let isConnected = false;

let gameState = {
    players: {},
    enemies: [],
    resources: [],
    buildings: [],
    orbs: [],
    wave: 1
};

let localPlayer = {
    x: CONFIG.MAP_SIZE / 2,
    y: CONFIG.MAP_SIZE / 2,
    hp: 100,
    maxHp: 100,
    level: 1,
    xp: 0,
    nextXp: 80,
    wood: 0,
    stone: 0,
    crystal: 0,
    food: 5,
    speed: 4,
    damage: 8,
    color: { hair: '#39C5BB', dress: '#1A1A2E', accent: '#00BFFF' }
};

let camera = { x: 0, y: 0 };
let particles = [];
let damageTexts = [];

// Anima√ß√£o
let animFrame = 0;
let lastFrameTime = 0;
const ANIM_SPEED = 150;

// Joysticks
let joystickLeft = { active: false, x: 0, y: 0, dx: 0, dy: 0, id: null };
let joystickRight = { active: false, x: 0, y: 0, angle: 0, id: null };
let isAttacking = false;
let lastAttack = 0;

// ========== FUN√á√ïES DO MENU ==========
function createRoom() {
    const name = document.getElementById('playerName').value.trim() || 'Miku';
    
    console.log('Criando sala...');
    
    socket = io({
        transports: ['websocket', 'polling'],
        upgrade: true
    });
    
    socket.on('connect', () => {
        console.log('Conectado! ID:', socket.id);
        myId = socket.id;
        isConnected = true;
        socket.emit('createRoom', name);
    });
    
    socket.on('connect_error', (err) => {
        console.error('Erro de conex√£o:', err);
        alert('Erro ao conectar ao servidor!');
    });
    
    socket.on('roomJoined', (data) => {
        console.log('Sala criada:', data);
        roomCode = data.roomCode;
        if(data.player) {
            Object.assign(localPlayer, data.player);
        }
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        startGame();
    });
    
    socket.on('error', (msg) => {
        alert(msg);
    });
    
    setupSocketEvents();
}

function joinRoom() {
    const name = document.getElementById('playerName').value.trim() || 'Miku';
    const code = document.getElementById('roomCodeInput').value.toUpperCase().trim();
    
    if(!code) {
        alert('Digite o c√≥digo da sala!');
        return;
    }
    
    console.log('Entrando na sala:', code);
    
    socket = io({
        transports: ['websocket', 'polling'],
        upgrade: true
    });
    
    socket.on('connect', () => {
        console.log('Conectado! ID:', socket.id);
        myId = socket.id;
        isConnected = true;
        socket.emit('joinRoom', { code, name });
    });
    
    socket.on('connect_error', (err) => {
        console.error('Erro de conex√£o:', err);
        alert('Erro ao conectar ao servidor!');
    });
    
    socket.on('roomJoined', (data) => {
        console.log('Entrou na sala:', data);
        roomCode = data.roomCode;
        if(data.player) {
            Object.assign(localPlayer, data.player);
        }
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        startGame();
    });
    
    socket.on('error', (msg) => {
        alert(msg);
    });
    
    setupSocketEvents();
}

function startGame() {
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('hud').style.display = 'block';
    requestAnimationFrame(gameLoop);
}

// ========== SOCKET EVENTS ==========
function setupSocketEvents() {
    socket.on('gameState', (state) => {
        gameState = state;
        
        if(gameState.players[myId]) {
            const p = gameState.players[myId];
            localPlayer.hp = p.hp;
            localPlayer.maxHp = p.maxHp;
            localPlayer.level = p.level;
            localPlayer.xp = p.xp;
            localPlayer.nextXp = p.nextXp;
            localPlayer.wood = p.wood;
            localPlayer.stone = p.stone;
            localPlayer.crystal = p.crystal;
            localPlayer.food = p.food;
            localPlayer.damage = p.damage;
            localPlayer.speed = p.speed;
            localPlayer.color = p.color;
            
            updateHUD();
        }
    });
    
    socket.on('levelUp', (data) => {
        document.getElementById('newLevel').textContent = data.level;
        document.getElementById('levelUp').classList.remove('hidden');
    });
    
    socket.on('newWave', (data) => {
        document.getElementById('waveText').textContent = data.wave;
        
        const alert = document.createElement('div');
        alert.className = 'wave-alert';
        alert.textContent = data.message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    });
    
    socket.on('playerDied', (playerId) => {
        if(playerId === myId) {
            document.getElementById('death').classList.remove('hidden');
        }
    });
    
    socket.on('hitEffect', (data) => {
        // Part√≠culas
        for(let i = 0; i < 8; i++) {
            particles.push({
                x: data.x,
                y: data.y,
                vx: (Math.random() - 0.5) * 8,
                vy: (Math.random() - 0.5) * 8 - 3,
                life: 20,
                color: data.type === 'enemy' ? (data.crit ? '#F1C40F' : '#E74C3C') : '#FF6B6B'
            });
        }
        
        // Texto de dano
        damageTexts.push({
            x: data.x,
            y: data.y,
            text: data.damage,
            life: 60,
            crit: data.crit
        });
    });
    
    socket.on('enemySpeak', (data) => {
        const speech = document.createElement('div');
        speech.className = 'enemy-speech';
        speech.textContent = data.message;
        speech.style.left = (data.x - camera.x) + 'px';
        speech.style.top = (data.y - camera.y - 60) + 'px';
        document.body.appendChild(speech);
        setTimeout(() => speech.remove(), 2500);
    });
    
    socket.on('buildSuccess', (type) => {
        console.log('Constru√ß√£o criada:', type);
    });
    
    socket.on('buildFailed', (msg) => {
        console.log('Falha na constru√ß√£o:', msg);
    });
    
    socket.on('turretShot', (data) => {
        // Linha de tiro
        particles.push({
            type: 'line',
            x1: data.from.x,
            y1: data.from.y,
            x2: data.to.x,
            y2: data.to.y,
            life: 5,
            color: '#00BFFF'
        });
    });
}

// ========== CONTROLES TOUCH ==========
canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });

function handleTouchStart(e) {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        const x = touch.clientX;
        const y = touch.clientY;
        
        if(x < window.innerWidth / 2) {
            joystickLeft.active = true;
            joystickLeft.x = x;
            joystickLeft.y = y;
            joystickLeft.id = touch.identifier;
        } else {
            joystickRight.active = true;
            joystickRight.x = x;
            joystickRight.y = y;
            joystickRight.id = touch.identifier;
            isAttacking = true;
        }
    }
}

function handleTouchMove(e) {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.identifier === joystickLeft.id) {
            const dx = touch.clientX - joystickLeft.x;
            const dy = touch.clientY - joystickLeft.y;
            const dist = Math.min(Math.hypot(dx, dy), 60);
            const angle = Math.atan2(dy, dx);
            
            joystickLeft.dx = Math.cos(angle) * (dist / 60);
            joystickLeft.dy = Math.sin(angle) * (dist / 60);
        }
        
        if(touch.identifier === joystickRight.id) {
            const dx = touch.clientX - joystickRight.x;
            const dy = touch.clientY - joystickRight.y;
            if(Math.hypot(dx, dy) > 10) {
                joystickRight.angle = Math.atan2(dy, dx);
            }
        }
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.identifier === joystickLeft.id) {
            joystickLeft.active = false;
            joystickLeft.dx = 0;
            joystickLeft.dy = 0;
        }
        
        if(touch.identifier === joystickRight.id) {
            joystickRight.active = false;
            isAttacking = false;
        }
    }
}

// Suporte a mouse/teclado para PC
let keys = {};
document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

canvas.addEventListener('mousedown', (e) => {
    if(e.button === 0) {
        isAttacking = true;
        joystickRight.angle = Math.atan2(
            e.clientY - canvas.height / 2,
            e.clientX - canvas.width / 2
        );
    }
});

canvas.addEventListener('mouseup', () => isAttacking = false);

canvas.addEventListener('mousemove', (e) => {
    if(isAttacking) {
        joystickRight.angle = Math.atan2(
            e.clientY - canvas.height / 2,
            e.clientX - canvas.width / 2
        );
    }
});

// ========== FUN√á√ïES DO JOGO ==========
function updateHUD() {
    const hpPercent = (localPlayer.hp / localPlayer.maxHp * 100);
    document.getElementById('hpBar').style.width = hpPercent + '%';
    document.getElementById('hpText').textContent = `${Math.ceil(localPlayer.hp)}/${localPlayer.maxHp}`;
    
    const xpPercent = (localPlayer.xp / localPlayer.nextXp * 100);
    document.getElementById('xpBar').style.width = xpPercent + '%';
    document.getElementById('levelText').textContent = localPlayer.level;
    document.getElementById('xpText').textContent = `${localPlayer.xp}/${localPlayer.nextXp}`;
    
    document.getElementById('woodCount').textContent = localPlayer.wood;
    document.getElementById('stoneCount').textContent = localPlayer.stone;
    document.getElementById('crystalCount').textContent = localPlayer.crystal;
    document.getElementById('foodCount').textContent = localPlayer.food;
}

function openCraft() {
    document.getElementById('craftMenu').classList.remove('hidden');
}

function closeCraft() {
    document.getElementById('craftMenu').classList.add('hidden');
}

function craft(type) {
    if(socket && isConnected) {
        socket.emit('build', { type });
        closeCraft();
    }
}

function useFood() {
    if(socket && isConnected) {
        socket.emit('useFood');
    }
}

function chooseUpgrade(upgrade) {
    if(socket && isConnected) {
        socket.emit('chooseUpgrade', upgrade);
        document.getElementById('levelUp').classList.add('hidden');
    }
}

function respawn() {
    if(socket && isConnected) {
        socket.emit('respawn');
        document.getElementById('death').classList.add('hidden');
    }
}

function getBiomeAt(x, y) {
    const biomeNames = Object.keys(BIOME_COLORS);
    const bx = Math.floor(x / CONFIG.BIOME_SIZE);
    const by = Math.floor(y / CONFIG.BIOME_SIZE);
    const index = Math.abs((bx * 7 + by * 13) % biomeNames.length);
    return biomeNames[index];
}

// ========== DESENHO ==========
function drawBiomeBackground() {
    const startX = Math.floor(camera.x / CONFIG.BIOME_SIZE) * CONFIG.BIOME_SIZE;
    const startY = Math.floor(camera.y / CONFIG.BIOME_SIZE) * CONFIG.BIOME_SIZE;
    
    for(let x = startX - CONFIG.BIOME_SIZE; x < camera.x + canvas.width + CONFIG.BIOME_SIZE; x += CONFIG.BIOME_SIZE) {
        for(let y = startY - CONFIG.BIOME_SIZE; y < camera.y + canvas.height + CONFIG.BIOME_SIZE; y += CONFIG.BIOME_SIZE) {
            const biome = getBiomeAt(x + CONFIG.BIOME_SIZE / 2, y + CONFIG.BIOME_SIZE / 2);
            ctx.fillStyle = BIOME_COLORS[biome];
            ctx.fillRect(x - camera.x, y - camera.y, CONFIG.BIOME_SIZE, CONFIG.BIOME_SIZE);
        }
    }
    
    // Grid sutil
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    
    const gridSize = 100;
    const gridStartX = Math.floor(camera.x / gridSize) * gridSize;
    const gridStartY = Math.floor(camera.y / gridSize) * gridSize;
    
    for(let x = gridStartX; x < camera.x + canvas.width + gridSize; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x - camera.x, 0);
        ctx.lineTo(x - camera.x, canvas.height);
        ctx.stroke();
    }
    
    for(let y = gridStartY; y < camera.y + canvas.height + gridSize; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y - camera.y);
        ctx.lineTo(canvas.width, y - camera.y);
        ctx.stroke();
    }
}

function drawPlayer(x, y, p, isLocal = false) {
    ctx.save();
    ctx.translate(x, y);
    
    const color = p.color || { hair: '#39C5BB', dress: '#1A1A2E', accent: '#00BFFF' };
    const state = p.state || 'idle';
    const facing = p.facing || 1;
    
    // Calcular bounce da anima√ß√£o
    let bounce = 0;
    if(state === 'run' || state === 'walk') {
        bounce = Math.sin(Date.now() / 100) * 3;
    }
    
    ctx.scale(facing, 1);
    
    // Sombra
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(0, 25, 18, 8, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Pernas (animadas)
    ctx.fillStyle = color.accent;
    if(state === 'run') {
        const legAnim = Math.sin(Date.now() / 80);
        ctx.fillRect(-8, 10 + bounce, 6, 15 + legAnim * 3);
        ctx.fillRect(2, 10 + bounce, 6, 15 - legAnim * 3);
    } else {
        ctx.fillRect(-8, 10, 6, 15);
        ctx.fillRect(2, 10, 6, 15);
    }
    
    // Corpo (vestido)
    ctx.fillStyle = color.dress;
    ctx.beginPath();
    ctx.moveTo(-14, 10 + bounce);
    ctx.lineTo(14, 10 + bounce);
    ctx.lineTo(12, -8 + bounce);
    ctx.lineTo(-12, -8 + bounce);
    ctx.closePath();
    ctx.fill();
    
    // Detalhes do vestido
    ctx.strokeStyle = color.accent;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(-10, 0 + bounce);
    ctx.lineTo(10, 0 + bounce);
    ctx.stroke();
    
    // Gravata
    ctx.fillStyle = color.hair;
    ctx.beginPath();
    ctx.moveTo(0, -5 + bounce);
    ctx.lineTo(-4, 0 + bounce);
    ctx.lineTo(0, 8 + bounce);
    ctx.lineTo(4, 0 + bounce);
    ctx.closePath();
    ctx.fill();
    
    // Cabe√ßa
    ctx.fillStyle = '#FDB7B2';
    ctx.beginPath();
    ctx.arc(0, -18 + bounce, 14, 0, Math.PI * 2);
    ctx.fill();
    
    // Cabelo base
    ctx.fillStyle = color.hair;
    ctx.beginPath();
    ctx.arc(0, -22 + bounce, 16, Math.PI, 0);
    ctx.fill();
    
    // Franja
    ctx.beginPath();
    ctx.moveTo(-12, -22 + bounce);
    ctx.quadraticCurveTo(-8, -12 + bounce, -2, -14 + bounce);
    ctx.quadraticCurveTo(0, -20 + bounce, 2, -14 + bounce);
    ctx.quadraticCurveTo(8, -12 + bounce, 12, -22 + bounce);
    ctx.fill();
    
    // Twintails
    ctx.fillRect(-22, -22 + bounce, 10, 45);
    ctx.fillRect(12, -22 + bounce, 10, 45);
    
    // Pontas dos twintails
    ctx.beginPath();
    ctx.arc(-17, 23 + bounce, 5, 0, Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(17, 23 + bounce, 5, 0, Math.PI);
    ctx.fill();
    
    // Olhos
    ctx.fillStyle = '#FFF';
    ctx.beginPath();
    ctx.ellipse(-5, -18 + bounce, 4, 5, 0, 0, Math.PI * 2);
    ctx.ellipse(5, -18 + bounce, 4, 5, 0, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = color.accent;
    ctx.beginPath();
    ctx.arc(-5, -17 + bounce, 3, 0, Math.PI * 2);
    ctx.arc(5, -17 + bounce, 3, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(-5, -17 + bounce, 1.5, 0, Math.PI * 2);
    ctx.arc(5, -17 + bounce, 1.5, 0, Math.PI * 2);
    ctx.fill();
    
    // Brilho nos olhos
    ctx.fillStyle = '#FFF';
    ctx.beginPath();
    ctx.arc(-6, -18 + bounce, 1, 0, Math.PI * 2);
    ctx.arc(4, -18 + bounce, 1, 0, Math.PI * 2);
    ctx.fill();
    
    // Boca
    ctx.strokeStyle = '#E57373';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(0, -12 + bounce, 3, 0.2, Math.PI - 0.2);
    ctx.stroke();
    
    // Nome
    ctx.scale(facing, 1);
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(p.name, 1, -45 + bounce);
    ctx.fillStyle = '#FFF';
    ctx.fillText(p.name, 0, -46 + bounce);
    
    // Barra de HP (para outros jogadores)
    if(!isLocal) {
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(-20, -55, 40, 6);
        ctx.fillStyle = '#E74C3C';
        ctx.fillRect(-20, -55, 40 * (p.hp / p.maxHp), 6);
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.strokeRect(-20, -55, 40, 6);
    }
    
    ctx.restore();
}

function drawEnemy(e) {
    ctx.save();
    ctx.translate(e.x - camera.x, e.y - camera.y);
    
    const size = e.isBoss ? 35 : 22;
    const bounce = Math.sin(Date.now() / 200 + e.x) * 2;
    
    // Sombra
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.beginPath();
    ctx.ellipse(0, size, size * 0.8, size * 0.3, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Corpo
    ctx.fillStyle = e.color || '#E74C3C';
    ctx.beginPath();
    ctx.arc(0, bounce, size, 0, Math.PI * 2);
    ctx.fill();
    
    // Efeito de brilho
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.beginPath();
    ctx.arc(-size * 0.3, -size * 0.3 + bounce, size * 0.4, 0, Math.PI * 2);
    ctx.fill();
    
    // Olhos
    const eyeOffset = e.state === 
