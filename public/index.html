<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Floresta</title>

<style>
* { box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; }
body { margin: 0; background: #051405; overflow: hidden; font-family: 'Courier New', Courier, monospace; }

/* UI */
#ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
.menu { pointer-events: auto; background: rgba(10, 20, 10, 0.95); height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; color: #8fbc8f; }
.menu h1 { font-size: 30px; text-shadow: 0 0 10px #0f0; }
input { padding: 15px; font-size: 20px; text-transform: uppercase; text-align: center; pointer-events: auto; background: #000; border: 2px solid #8fbc8f; color: #fff; border-radius: 8px; }
button { padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; pointer-events: auto; background: #2e8b57; color: #fff; box-shadow: 0 4px 0 #1b5e3a; }
button:active { transform: translateY(4px); box-shadow: none; }

/* HUD */
#hud { display: none; padding: 15px; }
.bar-box { width: 220px; height: 18px; background: #111; border: 2px solid #444; margin-bottom: 8px; border-radius: 4px; overflow: hidden; }
.hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.2s; }
.buff-text { color: #ffff00; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 0 #000; display: none; }

/* CONTROLES */
#attackBtn {
  position: fixed; bottom: 40px; right: 30px;
  width: 90px; height: 90px;
  background: radial-gradient(circle, #ff5f5f, #b71c1c);
  border: 4px solid rgba(255,255,255,0.4);
  border-radius: 50%;
  box-shadow: 0 5px 20px rgba(0,0,0,0.7);
  display: none; pointer-events: auto;
  font-size: 40px; display: flex; align-items: center; justify-content: center;
}
#attackBtn:active { transform: scale(0.95); filter: brightness(1.2); }

canvas { display: block; }
</style>
</head>
<body>

<div id="ui-layer">
  <div id="menu" class="menu">
    <h1>üå≤ FLORESTA M√ÅGICA üå≤</h1>
    <button id="createBtn">CRIAR MUNDO</button>
    <div style="font-size: 12px; opacity: 0.7;">OU ENTRE EM UM</div>
    <input id="roomInput" placeholder="C√ìDIGO DA SALA">
    <button id="joinBtn">ENTRAR</button>
  </div>

  <div id="hud">
    <div class="bar-box"><div id="hpBar" class="hp-fill"></div></div>
    <div id="buffDisplay" class="buff-text">POWER UP ATIVO!</div>
    <div style="color:#aaa; font-size:12px; margin-top:5px;" id="roomDisplay"></div>
  </div>
</div>

<div id="attackBtn" style="display:none">‚öîÔ∏è</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
/* === SINTETIZADOR DE SOM === */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);

  const t = audioCtx.currentTime;
  if (type === 'hit') {
    osc.frequency.setValueAtTime(200, t);
    osc.frequency.exponentialRampToValueAtTime(50, t + 0.1);
    gain.gain.setValueAtTime(0.5, t);
    gain.gain.linearRampToValueAtTime(0, t + 0.1);
    osc.start(); osc.stop(t + 0.1);
  } else if (type === 'coin') { // Som da Carta
    osc.frequency.setValueAtTime(600, t);
    osc.frequency.setValueAtTime(1200, t + 0.1);
    gain.gain.setValueAtTime(0.3, t);
    gain.gain.linearRampToValueAtTime(0, t + 0.3);
    osc.start(); osc.stop(t + 0.3);
  }
}

/* === SETUP === */
const socket = io();
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let myId = null;
let roomId = null;
let camera = { x: 0, y: 0 };
let shake = 0;

// Estado
let players = {};
let enemies = [];
let cards = [];
let particles = [];
let scenery = []; // √Årvores e pedras est√°ticas

// Gera cen√°rio aleat√≥rio (Floresta) uma vez s√≥
function generateScenery() {
    scenery = [];
    for(let i=0; i<300; i++) {
        scenery.push({
            x: Math.random() * 2400,
            y: Math.random() * 2400,
            r: 20 + Math.random() * 40,
            type: Math.random() > 0.8 ? 'stone' : 'tree'
        });
    }
}
generateScenery();

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resize(); window.addEventListener("resize", resize);

/* === REDE === */
socket.on('connect', () => myId = socket.id);

document.getElementById('createBtn').onclick = () => socket.emit('createRoom');
document.getElementById('joinBtn').onclick = () => {
    const code = document.getElementById('roomInput').value.trim().toUpperCase();
    if(code) socket.emit('joinRoom', code);
};

function startGame(id) {
    roomId = id;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('attackBtn').style.display = 'flex';
    document.getElementById('roomDisplay').innerText = "SALA: " + id;
}

socket.on('roomCreated', startGame);
socket.on('joinedRoom', startGame);

socket.on('updateWorld', (data) => {
    players = data.players;
    enemies = data.enemies;
    cards = data.cards;
    
    // Atualiza HUD Local
    if(players[myId]) {
        const p = players[myId];
        document.getElementById('hpBar').style.width = (p.hp / p.maxHp * 100) + "%";
        
        const buffDiv = document.getElementById('buffDisplay');
        if (p.dmgMult > 1) { buffDiv.innerText = "‚öîÔ∏è FOR√áA DOBRADA!"; buffDiv.style.display = "block"; }
        else if (p.speedMult > 1) { buffDiv.innerText = "‚ö° VELOCIDADE!"; buffDiv.style.display = "block"; }
        else { buffDiv.style.display = "none"; }
    }
});

socket.on('cardCollect', (data) => {
    if(data.pid === myId) playSound('coin');
});

socket.on('enemyHit', (data) => {
    if(Math.hypot(data.x - players[myId].x, data.y - players[myId].y) < 600) playSound('hit');
    for(let i=0; i<4; i++) {
        particles.push({
            x: data.x, y: data.y,
            vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8,
            life: 1.0, color: '#fff'
        });
    }
});

/* === CONTROLES === */
const atkBtn = document.getElementById('attackBtn');
atkBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    socket.emit('attack', { roomId });
    if(players[myId]) players[myId].state = 'attack';
    setTimeout(() => { if(players[myId]) players[myId].state = 'idle'; }, 200);
}, { passive: false });

/* === DESENHO (ARTES) === */

function drawCharacter(ctx, x, y, role, state, isMe) {
    // Anima√ß√£o de caminhada
    const time = Date.now() / 150;
    const bounce = state === 'run' ? Math.sin(time) * 3 : 0;
    const handSwing = state === 'run' ? Math.cos(time) * 10 : 0;

    // Sombra
    ctx.fillStyle = "rgba(0,0,0,0.4)";
    ctx.beginPath(); ctx.ellipse(x, y + 20, 15, 8, 0, 0, Math.PI*2); ctx.fill();

    // Corpo
    ctx.fillStyle = role === 'warrior' ? '#3498db' : '#e056fd'; // Azul ou Rosa
    if(role === 'warrior') {
        // Guerreiro (Quadrado arredondado)
        ctx.fillRect(x - 12, y - 15 + bounce, 24, 30);
    } else {
        // Mago (Tri√¢ngulo/Robe)
        ctx.beginPath();
        ctx.moveTo(x, y - 20 + bounce);
        ctx.lineTo(x + 15, y + 15 + bounce);
        ctx.lineTo(x - 15, y + 15 + bounce);
        ctx.fill();
    }

    // Cabe√ßa
    ctx.fillStyle = "#ffccaa"; // Pele
    ctx.beginPath(); ctx.arc(x, y - 20 + bounce, 10, 0, Math.PI*2); ctx.fill();

    // Olhos
    ctx.fillStyle = "#000";
    ctx.fillRect(x - 4, y - 22 + bounce, 3, 3);
    ctx.fillRect(x + 2, y - 22 + bounce, 3, 3);

    // M√£os (Bolinhas)
    ctx.fillStyle = role === 'warrior' ? '#3498db' : '#e056fd';
    if (state === 'attack') {
        // M√£os na frente atacando
        ctx.beginPath(); ctx.arc(x + 20, y + bounce, 6, 0, Math.PI*2); ctx.fill();
    } else {
        ctx.beginPath(); ctx.arc(x - 15, y + handSwing + bounce, 5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + 15, y - handSwing + bounce, 5, 0, Math.PI*2); ctx.fill();
    }

    // Coroa/Chap√©u para identificar (Nome)
    ctx.fillStyle = "#fff";
    ctx.font = "bold 12px monospace";
    ctx.textAlign = "center";
    ctx.fillText(isMe ? "VOC√ä" : role.toUpperCase(), x, y - 35 + bounce);
}

function drawCard(ctx, c) {
    const float = Math.sin(Date.now() / 300) * 5;
    
    // Aura da carta
    ctx.shadowBlur = 15; ctx.shadowColor = c.color;
    
    // Carta Base
    ctx.fillStyle = "#222";
    ctx.strokeStyle = c.color;
    ctx.lineWidth = 2;
    ctx.fillRect(c.x - 12, c.y - 18 + float, 24, 36);
    ctx.strokeRect(c.x - 12, c.y - 18 + float, 24, 36);
    
    // √çcone
    ctx.fillStyle = "#fff";
    ctx.font = "16px Arial";
    ctx.textAlign = "center";
    const icon = c.type === 'HEAL' ? '‚úö' : (c.type === 'DMG' ? '‚öî' : '‚ö°');
    ctx.fillText(icon, c.x, c.y + 5 + float);

    ctx.shadowBlur = 0;
}

/* === LOOP === */
function loop() {
    // 1. Limpa tela
    ctx.fillStyle = "#1a2f1a"; // Verde escuro (ch√£o)
    ctx.fillRect(0,0,canvas.width, canvas.height);

    if (!roomId || !players[myId]) {
        requestAnimationFrame(loop);
        return;
    }

    const me = players[myId];
    
    // 2. Movimento Local + C√¢mera
    if (window.joystick) {
        const speed = 5 * (me.speedMult || 1); // Aplica buff de velocidade
        me.x += window.joystick.dx * speed;
        me.y += window.joystick.dy * speed;
        
        // Limites
        me.x = Math.max(0, Math.min(2400, me.x));
        me.y = Math.max(0, Math.min(2400, me.y));

        socket.emit('move', { 
            roomId, x: me.x, y: me.y, 
            state: (window.joystick.dx || window.joystick.dy) ? 'run' : 'idle' 
        });
    }

    camera.x += (me.x - camera.x - canvas.width/2) * 0.1;
    camera.y += (me.y - camera.y - canvas.height/2) * 0.1;

    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // 3. Desenhar Cen√°rio (√Årvores)
    scenery.forEach(obj => {
        // S√≥ desenha se estiver perto da c√¢mera (Otimiza√ß√£o)
        if (obj.x > camera.x - 100 && obj.x < camera.x + canvas.width + 100 &&
            obj.y > camera.y - 100 && obj.y < camera.y + canvas.height + 100) {
            
            if (obj.type === 'tree') {
                // Tronco
                ctx.fillStyle = "#3e2723";
                ctx.fillRect(obj.x - 5, obj.y, 10, 20);
                // Copa
                ctx.fillStyle = "#2e7d32";
                ctx.beginPath();
                ctx.moveTo(obj.x - obj.r, obj.y);
                ctx.lineTo(obj.x, obj.y - obj.r * 1.5);
                ctx.lineTo(obj.x + obj.r, obj.y);
                ctx.fill();
            } else {
                // Pedra
                ctx.fillStyle = "#5d6d7e";
                ctx.beginPath(); ctx.arc(obj.x, obj.y + 10, obj.r/2, 0, Math.PI*2); ctx.fill();
            }
        }
    });

    // 4. Desenhar Elementos do Jogo
    cards.forEach(c => drawCard(ctx, c));

    enemies.forEach(e => {
        if (e.dead) return;
        ctx.fillStyle = "#c0392b"; // Vermelho escuro
        // Inimigo "Fantasma"
        const bob = Math.sin(Date.now()/200) * 5;
        ctx.beginPath(); 
        ctx.arc(e.x, e.y + bob, 15, Math.PI, 0); 
        ctx.lineTo(e.x, e.y + 20 + bob);
        ctx.fill();
        
        // Olhos
        ctx.fillStyle = "#fff";
        ctx.beginPath(); ctx.arc(e.x - 5, e.y - 5 + bob, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(e.x + 5, e.y - 5 + bob, 3, 0, Math.PI*2); ctx.fill();

        // HP Bar
        ctx.fillStyle = "red"; ctx.fillRect(e.x-15, e.y-25+bob, 30, 4);
        ctx.fillStyle = "#0f0"; ctx.fillRect(e.x-15, e.y-25+bob, 30*(e.hp/e.maxHp), 4);
    });

    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.05;
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
        ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
        if(p.life <= 0) particles.splice(i, 1);
    });

    Object.keys(players).forEach(id => {
        const p = players[id];
        drawCharacter(ctx, p.x, p.y, p.role, p.state, id === myId);
        
        // FADINHA (S√≥ Mago)
        if (p.role === 'mage') {
            const time = Date.now() / 300;
            const fx = p.x + Math.cos(time) * 45;
            const fy = p.y + Math.sin(time) * 45;
            ctx.shadowBlur = 10; ctx.shadowColor = "#fff";
            ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(fx, fy, 4, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "rgba(200,255,255,0.5)"; ctx.beginPath(); ctx.arc(fx, fy, 8, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
        }
    });

    ctx.restore();
    requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
<script src="js/joystick.js"></script>
</body>
</html>

