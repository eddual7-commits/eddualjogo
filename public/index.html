<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Edu & Kamy Arena - V3.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;700&display=swap');

  /* ================= ESTILO GERAL (NEON/DARK) ================= */
  * { box-sizing: border-box; user-select: none; -webkit-touch-callout: none; }
  body {
    margin: 0; background: #050505; overflow: hidden;
    font-family: 'Rajdhani', sans-serif; color: white;
  }

  /* LAYERS */
  canvas { display: block; }
  #game-layer { position: absolute; top: 0; left: 0; z-index: 1; }
  #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
  
  /* TELA DE MENU (FUNDO ESCURO) */
  #menu-layer { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    z-index: 20; background: rgba(5,5,12,0.98); 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    pointer-events: auto; 
  }

  /* ================= MENU DE ENTRADA ================= */
  h1 {
    font-family: 'Press Start 2P', cursive; color: #9fb4ff; font-size: 24px;
    text-shadow: 0 0 20px #5aa9ff; text-align: center; line-height: 1.5; margin-bottom: 20px;
  }
  .class-selector { display: flex; gap: 15px; margin-bottom: 30px; }
  .class-card {
    background: #1a1d2a; border: 2px solid #333; padding: 15px; border-radius: 10px;
    cursor: pointer; transition: 0.3s; text-align: center; width: 110px;
  }
  .class-card:hover, .class-card.selected { border-color: #5aa9ff; box-shadow: 0 0 15px #5aa9ff; transform: scale(1.05); }
  .class-icon { font-size: 35px; display: block; margin-bottom: 10px; }
  
  input.code-input {
    padding: 12px; background: #000; border: 1px solid #555; color: #fff;
    font-family: 'Press Start 2P'; font-size: 12px; text-align: center; margin-bottom: 15px; width: 220px;
  }
  button.start-btn {
    padding: 15px 30px; background: linear-gradient(90deg, #5aa9ff, #2a52be);
    border: none; color: white; font-family: 'Press Start 2P'; font-size: 12px;
    cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
  }
  button.start-btn:active { transform: scale(0.95); }

  /* ================= HUD (VIDA & XP) ================= */
  .hud-top-left { position: absolute; top: 15px; left: 15px; width: 250px; }
  
  /* Barra de Vida */
  .hp-bar-box { width: 100%; height: 20px; background: #222; border: 2px solid #000; transform: skewX(-20deg); overflow: hidden; margin-bottom: 4px; }
  .hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff3333, #aa0000); transition: width 0.2s; }
  .hp-text { font-family: 'Press Start 2P'; font-size: 10px; color: #fff; margin-left: 2px; text-shadow: 1px 1px 0 #000; margin-bottom: 2px; }

  /* Barra de XP */
  .xp-bar-box { width: 80%; height: 8px; background: #111; border: 1px solid #444; transform: skewX(-20deg); overflow: hidden; }
  .xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ffd700, #ffaa00); transition: width 0.5s; }
  .level-badge {
    position: absolute; top: -5px; right: 60px; width: 35px; height: 35px;
    background: #333; border: 2px solid #ffd700; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;
  }

  /* BOT√ÉO ATAQUE */
  #btn-attack {
    pointer-events: auto; position: absolute; bottom: 30px; right: 30px;
    width: 80px; height: 80px; border-radius: 50%;
    background: radial-gradient(circle, #ff5f5f, #c82828);
    border: 4px solid rgba(255,255,255,0.3); box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; font-size: 20px; cursor: pointer;
  }

  /* ================= POPUP DE CARDS (LEVEL UP) ================= */
  #card-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 50; display: none;
    flex-direction: column; align-items: center; justify-content: center;
    pointer-events: auto;
  }
  .cards-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
  .powerup-card {
    width: 120px; height: 180px; background: #1a1d2a; border: 2px solid #ffd700;
    border-radius: 8px; display: flex; flex-direction: column; align-items: center; padding: 10px;
    cursor: pointer; animation: floatCard 3s infinite ease-in-out;
  }
  .powerup-card:active { transform: scale(0.95); background: #2a2e44; }
  @keyframes floatCard { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

  /* FLOATING TEXT */
  .floater { position: absolute; font-weight: bold; font-size: 24px; animation: popUp 0.8s forwards; text-shadow: 2px 2px 0 #000; pointer-events: none; }
  @keyframes popUp { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }

  #version { position: fixed; bottom: 5px; left: 5px; color: #444; font-size: 10px; }
</style>
</head>
<body>

<div id="menu-layer">
  <h1>EDU & KAMY<br>ARENA</h1>
  <div style="color: #666; font-size: 12px; margin-bottom: 20px;">ESCOLHA SEU ESTILO</div>
  
  <div class="class-selector">
    <div class="class-card selected" onclick="selectClass('warrior', this)">
      <span class="class-icon">‚öîÔ∏è</span>
      <div style="font-size:12px;">GUERREIRO</div>
    </div>
    <div class="class-card" onclick="selectClass('mage', this)">
      <span class="class-icon">üîÆ</span>
      <div style="font-size:12px;">MAGO</div>
    </div>
  </div>

  <input id="roomInput" class="code-input" placeholder="NOME DA SALA">
  <button class="start-btn" onclick="joinGame()">ENTRAR NA ARENA</button>
</div>

<div id="card-overlay">
  <h2 style="color: #ffd700; font-family: 'Press Start 2P'; margin-bottom: 30px; font-size: 16px;">LEVEL UP!</h2>
  <div class="cards-container">
    <div class="powerup-card" onclick="pickCard('dmg')">
      <div style="font-size:30px; margin-top:20px;">üí™</div>
      <h3 style="font-size:14px;">FOR√áA</h3>
      <p style="font-size:10px; color:#aaa;">+Dano</p>
    </div>
    <div class="powerup-card" onclick="pickCard('spd')">
      <div style="font-size:30px; margin-top:20px;">‚ö°</div>
      <h3 style="font-size:14px;">AGILIDADE</h3>
      <p style="font-size:10px; color:#aaa;">+Velocidade</p>
    </div>
    <div class="powerup-card" onclick="pickCard('hp')">
      <div style="font-size:30px; margin-top:20px;">‚ù§Ô∏è</div>
      <h3 style="font-size:14px;">VITALIDADE</h3>
      <p style="font-size:10px; color:#aaa;">+Vida Max</p>
    </div>
  </div>
</div>

<div id="ui-layer" style="display: none;">
  <div class="hud-top-left">
    <div class="hp-text" id="hp-text-val">100/100</div>
    <div class="hp-bar-box"><div class="hp-fill" id="hp-fill"></div></div>
    <div class="xp-bar-box"><div class="xp-fill" id="xp-fill"></div></div>
    <div class="level-badge" id="lvl-badge">1</div>
  </div>
  <div id="btn-attack">‚öîÔ∏è</div>
</div>

<canvas id="game-layer"></canvas>
<div id="version">V3.0 - For√ßando Menu</div>

<script src="/socket.io/socket.io.js"></script>
<script src="js/joystick.js" onerror="console.log('Joystick ausente, use WASD')"></script>

<script>
/* ================= ENGINE DO JOGO ================= */
const canvas = document.getElementById("game-layer");
const ctx = canvas.getContext("2d");
let socket;
try { socket = io(); } catch(e) { console.log("Modo Offline"); }

const WORLD_W = 2000;
const WORLD_H = 2000;
let camera = { x: 0, y: 0 };

// Estados
let gameState = 'MENU'; 
let selectedClass = 'warrior';

// Player
let player = {
  x: 1000, y: 1000,
  speed: 6,
  hp: 100, maxHp: 100,
  xp: 0, maxXp: 50, level: 1,
  classType: 'warrior',
  attacking: false,
  sprite: 'ü§†' 
};

// Inimigos
let enemies = [];
function spawnEnemies() {
  enemies = [];
  for(let i=0; i<12; i++) {
    enemies.push({
      x: 500 + Math.random()*1000, 
      y: 500 + Math.random()*1000,
      hp: 30, maxHp: 30, 
      sprite: 'üëæ',
      state: 'IDLE'
    });
  }
}

// Multiplayer (Suaviza√ß√£o)
let otherPlayers = {};

/* ================= L√ìGICA DE MENU ================= */
function selectClass(type, el) {
  selectedClass = type;
  document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

function joinGame() {
  const room = document.getElementById('roomInput').value || "sala1";
  
  // Configura Player
  player.classType = selectedClass;
  player.sprite = selectedClass === 'warrior' ? '‚öîÔ∏è' : 'üßô‚Äç‚ôÇÔ∏è';
  player.maxHp = selectedClass === 'warrior' ? 120 : 80;
  player.hp = player.maxHp;
  player.speed = selectedClass === 'warrior' ? 6 : 7;

  // Esconde Menu, Mostra Jogo
  document.getElementById('menu-layer').style.display = 'none';
  document.getElementById('ui-layer').style.display = 'block';
  
  gameState = 'PLAYING';
  spawnEnemies();
  
  if(socket) socket.emit('joinRoom', room);
  
  resize();
  loop();
}

/* ================= CONTROLES & COMBATE ================= */
const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;
const atkBtn = document.getElementById('btn-attack');

function doAttack() {
  if(player.attacking) return;
  player.attacking = true;
  
  // Feedback Visual Bot√£o
  atkBtn.style.transform = "scale(0.8)";
  setTimeout(() => {
    player.attacking = false;
    atkBtn.style.transform = "scale(1)";
  }, 300);

  // Hitbox Local
  const range = player.classType === 'warrior' ? 90 : 250;
  
  enemies.forEach(e => {
    if(e.hp <= 0) return;
    const dist = Math.hypot(e.x - player.x, e.y - player.y);
    
    if(dist < range) {
      const dmg = Math.floor(Math.random() * 10) + 10;
      e.hp -= dmg;
      spawnFloater(e.x, e.y, dmg, '#fff');
      
      // Empurr√£o
      const dx = e.x - player.x; const dy = e.y - player.y;
      e.x += (dx/dist) * 40; e.y += (dy/dist) * 40;
      
      if(e.hp <= 0) giveXp(20);
    }
  });
  
  if(socket) socket.emit('attack', { x: player.x, y: player.y });
}

atkBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); doAttack(); });
atkBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); doAttack(); });
window.addEventListener('keydown', e => { if(e.code === 'Space') doAttack(); });

/* ================= XP E LEVEL UP ================= */
function giveXp(amount) {
  player.xp += amount;
  if(player.xp >= player.maxXp) {
    player.xp = 0;
    player.maxXp = Math.floor(player.maxXp * 1.5);
    player.level++;
    spawnFloater(player.x, player.y - 50, "LEVEL UP!", "#ffd700");
    showCards();
  }
  updateHud();
}

function showCards() {
  document.getElementById('card-overlay').style.display = 'flex';
  gameState = 'PAUSED';
}

function pickCard(type) {
  if(type === 'dmg') alert("Voc√™ se sente mais forte!");
  if(type === 'hp') { player.maxHp += 30; player.hp += 30; }
  if(type === 'spd') { player.speed += 1; }
  
  document.getElementById('card-overlay').style.display = 'none';
  gameState = 'PLAYING';
  updateHud();
}

function updateHud() {
  const hpPct = (player.hp / player.maxHp) * 100;
  const xpPct = (player.xp / player.maxXp) * 100;
  document.getElementById('hp-fill').style.width = hpPct + '%';
  document.getElementById('hp-text-val').innerText = `${Math.floor(player.hp)}/${player.maxHp}`;
  document.getElementById('xp-fill').style.width = xpPct + '%';
  document.getElementById('lvl-badge').innerText = player.level;
}

/* ================= LOOP GR√ÅFICO ================= */
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);

// Floating Text
function spawnFloater(x, y, text, color) {
  const el = document.createElement('div');
  el.className = 'floater'; el.innerText = text; el.style.color = color;
  el.style.left = (x - camera.x + canvas.width/2) + 'px';
  el.style.top = (y - camera.y + canvas.height/2) + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

function drawGrid() {
  const size = 100;
  const sx = Math.floor(camera.x / size) * size;
  const sy = Math.floor(camera.y / size) * size;
  ctx.strokeStyle = '#111'; ctx.lineWidth = 2;
  for(let x=sx; x<camera.x+canvas.width; x+=size) {
    ctx.beginPath(); ctx.moveTo(x, camera.y); ctx.lineTo(x, camera.y+canvas.height); ctx.stroke();
  }
  for(let y=sy; y<camera.y+canvas.height; y+=size) {
    ctx.beginPath(); ctx.moveTo(camera.x, y); ctx.lineTo(camera.x+canvas.width, y); ctx.stroke();
  }
}

function loop() {
  if(gameState !== 'PLAYING') {
    requestAnimationFrame(loop);
    return;
  }

  // 1. Inputs de Movimento
  let dx = 0, dy = 0;
  if (window.joystick && window.joystick.active) {
    dx = window.joystick.dx; dy = window.joystick.dy;
  }
  if (keys['w']) dy = -1; if (keys['s']) dy = 1;
  if (keys['a']) dx = -1; if (keys['d']) dx = 1;

  if (dx || dy) {
    const len = Math.hypot(dx, dy);
    player.x += (dx/len) * player.speed;
    player.y += (dy/len) * player.speed;
    if(socket) socket.emit('move', { x: player.x, y: player.y });
  }

  // 2. Camera e Limites
  player.x = Math.max(0, Math.min(WORLD_W, player.x));
  player.y = Math.max(0, Math.min(WORLD_H, player.y));
  camera.x += (player.x - camera.x - canvas.width/2) * 0.1;
  camera.y += (player.y - camera.y - canvas.height/2) * 0.1;

  // 3. Render
  ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.save();
  ctx.translate(-camera.x, -camera.y);
  drawGrid();

  // Inimigos
  enemies.forEach(e => {
    if(e.hp <= 0) return;
    
    // IA Simples
    const dist = Math.hypot(player.x - e.x, player.y - e.y);
    if(dist < 400 && dist > 35) {
      e.x += ((player.x - e.x)/dist) * 2;
      e.y += ((player.y - e.y)/dist) * 2;
    } else if(dist <= 35) {
      // Dano no player
      if(Math.random() < 0.05) {
         player.hp -= 1; 
         updateHud();
         spawnFloater(player.x, player.y, "-1", "red");
         if(player.hp <= 0) location.reload();
      }
    }

    // Desenho
    ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(e.sprite, e.x, e.y);
    // Vida Inimigo
    ctx.fillStyle = 'red'; ctx.fillRect(e.x-15, e.y-25, 30, 4);
    ctx.fillStyle = '#0f0'; ctx.fillRect(e.x-15, e.y-25, 30 * (e.hp/e.maxHp), 4);
  });

  // Outros Jogadores
  for(let id in otherPlayers) {
    let p = otherPlayers[id];
    ctx.font = "30px Arial"; ctx.fillText("üë§", p.x, p.y);
  }

  // Player Local
  // Efeito de Ataque
  if(player.attacking) {
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(Date.now() / 50);
    ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
    ctx.beginPath(); ctx.arc(0, 0, 70, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  ctx.font = "40px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
  ctx.fillText(player.sprite, player.x, player.y);
  ctx.fillStyle = "white"; ctx.font = "10px 'Press Start 2P'";
  ctx.fillText("VOC√ä", player.x, player.y - 35);

  ctx.restore();

  // Recebe dados Socket
  if(socket) {
    socket.on('updatePlayers', data => {
       for(let id in data) if(id !== socket.id) otherPlayers[id] = data[id];
    });
  }

  requestAnimationFrame(loop);
}
</script>
</body>
</html>

