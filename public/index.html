<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>coop base</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #0b0d14;
  touch-action: none;
  font-family: Arial, sans-serif;
}

#ui {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10;
  display: flex;
  gap: 6px;
}

#ui input, #ui button {
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  background: #1f2233;
  color: #fff;
}

#joystick {
  position: fixed;
  left: 20px;
  bottom: 30px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.08);
}

#stick {
  position: absolute;
  left: 40px;
  top: 40px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.4);
}

canvas {
  display: block;
}
</style>
</head>

<body>

<div id="ui">
  <button onclick="createRoom()">Criar</button>
  <input id="roomInput" placeholder="sala" />
  <button onclick="joinRoom()">Entrar</button>
</div>

<canvas id="game"></canvas>

<div id="joystick">
  <div id="stick"></div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
/* ===== CANVAS FULLSCREEN ===== */
const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")

function resize() {
  const dpr = window.devicePixelRatio || 1
  canvas.style.width = innerWidth + "px"
  canvas.style.height = innerHeight + "px"
  canvas.width = innerWidth * dpr
  canvas.height = innerHeight * dpr
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0)
}
addEventListener("resize", resize)
resize()

/* ===== SOCKET ===== */
const socket = io()
let myId = null
let roomId = null
let players = {}

socket.on("connect", () => {
  myId = socket.id
})

socket.on("roomCreated", id => {
  roomId = id
  document.getElementById("roomInput").value = id
})

socket.on("updatePlayers", data => {
  players = data
})

function createRoom() {
  socket.emit("createRoom")
}

function joinRoom() {
  const id = document.getElementById("roomInput").value.trim()
  if (id) {
    roomId = id
    socket.emit("joinRoom", id)
  }
}

/* ===== JOYSTICK ===== */
const joy = { dx: 0, dy: 0 }
const joyEl = document.getElementById("joystick")
const stick = document.getElementById("stick")

let active = false

joyEl.addEventListener("pointerdown", e => {
  active = true
})

addEventListener("pointerup", () => {
  active = false
  joy.dx = joy.dy = 0
  stick.style.left = "40px"
  stick.style.top = "40px"
})

addEventListener("pointermove", e => {
  if (!active) return

  const r = joyEl.getBoundingClientRect()
  const cx = r.left + 60
  const cy = r.top + 60

  let dx = e.clientX - cx
  let dy = e.clientY - cy

  const dist = Math.hypot(dx, dy)
  if (dist > 40) {
    dx *= 40 / dist
    dy *= 40 / dist
  }

  joy.dx = dx / 40
  joy.dy = dy / 40

  stick.style.left = 40 + dx + "px"
  stick.style.top = 40 + dy + "px"
})

/* ===== GAME LOOP ===== */
const WORLD = { w: 2000, h: 2000 }
const camera = { x: 0, y: 0 }

function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height)

  const me = players[myId]
  if (me) {
    camera.x = me.x - canvas.width / 2
    camera.y = me.y - canvas.height / 2

    if (roomId) {
      socket.emit("move", {
        roomId,
        x: me.x + joy.dx * 5,
        y: me.y + joy.dy * 5
      })
    }
  }

  /* fundo simples */
  ctx.fillStyle = "#0b0d14"
  ctx.fillRect(-camera.x, -camera.y, WORLD.w, WORLD.h)

  /* players */
  for (const id in players) {
    const p = players[id]
    ctx.fillStyle = id === myId ? "#4da6ff" : "#6f6"
    ctx.beginPath()
    ctx.arc(p.x - camera.x, p.y - camera.y, 16, 0, Math.PI * 2)
    ctx.fill()
  }

  requestAnimationFrame(loop)
}

loop()
</script>
</body>
</html>
