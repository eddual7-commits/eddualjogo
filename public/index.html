<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>coop survival</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  background: #0b0b0b;
  overflow: hidden;
  font-family: sans-serif;
}

#menu {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  background: rgba(0,0,0,0.6);
  padding: 8px 12px;
  border-radius: 8px;
}

#menu button, #menu input {
  margin: 4px;
}

canvas {
  display: block;
}
</style>
</head>
<body>

<div id="menu">
  <button onclick="createRoom()">Criar sala</button>
  <input id="roomInput" placeholder="Sala" />
  <button onclick="joinRoom()">Entrar</button>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io()
const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")

function resize() {
  canvas.width = window.innerWidth
  canvas.height = window.innerHeight
}
resize()
window.addEventListener("resize", resize)

let roomId = null
let players = {}

const me = { x: 200, y: 200, vx: 0, vy: 0 }

// =====================
// JOYSTICK BRAWL STYLE
// =====================
let joystick = {
  active: false,
  id: null,
  startX: 0,
  startY: 0,
  x: 0,
  y: 0
}

canvas.addEventListener("touchstart", e => {
  const t = e.changedTouches[0]
  joystick.active = true
  joystick.id = t.identifier
  joystick.startX = t.clientX
  joystick.startY = t.clientY
})

canvas.addEventListener("touchmove", e => {
  for (const t of e.changedTouches) {
    if (t.identifier === joystick.id) {
      joystick.x = t.clientX
      joystick.y = t.clientY
    }
  }
})

canvas.addEventListener("touchend", e => {
  joystick.active = false
  me.vx = me.vy = 0
})

// =====================
// SALAS
// =====================
function createRoom() {
  socket.emit("createRoom")
}

function joinRoom() {
  roomId = document.getElementById("roomInput").value
  socket.emit("joinRoom", roomId)
  document.getElementById("menu").style.display = "none"
}

socket.on("roomCreated", id => {
  roomId = id
  document.getElementById("roomInput").value = id
})

socket.on("updatePlayers", p => players = p)

// =====================
// UPDATE
// =====================
function update() {
  if (!roomId) return

  if (joystick.active) {
    const dx = joystick.x - joystick.startX
    const dy = joystick.y - joystick.startY
    const dist = Math.min(Math.hypot(dx, dy), 60)
    const angle = Math.atan2(dy, dx)

    me.vx = Math.cos(angle) * (dist / 8)
    me.vy = Math.sin(angle) * (dist / 8)
  }

  me.x += me.vx
  me.y += me.vy

  socket.emit("move", {
    roomId,
    x: me.x,
    y: me.y
  })
}

// =====================
// DRAW
// =====================
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height)

  for (const id in players) {
    const p = players[id]
    ctx.fillStyle = id === socket.id ? "#4af" : "#fa4"
    ctx.beginPath()
    ctx.arc(p.x, p.y, 18, 0, Math.PI*2)
    ctx.fill()
  }

  if (joystick.active) {
    ctx.strokeStyle = "rgba(255,255,255,0.25)"
    ctx.lineWidth = 2
    ctx.beginPath()
    ctx.arc(joystick.startX, joystick.startY, 40, 0, Math.PI*2)
    ctx.stroke()

    ctx.fillStyle = "rgba(255,255,255,0.35)"
    ctx.beginPath()
    ctx.arc(joystick.x, joystick.y, 20, 0, Math.PI*2)
    ctx.fill()
  }
}

// =====================
function loop() {
  update()
  draw()
  requestAnimationFrame(loop)
}
loop()
</script>

</body>
</html>}
loop()
</script>

</body>
</html>
<div id="menu" style="
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  text-align: center;
">
  <button onclick="createRoom()">Criar sala</button>
  <input id="roomInput" placeholder="Sala" />
  <button onclick="joinRoom()">Entrar</button>
</div>
