<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üßü Zombie Survival - Terraria Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
        }
        
        /* ==================== MENU ==================== */
        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #1a0a2e 0%, #0d0d0d 50%, #1a0505 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .menu-hidden {
            display: none !important;
        }
        
        #menu h1 {
            font-size: 4em;
            color: #00ff44;
            text-shadow: 0 0 20px #00ff4488, 0 0 40px #00ff4444, 0 4px 0 #005500;
            margin-bottom: 10px;
            letter-spacing: 3px;
            animation: titlePulse 2s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        #menu h2 {
            font-size: 1.5em;
            color: #ff4444;
            text-shadow: 0 0 10px #ff000088;
            margin-bottom: 40px;
            font-style: italic;
        }
        
        .menu-container {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #333;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 255, 68, 0.2);
        }
        
        .menu-section {
            margin-bottom: 25px;
        }
        
        .menu-section label {
            display: block;
            color: #aaa;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .menu-section input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1.1em;
            outline: none;
            transition: all 0.3s;
        }
        
        .menu-section input[type="text"]:focus {
            border-color: #00ff44;
            box-shadow: 0 0 15px rgba(0, 255, 68, 0.3);
        }
        
        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option:hover {
            transform: scale(1.15);
        }
        
        .color-option.selected {
            border-color: #fff;
            box-shadow: 0 0 15px currentColor;
        }
        
        .btn {
            width: 100%;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(180deg, #00ff44 0%, #00aa22 100%);
            color: #000;
            box-shadow: 0 5px 20px rgba(0, 255, 68, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 255, 68, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(180deg, #444 0%, #222 100%);
            color: #fff;
        }
        
        .server-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .server-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .server-item:hover {
            background: #252525;
            border-color: #00ff44;
        }
        
        .server-item.selected {
            border-color: #00ff44;
            box-shadow: 0 0 10px rgba(0, 255, 68, 0.3);
        }
        
        .server-info h3 {
            color: #fff;
            margin-bottom: 4px;
        }
        
        .server-info span {
            color: #888;
            font-size: 0.85em;
        }
        
        .server-players {
            color: #00ff44;
            font-weight: bold;
        }
        
        /* ==================== LOADING ==================== */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .loading-hidden {
            display: none !important;
        }
        
        .loading-bar-container {
            width: 300px;
            height: 20px;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00ff44, #00aa22);
            transition: width 0.3s;
        }
        
        .loading-text {
            color: #888;
            margin-top: 15px;
        }
        
        /* ==================== GAME ==================== */
        #gameContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* ==================== HUD ==================== */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        #hud > * {
            pointer-events: auto;
        }
        
        .top-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .stat-bar {
            width: 200px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .stat-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .health-bar .stat-bar-fill {
            background: linear-gradient(180deg, #ff4444 0%, #aa0000 100%);
        }
        
        .xp-bar {
            width: 150px;
            height: 18px;
        }
        
        .xp-bar .stat-bar-fill {
            background: linear-gradient(180deg, #44ff44 0%, #00aa00 100%);
        }
        
        .stat-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }
        
        .wave-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #333;
        }
        
        .wave-number {
            color: #ff4444;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .wave-timer {
            color: #aaa;
            font-size: 0.9em;
        }
        
        .time-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-icon {
            font-size: 1.5em;
        }
        
        .hotbar {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 10px;
            border: 2px solid #333;
        }
        
        .hotbar-slot {
            width: 50px;
            height: 50px;
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .hotbar-slot.selected {
            border-color: #00ff44;
            box-shadow: 0 0 15px rgba(0, 255, 68, 0.5);
            transform: translateY(-3px);
        }
        
        .hotbar-slot:hover {
            border-color: #666;
        }
        
        .hotbar-slot .item-icon {
            font-size: 24px;
        }
        
        .hotbar-slot .item-count {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 11px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            font-weight: bold;
        }
        
        .hotbar-slot .slot-number {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 10px;
            color: #666;
        }
        
        .minimap {
            position: absolute;
            bottom: 80px;
            right: 10px;
            width: 150px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .minimap canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }
        
        .chat-container {
            position: absolute;
            bottom: 80px;
            left: 10px;
            width: 300px;
        }
        
        .chat-messages {
            height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px 10px 0 0;
            padding: 10px;
        }
        
        .chat-message {
            margin-bottom: 5px;
            font-size: 13px;
            word-wrap: break-word;
        }
        
        .chat-message .name {
            font-weight: bold;
        }
        
        .chat-message .text {
            color: #ddd;
        }
        
        .chat-input-container {
            display: flex;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            border-radius: 0 0 0 10px;
            color: #fff;
            outline: none;
        }
        
        .chat-send {
            padding: 10px 15px;
            background: #00ff44;
            color: #000;
            border: none;
            border-radius: 0 0 10px 0;
            cursor: pointer;
            font-weight: bold;
        }
                /* ==================== MOBILE CONTROLS ==================== */
        .mobile-controls {
            display: none;
        }
        
        @media (max-width: 768px), (pointer: coarse) {
            .mobile-controls {
                display: block;
            }
            
            .chat-container {
                width: 200px;
                opacity: 0.7;
            }
            
            .minimap {
                width: 100px;
                height: 70px;
            }
        }
        
        .joystick-container {
            position: absolute;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }
        
        .joystick-left {
            bottom: 20px;
            left: 20px;
        }
        
        .joystick-right {
            bottom: 20px;
            right: 20px;
        }
        
        .joystick-knob {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: none;
        }
        
        .mobile-btn {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fff;
        }
        
        .jump-btn {
            bottom: 150px;
            left: 140px;
        }
        
        .attack-btn {
            bottom: 150px;
            right: 140px;
        }
        
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 2px 2px 2px #000;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 200;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1.5);
            }
        }
        
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            z-index: 300;
            animation: notifyIn 0.3s ease-out;
        }
        
        @keyframes notifyIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .notification.wave {
            border: 2px solid #ff4444;
            color: #ff4444;
        }
        
        .notification.boss {
            border: 2px solid #ff00ff;
            color: #ff00ff;
            font-size: 1.5em;
        }
        
        .notification.level {
            border: 2px solid #44ff44;
            color: #44ff44;
        }
    </style>
</head>
<body>
    <!-- MENU -->
    <div id="menu">
        <h1>üßü ZOMBIE SURVIVAL</h1>
        <h2>‚õèÔ∏è Terraria Style Edition</h2>
        
        <div class="menu-container">
            <div class="menu-section">
                <label>üë§ Seu Nome</label>
                <input type="text" id="playerName" placeholder="Digite seu nome..." maxlength="20" value="">
            </div>
            
            <div class="menu-section">
                <label>üé® Cor do Personagem</label>
                <div class="color-picker" id="colorPicker">
                    <div class="color-option selected" style="background: #00ff44" data-color="#00ff44"></div>
                    <div class="color-option" style="background: #ff4444" data-color="#ff4444"></div>
                    <div class="color-option" style="background: #4444ff" data-color="#4444ff"></div>
                    <div class="color-option" style="background: #ffff44" data-color="#ffff44"></div>
                    <div class="color-option" style="background: #ff44ff" data-color="#ff44ff"></div>
                    <div class="color-option" style="background: #44ffff" data-color="#44ffff"></div>
                    <div class="color-option" style="background: #ff8800" data-color="#ff8800"></div>
                    <div class="color-option" style="background: #ffffff" data-color="#ffffff"></div>
                </div>
            </div>
            
            <div class="menu-section">
                <label>üåê Servidores Dispon√≠veis</label>
                <div class="server-list" id="serverList">
                    <div class="server-item selected" data-server="main">
                        <div class="server-info">
                            <h3>Servidor Principal</h3>
                            <span>Wave 1</span>
                        </div>
                        <div class="server-players">0/10</div>
                    </div>
                </div>
                <button class="btn btn-secondary" id="refreshServers">üîÑ Atualizar Lista</button>
            </div>
            
            <button class="btn btn-primary" id="playBtn">‚öîÔ∏è JOGAR</button>
        </div>
    </div>
    
    <!-- LOADING -->
    <div id="loading" class="loading-hidden">
        <h1 style="color: #00ff44; margin-bottom: 20px;">üßü ZOMBIE SURVIVAL</h1>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        <div class="loading-text" id="loadingText">Gerando mundo...</div>
    </div>
    
    <!-- GAME -->
    <div id="gameContainer" style="display: none;">
        <canvas id="gameCanvas"></canvas>
        
        <!-- HUD -->
        <div id="hud">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="stat-bar health-bar">
                    <div class="stat-bar-fill" id="healthFill" style="width: 100%"></div>
                    <div class="stat-bar-text" id="healthText">100/100</div>
                </div>
                <div class="stat-bar xp-bar">
                    <div class="stat-bar-fill" id="xpFill" style="width: 0%"></div>
                    <div class="stat-bar-text" id="levelText">Lv.1</div>
                </div>
            </div>
            
            <!-- Time Indicator -->
            <div class="time-indicator">
                <span class="time-icon" id="timeIcon">‚òÄÔ∏è</span>
                <span id="timeText">Dia</span>
            </div>
            
            <!-- Wave Info -->
            <div class="wave-info">
                <div class="wave-number">Wave <span id="waveNumber">1</span></div>
                <div class="wave-timer">Pr√≥xima: <span id="waveTimer">90</span>s</div>
            </div>
            
            <!-- Hotbar -->
            <div class="hotbar" id="hotbar"></div>
            
            <!-- Minimap -->
            <div class="minimap">
                <canvas id="minimapCanvas"></canvas>
            </div>
            
            <!-- Chat -->
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Pressione Enter para chat..." maxlength="200">
                    <button class="chat-send" id="chatSend">‚û§</button>
                </div>
            </div>
            
            <!-- Mobile Controls -->
            <div class="mobile-controls">
                <div class="joystick-container joystick-left" id="joystickLeft">
                    <div class="joystick-knob" id="knobLeft"></div>
                </div>
                <div class="joystick-container joystick-right" id="joystickRight">
                    <div class="joystick-knob" id="knobRight"></div>
                </div>
                <div class="mobile-btn jump-btn" id="jumpBtn">‚¨ÜÔ∏è</div>
                <div class="mobile-btn attack-btn" id="attackBtn">‚öîÔ∏è</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ==================== CONFIG ====================
const CONFIG = {
    TILE_SIZE: 16,
    RENDER_DISTANCE: 50,
    SHOW_FPS: true
};

// ==================== GAME STATE ====================
const Game = {
    socket: null,
    canvas: null,
    ctx: null,
    minimapCanvas: null,
    minimapCtx: null,
    
    connected: false,
    playing: false,
    playerId: null,
    
    world: null,
    players: new Map(),
    zombies: new Map(),
    projectiles: new Map(),
    items: new Map(),
    particles: [],
    
    player: null,
    camera: { x: 0, y: 0, shakeX: 0, shakeY: 0 },
    
    keys: {},
    mouse: { x: 0, y: 0, down: false },
    joystick: { left: { x: 0, y: 0 }, right: { x: 0, y: 0 } },
    
    dayTime: 0.3,
    wave: 1,
    waveTimer: 90,
    
    selectedSlot: 0,
    chatOpen: false,
    
    fps: 0,
    frameCount: 0,
    lastFpsUpdate: 0,
    lastUpdate: 0,
    damageFlash: 0
};

// ==================== TILE COLORS ====================
const TILE_COLORS = {
    0: null, // AIR
    1: ['#8B5A2B', '#7A4F26'], // DIRT
    2: ['#228B22', '#1E7B1E'], // GRASS
    3: ['#808080', '#707070'], // STONE
    4: ['#8B4513', '#7A3C10'], // WOOD
    5: ['#228B22', '#1E7B1E'], // LEAVES
    6: ['#2F2F2F', '#252525'], // COAL
    7: ['#C19A6B', '#B08A5B'], // IRON
    8: ['#FFD700', '#E6C200'], // GOLD
    9: ['#00FFFF', '#00E5E5'], // DIAMOND
    10: ['#F4D03F', '#E5C135'], // SAND
    13: ['#696969', '#5F5F5F'], // COBBLESTONE
    14: ['#DEB887', '#CFA877'], // PLANKS
    15: ['#FFA500', '#FF8C00'], // TORCH
    19: ['#1A1A1A', '#0F0F0F'], // BEDROCK
    20: ['#B87333', '#A66329'], // COPPER
    21: ['#C0C0C0', '#B0B0B0'], // SILVER
    25: ['#8B4513', '#7A3C10'] // PLATFORM
};

// ==================== INIT ====================
function init() {
    Game.canvas = document.getElementById('gameCanvas');
    Game.ctx = Game.canvas.getContext('2d');
    Game.minimapCanvas = document.getElementById('minimapCanvas');
    Game.minimapCtx = Game.minimapCanvas.getContext('2d');
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    Game.socket = io();
    setupSocketEvents();
    setupInputEvents();
    setupMenuEvents();
    createHotbar();
    
    Game.socket.emit('getServers');
    
    requestAnimationFrame(gameLoop);
}

function resizeCanvas() {
    Game.canvas.width = window.innerWidth;
    Game.canvas.height = window.innerHeight;
    Game.minimapCanvas.width = 150;
    Game.minimapCanvas.height = 100;
}

// ==================== SOCKET EVENTS ====================
function setupSocketEvents() {
    const socket = Game.socket;
    
    socket.on('connect', () => {
        Game.connected = true;
        console.log('Conectado ao servidor');
    });
    
    socket.on('disconnect', () => {
        Game.connected = false;
        Game.playing = false;
        console.log('Desconectado');
    });
    
    socket.on('serverList', (servers) => {
        updateServerList(servers);
    });
    
    socket.on('joinSuccess', (data) => {
        console.log('Entrou no jogo!', data);
        
        Game.playerId = data.playerId;
        Game.player = data.player;
        Game.world = data.world;
        Game.dayTime = data.time;
        Game.wave = data.wave;
        Game.waveTimer = data.waveTimer;
        
        document.getElementById('loading').classList.add('loading-hidden');
        document.getElementById('menu').classList.add('menu-hidden');
        document.getElementById('gameContainer').style.display = 'block';
        
        Game.playing = true;
        
        Game.camera.x = Game.player.x - Game.canvas.width / 2;
        Game.camera.y = Game.player.y - Game.canvas.height / 2;
        
        updateHotbar();
    });
    
    socket.on('joinError', (data) => {
        alert(data.message);
        document.getElementById('loading').classList.add('loading-hidden');
        document.getElementById('menu').classList.remove('menu-hidden');
    });
    
    socket.on('gameState', (state) => {
        Game.dayTime = state.time;
        Game.wave = state.wave;
        Game.waveTimer = state.waveTimer;
        
        Game.players.clear();
        state.players.forEach(p => {
            Game.players.set(p.id, p);
            if (p.id === Game.playerId) {
                Object.assign(Game.player, p);
            }
        });
        
        Game.zombies.clear();
        state.zombies.forEach(z => Game.zombies.set(z.id, z));
        
        Game.projectiles.clear();
        state.projectiles.forEach(p => Game.projectiles.set(p.id, p));
        
        Game.items.clear();
        state.items.forEach(i => Game.items.set(i.id, i));
        
        updateUI();
    });
    
    socket.on('playerJoined', (data) => {
        addChatMessage('Sistema', `${data.player.name} entrou no jogo`, '#44ff44');
    });
    
    socket.on('playerLeft', (data) => {
        const player = Game.players.get(data.playerId);
        if (player) {
            addChatMessage('Sistema', `${player.name} saiu do jogo`, '#ff4444');
        }
    });
    
    socket.on('blockBroken', (data) => {
        if (Game.world) {
            Game.world.tiles[data.x][data.y] = 0;
        }
        
        // Part√≠culas
        for (let i = 0; i < 5; i++) {
            Game.particles.push({
                x: data.x * CONFIG.TILE_SIZE + Math.random() * CONFIG.TILE_SIZE,
                y: data.y * CONFIG.TILE_SIZE + Math.random() * CONFIG.TILE_SIZE,
                vx: (Math.random() - 0.5) * 3,
                vy: -Math.random() * 3,
                size: 2 + Math.random() * 2,
                color: '#8B5A2B',
                life: 0.5
            });
        }
    });
    
    socket.on('blockPlaced', (data) => {
        if (Game.world) {
            Game.world.tiles[data.x][data.y] = data.tile;
        }
    });
    
    socket.on('playerDamaged', (data) => {
        if (data.playerId === Game.playerId) {
            Game.camera.shakeX = (Math.random() - 0.5) * 10;
            Game.camera.shakeY = (Math.random() - 0.5) * 10;
            Game.damageFlash = 1;
        }
    });
    
    socket.on('zombieDeath', (data) => {
        for (let i = 0; i < 8; i++) {
            Game.particles.push({
                x: data.x,
                y: data.y,
                vx: (Math.random() - 0.5) * 5,
                vy: -Math.random() * 5,
                size: 3 + Math.random() * 3,
                color: '#8B0000',
                life: 1
            });
        }
    });
    
    socket.on('playerAttack', (data) => {
        const player = Game.players.get(data.playerId);
        if (player) {
            player.attacking = true;
        }
    });
    
    socket.on('newWave', (data) => {
        showNotification(`‚öîÔ∏è WAVE ${data.wave}`, 'wave');
        addChatMessage('Sistema', `Wave ${data.wave} come√ßou!`, '#ff4444');
    });
    
    socket.on('bossSpawn', () => {
        showNotification('üíÄ BOSS APARECEU!', 'boss');
        addChatMessage('Sistema', 'Um BOSS apareceu!', '#ff00ff');
    });
    
    socket.on('levelUp', (data) => {
        if (data.playerId === Game.playerId) {
            showNotification(`üéâ LEVEL ${data.level}!`, 'level');
        }
    });
    
    socket.on('itemCollected', () => {
        updateHotbar();
    });
    
    socket.on('chatMessage', (data) => {
        const player = Game.players.get(data.playerId);
        addChatMessage(data.playerName, data.message, player?.color || '#fff');
    });
}

// ==================== INPUT ====================
function setupInputEvents() {
    window.addEventListener('keydown', (e) => {
        if (Game.chatOpen && e.key !== 'Escape' && e.key !== 'Enter') return;
        
        Game.keys[e.code] = true;
        
        if (e.key >= '1' && e.key <= '9') {
            Game.selectedSlot = parseInt(e.key) - 1;
            Game.socket.emit('selectSlot', Game.selectedSlot);
            updateHotbar();
        }
        
        if (e.key === 'Enter') {
            toggleChat();
        }
        
        if (e.key === 'Escape' && Game.chatOpen) {
            toggleChat();
        }
    });
    
    window.addEventListener('keyup', (e) => {
        Game.keys[e.code] = false;
    });
    
    Game.canvas.addEventListener('mousemove', (e) => {
        Game.mouse.x = e.clientX;
        Game.mouse.y = e.clientY;
    });
    
    Game.canvas.addEventListener('mousedown', (e) => {
        Game.mouse.down = true;
        handleClick(e);
    });
    
    Game.canvas.addEventListener('mouseup', () => {
        Game.mouse.down = false;
    });
    
    Game.canvas.addEventListener('contextmenu', (e) => e.preventDefault());
    
    setupMobileControls();
}

function setupMobileControls() {
    const joystickLeft = document.getElementById('joystickLeft');
    const knobLeft = document.getElementById('knobLeft');
    const jumpBtn = document.getElementById('jumpBtn');
    const attackBtn = document.getElementById('attackBtn');
    
    let leftTouch = null;
    
    joystickLeft.addEventListener('touchstart', (e) => {
        e.preventDefault();
        leftTouch = e.touches[0].identifier;
    });
    
    window.addEventListener('touchmove', (e) => {
        for (let touch of e.touches) {
            if (touch.identifier === leftTouch) {
                const rect = joystickLeft.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let dx = touch.clientX - centerX;
                let dy = touch.clientY - centerY;
                const dist = Math.hypot(dx, dy);
                const maxDist = rect.width / 2 - 25;
                
                if (dist > maxDist) {
                    dx = dx / dist * maxDist;
                    dy = dy / dist * maxDist;
                }
                
                knobLeft.style.left = `calc(50% + ${dx}px)`;
                knobLeft.style.top = `calc(50% + ${dy}px)`;
                
                Game.joystick.left.x = dx / maxDist;
                Game.joystick.left.y = dy / maxDist;
            }
        }
    });
    
    window.addEventListener('touchend', (e) => {
        for (let touch of e.changedTouches) {
            if (touch.identifier === leftTouch) {
                leftTouch = null;
                Game.joystick.left = { x: 0, y: 0 };
                knobLeft.style.left = '50%';
                knobLeft.style.top = '50%';
            }
        }
    });
    
    jumpBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        Game.keys['Space'] = true;
    });
    
    jumpBtn.addEventListener('touchend', () => {
        Game.keys['Space'] = false;
    });
    
    attackBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (Game.playing) {
            Game.socket.emit('playerAction', {
                type: 'attack',
                x: Game.player.x + (Game.player.facingRight ? 40 : -40),
                y: Game.player.y
            });
        }
    });
}

function handleClick(e) {
    if (!Game.playing || !Game.player) return;
    
    const worldX = Game.mouse.x + Game.camera.x;
    const worldY = Game.mouse.y + Game.camera.y;
    
    if (e.button === 0) {
        const item = Game.player.hotbar?.[Game.selectedSlot];
        
        if (item?.type === 'pickaxe') {
            Game.socket.emit('playerAction', { type: 'break', x: worldX, y: worldY });
        } else {
            Game.socket.emit('playerAction', { type: 'attack', x: worldX, y: worldY });
        }
    } else if (e.button === 2) {
        Game.socket.emit('playerAction', { type: 'place', x: worldX, y: worldY });
    }
}
        // ==================== MENU ====================
function setupMenuEvents() {
    document.querySelectorAll('.color-option').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        });
    });
    
    document.getElementById('playBtn').addEventListener('click', () => {
        const name = document.getElementById('playerName').value.trim() || 'Jogador';
        const color = document.querySelector('.color-option.selected').dataset.color;
        
        document.getElementById('menu').classList.add('menu-hidden');
        document.getElementById('loading').classList.remove('loading-hidden');
        
        let progress = 0;
        const loadingBar = document.getElementById('loadingBar');
        const loadingText = document.getElementById('loadingText');
        
        const steps = ['Conectando...', 'Gerando mundo...', 'Carregando...', 'Iniciando...'];
        
        const interval = setInterval(() => {
            progress += 5;
            loadingBar.style.width = progress + '%';
            loadingText.textContent = steps[Math.floor(progress / 30)] || steps[steps.length - 1];
            
            if (progress >= 100) {
                clearInterval(interval);
                Game.socket.emit('joinGame', {
                    playerName: name,
                    playerColor: color
                });
            }
        }, 50);
    });
    
    document.getElementById('refreshServers').addEventListener('click', () => {
        Game.socket.emit('getServers');
    });
    
    document.getElementById('chatSend').addEventListener('click', sendChatMessage);
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
}

function updateServerList(servers) {
    const list = document.getElementById('serverList');
    list.innerHTML = '';
    
    if (servers.length === 0) {
        servers = [{ id: 'main', name: 'Servidor Principal', players: 0, maxPlayers: 10, wave: 1 }];
    }
    
    servers.forEach((server, index) => {
        const div = document.createElement('div');
        div.className = 'server-item' + (index === 0 ? ' selected' : '');
        div.dataset.server = server.id;
        div.innerHTML = `
            <div class="server-info">
                <h3>${server.name}</h3>
                <span>Wave ${server.wave}</span>
            </div>
            <div class="server-players">${server.players}/${server.maxPlayers}</div>
        `;
        div.addEventListener('click', () => {
            document.querySelectorAll('.server-item').forEach(s => s.classList.remove('selected'));
            div.classList.add('selected');
        });
        list.appendChild(div);
    });
}

// ==================== UI ====================
function createHotbar() {
    const hotbar = document.getElementById('hotbar');
    hotbar.innerHTML = '';
    
    for (let i = 0; i < 9; i++) {
        const slot = document.createElement('div');
        slot.className = 'hotbar-slot' + (i === 0 ? ' selected' : '');
        slot.innerHTML = `
            <span class="slot-number">${i + 1}</span>
            <span class="item-icon"></span>
            <span class="item-count"></span>
        `;
        slot.addEventListener('click', () => {
            Game.selectedSlot = i;
            Game.socket.emit('selectSlot', i);
            updateHotbar();
        });
        hotbar.appendChild(slot);
    }
}

function updateHotbar() {
    if (!Game.player?.hotbar) return;
    
    const slots = document.querySelectorAll('.hotbar-slot');
    const icons = {
        'pickaxe': '‚õèÔ∏è',
        'sword': 'üó°Ô∏è',
        'torch': 'üî¶',
        'wood': 'ü™µ',
        'coin': 'ü™ô',
        'health_potion': '‚ù§Ô∏è'
    };
    
    slots.forEach((slot, i) => {
        const item = Game.player.hotbar[i];
        const icon = slot.querySelector('.item-icon');
        const count = slot.querySelector('.item-count');
        
        slot.classList.toggle('selected', i === Game.selectedSlot);
        
        if (item) {
            icon.textContent = icons[item.type] || '‚ùì';
            count.textContent = item.amount > 1 ? item.amount : '';
        } else {
            icon.textContent = '';
            count.textContent = '';
        }
    });
}

function updateUI() {
    if (!Game.player) return;
    
    const hpPercent = (Game.player.hp / Game.player.maxHp) * 100;
    document.getElementById('healthFill').style.width = hpPercent + '%';
    document.getElementById('healthText').textContent = `${Math.ceil(Game.player.hp)}/${Game.player.maxHp}`;
    
    const xpNeeded = 100 * Math.pow(1.5, Game.player.level - 1);
    const xpPercent = (Game.player.xp / xpNeeded) * 100;
    document.getElementById('xpFill').style.width = xpPercent + '%';
    document.getElementById('levelText').textContent = `Lv.${Game.player.level}`;
    
    document.getElementById('waveNumber').textContent = Game.wave;
    document.getElementById('waveTimer').textContent = Math.ceil(Game.waveTimer);
    
    const isDay = Game.dayTime >= 0.25 && Game.dayTime <= 0.75;
    document.getElementById('timeIcon').textContent = isDay ? '‚òÄÔ∏è' : 'üåô';
    document.getElementById('timeText').textContent = isDay ? 'Dia' : 'Noite';
}

function toggleChat() {
    Game.chatOpen = !Game.chatOpen;
    const input = document.getElementById('chatInput');
    if (Game.chatOpen) {
        input.focus();
    } else {
        input.blur();
    }
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message) {
        Game.socket.emit('chatMessage', message);
        input.value = '';
    }
    
    toggleChat();
}

function addChatMessage(name, text, color = '#fff') {
    const container = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = 'chat-message';
    msg.innerHTML = `<span class="name" style="color: ${color}">${name}:</span> <span class="text">${text}</span>`;
    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
    
    while (container.children.length > 50) {
        container.removeChild(container.firstChild);
    }
}

function showNotification(text, type = '') {
    const notif = document.createElement('div');
    notif.className = 'notification ' + type;
    notif.textContent = text;
    document.body.appendChild(notif);
    
    setTimeout(() => notif.remove(), 3000);
}

// ==================== RENDER ====================
function render() {
    const ctx = Game.ctx;
    const width = Game.canvas.width;
    const height = Game.canvas.height;
    
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, width, height);
    
    if (!Game.playing || !Game.world) return;
    
    updateCamera();
    
    ctx.save();
    ctx.translate(-Game.camera.x + Game.camera.shakeX, -Game.camera.y + Game.camera.shakeY);
    
    renderSky(ctx);
    renderWorld(ctx);
    renderItems(ctx);
    renderPlayers(ctx);
    renderZombies(ctx);
    renderProjectiles(ctx);
    renderParticles(ctx);
    
    ctx.restore();
    
    if (Game.damageFlash > 0) {
        ctx.fillStyle = `rgba(255, 0, 0, ${Game.damageFlash * 0.3})`;
        ctx.fillRect(0, 0, width, height);
        Game.damageFlash -= 0.05;
    }
    
    if (CONFIG.SHOW_FPS) {
        ctx.fillStyle = '#fff';
        ctx.font = '14px monospace';
        ctx.fillText(`FPS: ${Game.fps}`, 10, height - 10);
    }
    
    renderMinimap();
}

function updateCamera() {
    if (!Game.player) return;
    
    const targetX = Game.player.x - Game.canvas.width / 2;
    const targetY = Game.player.y - Game.canvas.height / 2;
    
    Game.camera.x += (targetX - Game.camera.x) * 0.1;
    Game.camera.y += (targetY - Game.camera.y) * 0.1;
    
    Game.camera.shakeX *= 0.9;
    Game.camera.shakeY *= 0.9;
}

function renderSky(ctx) {
    const width = Game.canvas.width;
    const height = Game.canvas.height;
    
    let skyColor;
    if (Game.dayTime < 0.25 || Game.dayTime > 0.75) {
        skyColor = '#0a0a2e';
    } else {
        skyColor = '#87CEEB';
    }
    
    ctx.fillStyle = skyColor;
    ctx.fillRect(Game.camera.x, Game.camera.y, width, height);
}

function renderWorld(ctx) {
    const startX = Math.floor(Game.camera.x / CONFIG.TILE_SIZE);
    const startY = Math.floor(Game.camera.y / CONFIG.TILE_SIZE);
    const endX = startX + Math.ceil(Game.canvas.width / CONFIG.TILE_SIZE) + 1;
    const endY = startY + Math.ceil(Game.canvas.height / CONFIG.TILE_SIZE) + 1;
    
    for (let x = startX; x <= endX; x++) {
        for (let y = startY; y <= endY; y++) {
            if (x < 0 || x >= Game.world.width || y < 0 || y >= Game.world.height) continue;
            
            const tile = Game.world.tiles[x][y];
            if (!tile || !TILE_COLORS[tile]) continue;
            
            ctx.fillStyle = TILE_COLORS[tile][0];
            ctx.fillRect(x * CONFIG.TILE_SIZE, y * CONFIG.TILE_SIZE, CONFIG.TILE_SIZE, CONFIG.TILE_SIZE);
            
            // Detalhes
            if (TILE_COLORS[tile][1]) {
                ctx.fillStyle = TILE_COLORS[tile][1];
                ctx.fillRect(
                    x * CONFIG.TILE_SIZE + 2,
                    y * CONFIG.TILE_SIZE + 2,
                    CONFIG.TILE_SIZE - 4,
                    CONFIG.TILE_SIZE - 4
                );
            }
            
            // Tocha
            if (tile === 15) {
                ctx.fillStyle = '#FF4500';
                ctx.beginPath();
                ctx.arc(
                    x * CONFIG.TILE_SIZE + 8,
                    y * CONFIG.TILE_SIZE + 4,
                    4, 0, Math.PI * 2
                );
                ctx.fill();
            }
        }
    }
}

function renderItems(ctx) {
    Game.items.forEach(item => {
        const bob = Math.sin(Date.now() / 300) * 3;
        
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.beginPath();
        ctx.arc(item.x, item.y + bob, 15, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('‚ú®', item.x, item.y + bob);
    });
}

function renderPlayers(ctx) {
    Game.players.forEach(player => {
        ctx.fillStyle = player.color || '#00ff44';
        ctx.fillRect(
            player.x - 12,
            player.y - 20,
            24, 40
        );
        
        ctx.fillStyle = '#FFE4C4';
        ctx.fillRect(
            player.x - 10,
            player.y - 20,
            20, 15
        );
        
        ctx.fillStyle = '#fff';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(player.name, player.x, player.y - 30);
        
        // HP
        ctx.fillStyle = '#333';
        ctx.fillRect(player.x - 20, player.y - 26, 40, 4);
        ctx.fillStyle = '#ff4444';
        ctx.fillRect(player.x - 20, player.y - 26, 40 * (player.hp / player.maxHp), 4);
    });
}

function renderZombies(ctx) {
    Game.zombies.forEach(zombie => {
        const colors = {
            normal: '#2d5a27',
            fast: '#1a3a17',
            tank: '#4a2a4a',
            boss: '#5a0000'
        };
        
        ctx.fillStyle = colors[zombie.type] || colors.normal;
        ctx.fillRect(
            zombie.x - zombie.width / 2,
            zombie.y - zombie.height / 2,
            zombie.width,
            zombie.height
        );
        
        if (zombie.isBoss) {
            ctx.strokeStyle = '#ff00ff';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                zombie.x - zombie.width / 2,
                zombie.y - zombie.height / 2,
                zombie.width,
                zombie.height
            );
        }
    });
}

function renderProjectiles(ctx) {
    Game.projectiles.forEach(proj => {
        ctx.fillStyle = '#FFD700';
        ctx.fillRect(proj.x - 4, proj.y - 2, 8, 4);
    });
}

function renderParticles(ctx) {
    Game.particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
    });
    ctx.globalAlpha = 1;
}

function renderMinimap() {
    const ctx = Game.minimapCtx;
    const width = Game.minimapCanvas.width;
    const height = Game.minimapCanvas.height;
    
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, width, height);
    
    if (!Game.world || !Game.player) return;
    
    const scale = 0.5;
    const centerX = Game.player.x / CONFIG.TILE_SIZE;
    const centerY = Game.player.y / CONFIG.TILE_SIZE;
    
    const startX = Math.floor(centerX - width / scale / 2);
    const startY = Math.floor(centerY - height / scale / 2);
    
    for (let x = 0; x < width / scale; x++) {
        for (let y = 0; y < height / scale; y++) {
            const wx = startX + x;
            const wy = startY + y;
            
            if (wx < 0 || wx >= Game.world.width || wy < 0 || wy >= Game.world.height) continue;
            
            const tile = Game.world.tiles[wx][wy];
            if (tile && TILE_COLORS[tile]) {
                ctx.fillStyle = TILE_COLORS[tile][0];
                ctx.fillRect(x * scale, y * scale, scale, scale);
            }
        }
    }
    
    ctx.fillStyle = '#00ff44';
    ctx.fillRect(width/2 - 2, height/2 - 2, 4, 4);
}

// ==================== GAME LOOP ====================
function gameLoop(timestamp) {
    const dt = (timestamp - Game.lastUpdate) / 1000;
    Game.lastUpdate = timestamp;
    
    Game.frameCount++;
    if (timestamp - Game.lastFpsUpdate >= 1000) {
        Game.fps = Game.frameCount;
        Game.frameCount = 0;
        Game.lastFpsUpdate = timestamp;
    }
    
    if (Game.playing) {
        updateInput();
        updateParticles(dt);
    }
    
    render();
    
    requestAnimationFrame(gameLoop);
}

function updateInput() {
    if (!Game.player) return;
    
    const input = {
        left: Game.keys['KeyA'] || Game.keys['ArrowLeft'] || Game.joystick.left.x < -0.3,
        right: Game.keys['KeyD'] || Game.keys['ArrowRight'] || Game.joystick.left.x > 0.3,
        jump: Game.keys['Space'] || Game.keys['KeyW'] || Game.joystick.left.y < -0.5
    };
    
    Game.socket.emit('playerInput', input);
}

function updateParticles(dt) {
    for (let i = Game.particles.length - 1; i >= 0; i--) {
        const p = Game.particles[i];
        p.x += p.vx || 0;
        p.y += p.vy || 0;
        p.vy = (p.vy || 0) + 0.5;
        p.life -= dt;
        
        if (p.life <= 0) {
            Game.particles.splice(i, 1);
        }
    }
}

// Inicia o jogo
window.addEventListener('load', init);
    </script>
</body>
</html>
