<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Legends V6</title>
<style>
* { box-sizing: border-box; touch-action: none; user-select: none; font-family: 'Verdana', sans-serif; }
body { margin: 0; background: #121212; overflow: hidden; color: white; }

/* TELAS */
.screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 100; transition: 0.3s; }
.hidden { opacity: 0; pointer-events: none; }

h1 { color: #f39c12; font-size: 3rem; text-shadow: 0 5px 0 #d35400; margin-bottom: 20px; }
input { background: #333; border: 2px solid #555; padding: 15px; font-size: 18px; color: white; border-radius: 8px; text-align: center; margin: 5px; }
button { background: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 8px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 0 #1e8449; }
button:active { transform: translateY(4px); box-shadow: none; }

/* HUD */
#hud { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
.bars { position: absolute; top: 10px; left: 10px; }
.bar-con { width: 200px; height: 20px; background: #222; border: 2px solid #fff; border-radius: 10px; overflow: hidden; margin-bottom: 5px; position: relative; }
.fill { height: 100%; transition: width 0.2s; }
.txt { position: absolute; width: 100%; text-align: center; font-size: 12px; font-weight: bold; line-height: 20px; text-shadow: 1px 1px 0 #000; }

.inv { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
.slot { background: rgba(0,0,0,0.7); padding: 8px; border-radius: 6px; border: 1px solid #777; font-size: 14px; display: flex; align-items: center; gap: 5px; }

/* BOT√ÉO DE CRAFTING */
#craftBtn { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); background: #8e44ad; display: none; pointer-events: auto; animation: pop 0.3s; }
@keyframes pop { from{transform:translateX(-50%) scale(0);} to{transform:translateX(-50%) scale(1);} }

/* MENU DE CRAFTING */
#craftMenu { background: rgba(0,0,0,0.95); z-index: 150; }
.craft-grid { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
.craft-item { background: #34495e; border: 2px solid #95a5a6; padding: 15px; border-radius: 8px; width: 140px; text-align: center; cursor: pointer; pointer-events: auto; }
.craft-item h3 { font-size: 14px; margin: 0 0 5px 0; color: #f1c40f; }
.cost { font-size: 12px; color: #aaa; }

/* LEVEL UP */
#levelUp { background: rgba(0,0,0,0.95); z-index: 200; }
.card { background: #2c3e50; border: 2px solid #f1c40f; padding: 20px; border-radius: 10px; width: 130px; text-align: center; cursor: pointer; pointer-events: auto; }

#minimap { position: absolute; top: 60px; right: 10px; border: 2px solid #fff; border-radius: 50%; background: rgba(0,0,0,0.5); width: 120px; height: 120px; }

canvas { display: block; }
</style>
</head>
<body>

<div id="menu" class="screen">
    <h1>RPG LEGENDS V6</h1>
    <input id="name" placeholder="Seu Nome">
    <button id="btnCreate">CRIAR MUNDO</button>
    <div style="color:#aaa; margin:5px">ou</div>
    <input id="code" placeholder="C√ìDIGO">
    <button id="btnJoin" style="background:#2980b9">ENTRAR</button>
</div>

<div id="hud">
    <div class="bars">
        <div class="bar-con"><div id="hpBar" class="fill" style="background:#e74c3c; width:100%"></div><div id="hpTxt" class="txt">100/100</div></div>
        <div class="bar-con"><div id="xpBar" class="fill" style="background:#3498db; width:0%"></div><div id="xpTxt" class="txt">LVL 1</div></div>
    </div>
    <div class="inv">
        <div class="slot">ü™µ <span id="wood">0</span></div>
        <div class="slot">ü™® <span id="stone">0</span></div>
    </div>
    <button id="craftBtn" onclick="openCraft()">üõ†Ô∏è CRAFTING</button>
    <canvas id="minimap"></canvas>
</div>

<div id="craftMenu" class="screen hidden">
    <h2>CONSTRU√á√ÉO</h2>
    <div class="craft-grid">
        <div class="craft-item" onclick="build('table')"><h3>BANCADA</h3><p class="cost">5 Mad</p></div>
        <div class="craft-item" onclick="build('wall_wood')"><h3>PAREDE MAD.</h3><p class="cost">10 Mad</p></div>
        <div class="craft-item" onclick="build('wall_stone')"><h3>PAREDE PEDRA</h3><p class="cost">10 Ped</p></div>
        <div class="craft-item" onclick="build('campfire')"><h3>FOGUEIRA (Cura)</h3><p class="cost">15 Mad / 5 Ped</p></div>
        <div class="craft-item" onclick="build('turret')"><h3>TORRETA</h3><p class="cost">20 Mad / 10 Ped</p></div>
    </div>
    <button onclick="closeCraft()" style="background:#c0392b; margin-top:20px">FECHAR</button>
</div>

<div id="levelUp" class="screen hidden">
    <h2 style="color:#f1c40f">LEVEL UP! ESCOLHA:</h2>
    <div class="craft-grid">
        <div class="card" onclick="up('multi')"><h3>üî´ TRIPLO</h3><p>Atira 3x</p></div>
        <div class="card" onclick="up('vamp')"><h3>ü©∏ VAMPIRO</h3><p>Rouba Vida</p></div>
        <div class="card" onclick="up('dmg')"><h3>‚öîÔ∏è DANO</h3><p>+40% For√ßa</p></div>
    </div>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
/* === AUDIO SYSTEM (SINTETIZADO) === */
const ac = new (window.AudioContext||window.webkitAudioContext)();
function sfx(type) {
    if(ac.state==='suspended') ac.resume();
    const o = ac.createOscillator(); const g = ac.createGain();
    o.connect(g); g.connect(ac.destination);
    const t = ac.currentTime;
    if(type==='hit'){ o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(0.01,t+0.1); g.gain.setValueAtTime(0.5,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(); o.stop(t+0.1); }
    if(type==='wood'){ o.type='square'; o.frequency.setValueAtTime(100,t); o.frequency.linearRampToValueAtTime(50,t+0.1); g.gain.setValueAtTime(0.3,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(); o.stop(t+0.1); }
    if(type==='shoot'){ o.type='triangle'; o.frequency.setValueAtTime(600,t); o.frequency.exponentialRampToValueAtTime(100,t+0.2); g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.2); o.start(); o.stop(t+0.2); }
}

/* === ENGINE VISUAL === */
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const mCvs = document.getElementById('minimap');
const mCtx = mCvs.getContext('2d');
mCvs.width=120; mCvs.height=120;

let socket = io();
let myId = null, roomId = null;
let cam = {x:0, y:0}, me = {x:0,y:0,wood:0,stone:0,hp:100,maxHp:100};
let state = {players:{}, enemies:[], resources:[], buildings:[], orbs:[]};
let particles = [], texts = [], shots = [];
let joyL = {on:false, dx:0, dy:0}, joyR = {on:false, dx:0, dy:0, ang:0};

function resize(){ cvs.width=window.innerWidth; cvs.height=window.innerHeight; }
resize(); window.onresize=resize;

/* REDE */
document.getElementById('btnCreate').onclick = () => socket.emit('createRoom', document.getElementById('name').value);
document.getElementById('btnJoin').onclick = () => socket.emit('joinRoom', {code:document.getElementById('code').value.toUpperCase(), name:document.getElementById('name').value});

const start = (id) => { roomId=id; document.getElementById('menu').classList.add('hidden'); document.getElementById('hud').style.display='block'; };
socket.on('roomCreated', start); socket.on('joinedRoom', start); socket.on('connect', ()=>myId=socket.id);

socket.on('update', d => {
    state = d;
    if(state.players[myId]) {
        const s = state.players[myId];
        me.hp=s.hp; me.maxHp=s.maxHp; me.xp=s.xp; me.level=s.level; me.wood=s.wood; me.stone=s.stone; me.dead=s.dead; me.nextLevel=s.nextLevel;
        updateHUD();
    }
});
socket.on('shake', id => { /* Shake logic if needed */ });
socket.on('resBreak', d => {
    sfx('wood');
    for(let i=0; i<8; i++) particles.push({x:d.x, y:d.y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1, color: d.type==='tree'?'#795548':'#7f8c8d'});
});
socket.on('dmg', d => {
    sfx('hit');
    texts.push({x:d.x, y:d.y, val:d.val, t:1});
});
socket.on('turretShot', d => {
    shots.push({x:d.sx, y:d.sy, tx:d.ex, ty:d.ey, t:1});
    sfx('shoot');
});
socket.on('levelUp', () => document.getElementById('levelUp').classList.remove('hidden'));

/* INPUT */
cvs.addEventListener('touchstart', e => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.clientX < window.innerWidth/2 && !joyL.on) { joyL.on=true; joyL.id=t.identifier; joyL.ox=t.clientX; joyL.oy=t.clientY; }
        else if(t.clientX > window.innerWidth/2 && !joyR.on) { joyR.on=true; joyR.id=t.identifier; joyR.ox=t.clientX; joyR.oy=t.clientY; }
    }
}, {passive:false});
cvs.addEventListener('touchmove', e => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.identifier===joyL.id) {
            const dx = t.clientX-joyL.ox; const dy = t.clientY-joyL.oy;
            const d = Math.min(Math.hypot(dx,dy), 40); const a = Math.atan2(dy,dx);
            joyL.dx = Math.cos(a)*(d/40); joyL.dy = Math.sin(a)*(d/40);
        }
        if(t.identifier===joyR.id) {
            joyR.dx = t.clientX-joyR.ox; joyR.dy = t.clientY-joyR.oy; joyR.ang = Math.atan2(joyR.dy, joyR.dx);
        }
    }
}, {passive:false});
cvs.addEventListener('touchend', e => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.identifier===joyL.id) { joyL.on=false; joyL.dx=0; joyL.dy=0; }
        if(t.identifier===joyR.id) joyR.on=false;
    }
}, {passive:false});

/* LOOP */
let lastShot = 0;
function loop() {
    requestAnimationFrame(loop);
    if(!roomId) return;

    // Movimento
    if(joyL.on && !me.dead) { me.x += joyL.dx*6; me.y += joyL.dy*6; me.x=Math.max(0,Math.min(2400,me.x)); me.y=Math.max(0,Math.min(2400,me.y)); }
    
    // Auto-Aim Limitado (S√≥ atira se Perto)
    let aim = joyR.on ? joyR.ang : null;
    if(!aim) {
        let min=200, t=null; // Range reduzido do auto-fire
        state.enemies.forEach(e => { const d=Math.hypot(e.x-me.x, e.y-me.y); if(d<min){min=d; t=e;} });
        if(t) aim = Math.atan2(t.y-me.y, t.x-me.x);
    }
    
    // Cam
    cam.x += (me.x - cam.x - cvs.width/2)*0.1; cam.y += (me.y - cam.y - cvs.height/2)*0.1;

    // Send
    socket.emit('move', {roomId, x:me.x, y:me.y, state:joyL.on?'run':'idle', facing:joyL.dx>0?1:-1, angle:aim||0});
    if((joyR.on || aim!==null) && Date.now()-lastShot > 300) { lastShot=Date.now(); socket.emit('attack', {roomId, angle:aim}); if(aim!==null) sfx('shoot'); }

    // RENDER
    ctx.fillStyle = "#1e272e"; ctx.fillRect(0,0,cvs.width, cvs.height);
    ctx.save(); ctx.translate(-cam.x, -cam.y);
    
    // Grid ch√£o
    const T=100;
    const sx=Math.floor(cam.x/T)*T; const sy=Math.floor(cam.y/T)*T;
    for(let i=sx; i<cam.x+cvs.width; i+=T) for(let j=sy; j<cam.y+cvs.height; j+=T) {
        const r = Math.sin(i*j); ctx.fillStyle = r>0?"#27ae60":"#2ecc71"; ctx.fillRect(i,j,T,T);
    }

    // Objetos
    state.resources.forEach(r => drawRes(r));
    state.buildings.forEach(b => drawBuild(b));
    state.orbs.forEach(o => { ctx.shadowBlur=10; ctx.shadowColor="#0ff"; ctx.fillStyle="#0ff"; ctx.beginPath(); ctx.arc(o.x, o.y, 4, 0, 7); ctx.fill(); ctx.shadowBlur=0; });

    // Inimigos
    state.enemies.forEach(e => {
        if(e.dead) return;
        const bob = Math.sin(Date.now()/100)*3;
        // Sombra
        ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(e.x, e.y, 15, 8, 0, 0, 7); ctx.fill();
        // Corpo
        ctx.fillStyle="#c0392b"; ctx.beginPath(); ctx.arc(e.x, e.y-15-bob, 18, 0, 7); ctx.fill();
        // Olhos bravos
        ctx.fillStyle="#fff"; ctx.beginPath(); ctx.moveTo(e.x-10, e.y-20-bob); ctx.lineTo(e.x-2, e.y-15-bob); ctx.lineTo(e.x-10, e.y-12-bob); ctx.fill();
        ctx.beginPath(); ctx.moveTo(e.x+10, e.y-20-bob); ctx.lineTo(e.x+2, e.y-15-bob); ctx.lineTo(e.x+10, e.y-12-bob); ctx.fill();
        // HP
        ctx.fillStyle="red"; ctx.fillRect(e.x-15, e.y-40-bob, 30, 4);
        ctx.fillStyle="#0f0"; ctx.fillRect(e.x-15, e.y-40-bob, 30*(e.hp/e.maxHp), 4);
    });

    // Players
    for(const id in state.players) {
        const p = state.players[id];
        if(p.dead) continue;
        const x = id===myId?me.x:p.x; const y=id===myId?me.y:p.y;
        drawPlayer(p, x, y);
    }

    // Particulas & Textos
    particles.forEach((p,i) => { p.x+=p.vx; p.y+=p.vy; p.life-=0.05; ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, 7); ctx.fill(); ctx.globalAlpha=1; if(p.life<=0)particles.splice(i,1); });
    texts.forEach((t,i) => { t.y-=1; t.t-=0.05; ctx.globalAlpha=t.t; ctx.fillStyle="#fff"; ctx.font="bold 20px Arial"; ctx.fillText(t.val, t.x, t.y); ctx.globalAlpha=1; if(t.t<=0)texts.splice(i,1); });
    shots.forEach((s,i) => { s.t-=0.1; ctx.strokeStyle="#0ff"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.tx, s.ty); ctx.stroke(); if(s.t<=0)shots.splice(i,1); });

    ctx.restore();
    
    // Joystick
    if(joyL.on) { ctx.strokeStyle="rgba(255,255,255,0.4)"; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(joyL.ox, joyL.oy, 40, 0, 7); ctx.stroke(); ctx.fillStyle="rgba(255,255,255,0.6)"; ctx.beginPath(); ctx.arc(joyL.ox+joyL.dx*40, joyL.oy+joyL.dy*40, 20, 0, 7); ctx.fill(); }
    if(joyR.on) { ctx.strokeStyle="rgba(255,0,0,0.4)"; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(joyR.ox, joyR.oy, 40, 0, 7); ctx.stroke(); ctx.fillStyle="rgba(255,0,0,0.6)"; ctx.beginPath(); ctx.arc(joyR.ox+Math.cos(joyR.ang)*40, joyR.oy+Math.sin(joyR.ang)*40, 20, 0, 7); ctx.fill(); }

    // Minimapa
    mCtx.fillStyle="#000"; mCtx.fillRect(0,0,120,120);
    const s = 120/2400;
    state.resources.forEach(r => { mCtx.fillStyle=r.type==='tree'?"#0f0":"#777"; mCtx.fillRect(r.x*s, r.y*s, 3, 3); });
    Object.keys(state.players).forEach(id => { mCtx.fillStyle=id===myId?"#fff":"#00f"; const p = state.players[id]; mCtx.beginPath(); mCtx.arc(p.x*s, p.y*s, 3, 0, 7); mCtx.fill(); });
}
loop();

function drawRes(r) {
    // Sombra
    ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(r.x, r.y+5, 12, 6, 0, 0, 7); ctx.fill();
    if(r.type==='tree') {
        ctx.fillStyle="#5d4037"; ctx.fillRect(r.x-5, r.y-10, 10, 20); // Tronco
        const off = Math.sin(Date.now()/300 + r.x); // Vento
        ctx.fillStyle="#2e7d32"; ctx.beginPath(); ctx.arc(r.x+off, r.y-25, 22, 0, 7); ctx.fill(); // Copa
        ctx.fillStyle="#4caf50"; ctx.beginPath(); ctx.arc(r.x-10+off, r.y-15, 12, 0, 7); ctx.fill();
        ctx.beginPath(); ctx.arc(r.x+10+off, r.y-15, 12, 0, 7); ctx.fill();
    } else {
        ctx.fillStyle="#7f8c8d"; ctx.beginPath(); ctx.arc(r.x, r.y, 18, 0, 7); ctx.fill();
        ctx.fillStyle="#95a5a6"; ctx.beginPath(); ctx.arc(r.x-5, r.y-5, 10, 0, 7); ctx.fill();
    }
}

function drawPlayer(p, x, y) {
    const walk = p.state==='run' ? Math.sin(Date.now()/100)*3 : 0;
    const breath = Math.sin(Date.now()/300);
    
    // Sombra
    ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(x, y+10, 15, 8, 0, 0, 7); ctx.fill();

    ctx.save(); ctx.translate(x, y+walk);
    // P√©s
    ctx.fillStyle="#111"; 
    ctx.beginPath(); ctx.arc(-8, 12-walk, 5, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.arc(8, 12+walk, 5, 0, 7); ctx.fill();
    
    // Corpo
    ctx.fillStyle = p.role==='warrior' ? "#3498db" : "#9b59b6";
    ctx.fillRect(-12, -15, 24, 25);
    
    // Cabe√ßa
    ctx.fillStyle="#f1c40f"; // Pele
    ctx.beginPath(); ctx.arc(0, -20+breath, 12, 0, 7); ctx.fill();
    
    // Capacete/Cabelo
    if(p.role==='warrior') {
        ctx.fillStyle="#95a5a6"; ctx.beginPath(); ctx.arc(0, -20+breath, 13, 3.14, 0); ctx.fill();
    } else {
        ctx.fillStyle="#8e44ad"; ctx.beginPath(); ctx.moveTo(-15,-20); ctx.lineTo(0,-40); ctx.lineTo(15,-20); ctx.fill();
    }

    // Olhos
    ctx.fillStyle="#000"; ctx.beginPath(); ctx.arc(-4 + (p.facing||0)*2, -20+breath, 2, 0, 7); ctx.arc(4 + (p.facing||0)*2, -20+breath, 2, 0, 7); ctx.fill();

    // Arma
    ctx.rotate(p.angle||0);
    ctx.fillStyle="#fff"; ctx.fillRect(15, -2, 20, 4);

    ctx.restore();
    ctx.fillStyle="#fff"; ctx.font="10px Arial"; ctx.textAlign="center"; ctx.fillText(p.name, x, y-40);
}

function drawBuild(b) {
    if(b.type==='table') {
        ctx.fillStyle="#8e44ad"; ctx.fillRect(b.x-20, b.y-10, 40, 20); // Mesa
        ctx.fillStyle="#f1c40f"; ctx.fillRect(b.x-15, b.y-15, 30, 5); // Itens
    } else if(b.type==='campfire') {
        ctx.fillStyle="#555"; ctx.beginPath(); ctx.arc(b.x, b.y, 15, 0, 7); ctx.fill();
        ctx.fillStyle="#e67e22"; ctx.beginPath(); ctx.arc(b.x, b.y-5, 8 + Math.random()*4, 0, 7); ctx.fill(); // Fogo
    } else {
        ctx.fillStyle = b.type==='wall' ? "#7f8c8d" : "#c0392b";
        ctx.fillRect(b.x-20, b.y-20, 40, 40);
        ctx.strokeStyle="#333"; ctx.lineWidth=2; ctx.strokeRect(b.x-20, b.y-20, 40, 40);
    }
}

function updateHUD() {
    document.getElementById('hpBar').style.width = (me.hp/me.maxHp*100)+'%';
    document.getElementById('hpTxt').innerText = Math.ceil(me.hp)+"/"+me.maxHp;
    document.getElementById('xpBar').style.width = (me.xp/me.nextLevel*100)+'%';
    document.getElementById('xpTxt').innerText = "LVL "+me.level;
    document.getElementById('wood').innerText = me.wood;
    document.getElementById('stone').innerText = me.stone;
    
    // Mostra bot√£o de craft se tiver bancada perto
    let nearTable = false;
    state.buildings.forEach(b => { if(b.type==='table' && Math.hypot(me.x-b.x, me.y-b.y) < 100) nearTable=true; });
    document.getElementById('craftBtn').style.display = (me.wood>=5 || nearTable) ? 'block' : 'none';
}

function openCraft() { document.getElementById('craftMenu').classList.remove('hidden'); }
function closeCraft() { document.getElementById('craftMenu').classList.add('hidden'); }
function build(t) { socket.emit('build', {roomId, type:t}); closeCraft(); }
function up(c) { socket.emit('levelup', {roomId, choice:c}); document.getElementById('levelUp').classList.add('hidden'); }
function respawn() { socket.emit('respawn', roomId); }
</script>
</body>
</html>

