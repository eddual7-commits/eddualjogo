<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>edu & kamy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: #0b0d14;
  overflow: hidden;
  font-family: system-ui, Arial;
}

/* UI */
#menu {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  z-index: 10;
}

button, input {
  padding: 6px 8px;
  font-size: 14px;
  background: #1a1d2a;
  color: white;
  border: 1px solid #333;
  border-radius: 6px;
}

#roomCode {
  font-weight: bold;
  color: #9fb4ff;
}

/* minimapa */
#minimap {
  position: fixed;
  top: 12px;
  right: 12px;
  width: 130px;
  height: 130px;
  background: #0a0c12;
  border: 2px solid #2a2e44;
  border-radius: 6px;
}

canvas {
  display: block;
}
</style>
</head>

<body>

<div id="menu">
  <span id="roomCode"></span>
  <button id="createBtn">Criar sala</button>
  <input id="roomInput" placeholder="Código">
  <button id="joinBtn">Entrar</button>
</div>

<canvas id="game"></canvas>
<canvas id="minimap"></canvas>

<script src="/socket.io/socket.io.js"></script>

<script>
/* ================= SETUP ================= */
const socket = io()
const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")
const minimap = document.getElementById("minimap")
const mctx = minimap.getContext("2d")

function resize() {
  canvas.width = innerWidth
  canvas.height = innerHeight
}
resize()
addEventListener("resize", resize)

/* ================= ESTADO ================= */
const WORLD = { w: 2400, h: 2400 }
let camera = { x: 0, y: 0 }

let roomId = null
let myId = null
let players = {}
let localPlayer = { x: 1200, y: 1200, r: 14 }
let localInit = false

/* ================= UI / SOCKET ================= */
const createBtn = document.getElementById("createBtn")
const joinBtn = document.getElementById("joinBtn")
const roomInput = document.getElementById("roomInput")
const roomCode = document.getElementById("roomCode")

socket.on("connect", () => myId = socket.id)

createBtn.onclick = () => socket.emit("createRoom")

joinBtn.onclick = () => {
  const code = roomInput.value.trim()
  if (!code) return
  roomId = code
  socket.emit("joinRoom", code)
  roomCode.innerText = "Sala: " + code
}

socket.on("roomCreated", id => {
  roomId = id
  roomCode.innerText = "Sala: " + id
  roomInput.value = id
})

socket.on("updatePlayers", data => {
  players = data
  if (!localInit && players[myId]) {
    localPlayer.x = players[myId].x
    localPlayer.y = players[myId].y
    localInit = true
  }
})

/* ================= IDENTIDADE ================= */
function getNameBySlot(id) {
  const ids = Object.keys(players)
  if (ids.length < 2) return "edu"
  return ids[0] === id ? "edu" : "kamy"
}

/* ================= FADINHAS ================= */
function createFairies() {
  return [
    { a: 0, d: 26, s: 0.04, c: "#b36bff" },
    { a: Math.PI, d: 26, s: -0.04, c: "#6be1ff" }
  ]
}
const fairiesMap = {}

function ensureFairies() {
  for (const id in players) {
    if (!fairiesMap[id]) fairiesMap[id] = createFairies()
  }
}

function drawFairies(p, id) {
  fairiesMap[id].forEach(f => {
    f.a += f.s
    const x = p.x + Math.cos(f.a) * f.d
    const y = p.y + Math.sin(f.a) * f.d

    ctx.globalAlpha = 0.8
    ctx.fillStyle = f.c
    ctx.beginPath()
    ctx.arc(x, y, 4.5, 0, Math.PI * 2)
    ctx.fill()

    ctx.globalAlpha = 0.2
    ctx.beginPath()
    ctx.arc(x, y, 10, 0, Math.PI * 2)
    ctx.fill()
    ctx.globalAlpha = 1
  })
}

/* ================= COLISÃO ================= */
function resolveCollision(a, b) {
  const dx = a.x - b.x
  const dy = a.y - b.y
  const dist = Math.hypot(dx, dy)
  const min = a.r + b.r

  if (dist > 0 && dist < min) {
    const push = (min - dist) / 2
    const nx = dx / dist
    const ny = dy / dist
    a.x += nx * push
    a.y += ny * push
    b.x -= nx * push
    b.y -= ny * push
  }
}

/* ================= FUNDO ================= */
function drawBackground() {
  const grid = 120
  ctx.strokeStyle = "#171a26"

  const sx = Math.floor(camera.x / grid) * grid
  const sy = Math.floor(camera.y / grid) * grid

  for (let x = sx; x < camera.x + canvas.width; x += grid) {
    ctx.beginPath()
    ctx.moveTo(x, camera.y)
    ctx.lineTo(x, camera.y + canvas.height)
    ctx.stroke()
  }

  for (let y = sy; y < camera.y + canvas.height; y += grid) {
    ctx.beginPath()
    ctx.moveTo(camera.x, y)
    ctx.lineTo(camera.x + canvas.width, y)
    ctx.stroke()
  }
}

/* ================= LOOP ================= */
let last = 0
let sendTimer = 0

function loop(ts) {
  const dt = ts - last
  last = ts

  ctx.clearRect(0, 0, canvas.width, canvas.height)

  /* movimento */
  if (roomId && window.joystick) {
    const speed = 5
    localPlayer.x += window.joystick.dx * speed
    localPlayer.y += window.joystick.dy * speed

    localPlayer.x = Math.max(0, Math.min(WORLD.w, localPlayer.x))
    localPlayer.y = Math.max(0, Math.min(WORLD.h, localPlayer.y))
  }

  /* envia posição */
  sendTimer += dt
  if (sendTimer > 80 && roomId) {
    sendTimer = 0
    socket.emit("move", { roomId, x: localPlayer.x, y: localPlayer.y })
  }

  /* câmera */
  camera.x += (localPlayer.x - camera.x - canvas.width / 2) * 0.12
  camera.y += (localPlayer.y - camera.y - canvas.height / 2) * 0.12

  ctx.save()
  ctx.translate(-camera.x, -camera.y)

  drawBackground()

  const ids = Object.keys(players)
  if (ids.length === 2) {
    const a = ids[0] === myId ? localPlayer : players[ids[0]]
    const b = ids[1] === myId ? localPlayer : players[ids[1]]
    resolveCollision(a, b)
  }

  ensureFairies()

  for (const id in players) {
    const p = id === myId ? localPlayer : players[id]

    ctx.fillStyle = "rgba(0,0,0,0.35)"
    ctx.beginPath()
    ctx.ellipse(p.x, p.y + 14, 14, 4, 0, 0, Math.PI * 2)
    ctx.fill()

    ctx.fillStyle = id === myId ? "#5aa9ff" : "#ffb86b"
    ctx.beginPath()
    ctx.arc(p.x, p.y, 14, 0, Math.PI * 2)
    ctx.fill()

    ctx.fillStyle = "#fff"
    ctx.font = "12px Arial"
    ctx.textAlign = "center"
    ctx.fillText(getNameBySlot(id), p.x, p.y - 22)

    drawFairies(p, id)
  }

  ctx.restore()

  /* minimapa */
  mctx.clearRect(0, 0, minimap.width, minimap.height)
  mctx.fillStyle = "#0d0f17"
  mctx.fillRect(0, 0, minimap.width, minimap.height)

  for (const id in players) {
    const p = id === myId ? localPlayer : players[id]
    const mx = (p.x / WORLD.w) * minimap.width
    const my = (p.y / WORLD.h) * minimap.height
    mctx.fillStyle = id === myId ? "#5aa9ff" : "#ffb86b"
    mctx.fillRect(mx - 2, my - 2, 4, 4)
  }

  requestAnimationFrame(loop)
}

requestAnimationFrame(loop)
</script>

<script src="js/joystick.js"></script>
</body>
</html>
