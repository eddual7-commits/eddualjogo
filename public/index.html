<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>eddual game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body {
  margin: 0;
  background: #111;
  color: white;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#menu {
  margin: 8px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: center;
}

button, input {
  padding: 6px;
  font-size: 14px;
}

#roomCode {
  width: 100%;
  text-align: center;
  font-weight: bold;
}

#gameWrapper {
  position: relative;
}

canvas {
  background: #222;
  border: 2px solid #444;
  touch-action: none;
}

/* minimapa */
#minimap {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 120px;
  height: 120px;
  background: #111;
  border: 2px solid #666;
}
</style>
</head>

<body>

<div id="menu">
  <div id="roomCode"></div>
  <button id="createBtn">Criar sala</button>
  <input id="roomInput" placeholder="Código da sala">
  <button id="joinBtn">Entrar</button>
</div>

<div id="gameWrapper">
  <canvas id="game"></canvas>
  <canvas id="minimap"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
/* ======================================================
   SETUP
====================================================== */
const socket = io()

const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")

canvas.width = Math.min(window.innerWidth - 20, 420)
canvas.height = Math.min(window.innerHeight - 140, 420)

const minimap = document.getElementById("minimap")
const mctx = minimap.getContext("2d")

let roomId = null
let players = {}
let myId = null

let localPlayer = { x: 0, y: 0 }
let localInit = false

const WORLD = { width: 2000, height: 2000 }
let camera = { x: 0, y: 0 }

/* ======================================================
   UI
====================================================== */
const createBtn = document.getElementById("createBtn")
const joinBtn = document.getElementById("joinBtn")
const roomInput = document.getElementById("roomInput")
const roomCode = document.getElementById("roomCode")

createBtn.onclick = () => socket.emit("createRoom")

joinBtn.onclick = () => {
  const code = roomInput.value.trim()
  if (!code) return
  roomId = code
  roomCode.innerText = "Sala: " + code
  socket.emit("joinRoom", code)
}

/* ======================================================
   SOCKET
====================================================== */
socket.on("connect", () => myId = socket.id)

socket.on("roomCreated", id => {
  roomId = id
  roomCode.innerText = "Sala: " + id
  roomInput.value = id
})

socket.on("updatePlayers", data => {
  players = data
  if (!localInit && players[myId]) {
    localPlayer.x = players[myId].x
    localPlayer.y = players[myId].y
    localInit = true
  }
})

/* ======================================================
   FADINHAS (COMPANIONS)
====================================================== */
const companions = [
  { angle: 0, dist: 26, speed: 0.05, color: "#b46cff" },
  { angle: Math.PI, dist: 26, speed: -0.05, color: "#6cf0ff" }
]

function updateCompanions() {
  companions.forEach(c => c.angle += c.speed)
}

function drawCompanions(player) {
  companions.forEach(c => {
    const x = player.x + Math.cos(c.angle) * c.dist
    const y = player.y + Math.sin(c.angle) * c.dist

    // brilho
    ctx.globalAlpha = 0.9
    ctx.fillStyle = c.color
    ctx.beginPath()
    ctx.arc(x, y, 5, 0, Math.PI * 2)
    ctx.fill()

    // glow fake
    ctx.globalAlpha = 0.2
    ctx.beginPath()
    ctx.arc(x, y, 10, 0, Math.PI * 2)
    ctx.fill()

    ctx.globalAlpha = 1
  })
}

/* ======================================================
   COLISÃO SIMPLES
====================================================== */
function resolvePlayerCollision(a, b) {
  const dx = a.x - b.x
  const dy = a.y - b.y
  const dist = Math.hypot(dx, dy)
  const min = 24

  if (dist > 0 && dist < min) {
    const push = (min - dist) / 2
    const nx = dx / dist
    const ny = dy / dist
    a.x += nx * push
    a.y += ny * push
    b.x -= nx * push
    b.y -= ny * push
  }
}

/* ======================================================
   LOOP
====================================================== */
function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height)

  /* MOVIMENTO */
  if (roomId && window.joystick) {
    const speed = 5
    localPlayer.x += window.joystick.dx * speed
    localPlayer.y += window.joystick.dy * speed

    localPlayer.x = Math.max(0, Math.min(WORLD.width, localPlayer.x))
    localPlayer.y = Math.max(0, Math.min(WORLD.height, localPlayer.y))

    if (Math.random() < 0.25) {
      socket.emit("move", {
        roomId,
        x: localPlayer.x,
        y: localPlayer.y
      })
    }
  }

  /* CÂMERA */
  camera.x += (localPlayer.x - camera.x - canvas.width / 2) * 0.1
  camera.y += (localPlayer.y - camera.y - canvas.height / 2) * 0.1

  ctx.save()
  ctx.translate(-camera.x, -camera.y)

  /* COLISÃO */
  const ids = Object.keys(players)
  if (ids.length === 2) {
    const a = ids[0] === myId ? localPlayer : players[ids[0]]
    const b = ids[1] === myId ? localPlayer : players[ids[1]]
    resolvePlayerCollision(a, b)
  }

  /* PLAYERS */
  for (const id in players) {
    const p = id === myId ? localPlayer : players[id]

    // sombra
    ctx.fillStyle = "rgba(0,0,0,0.4)"
    ctx.beginPath()
    ctx.ellipse(p.x, p.y + 10, 10, 4, 0, 0, Math.PI * 2)
    ctx.fill()

    // corpo (placeholder de sprite)
    ctx.fillStyle = id === myId ? "#4da6ff" : "#ffa94d"
    ctx.beginPath()
    ctx.arc(p.x, p.y, 12, 0, Math.PI * 2)
    ctx.fill()

    // fadinhas só no player local
    if (id === myId) {
      updateCompanions()
      drawCompanions(p)
    }
  }

  ctx.restore()

  /* MINIMAPA */
  mctx.clearRect(0, 0, minimap.width, minimap.height)
  mctx.fillStyle = "#222"
  mctx.fillRect(0, 0, minimap.width, minimap.height)

  for (const id in players) {
    const p = id === myId ? localPlayer : players[id]
    const mx = (p.x / WORLD.width) * minimap.width
    const my = (p.y / WORLD.height) * minimap.height
    mctx.fillStyle = id === myId ? "#4da6ff" : "#ffa94d"
    mctx.fillRect(mx - 2, my - 2, 4, 4)
  }

  requestAnimationFrame(loop)
}

loop()
</script>

<script src="js/joystick.js"></script>

</body>
</html>
