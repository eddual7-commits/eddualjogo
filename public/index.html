<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Legends V5</title>
<style>
/* ESTILO GERAL */
* { box-sizing: border-box; touch-action: none; user-select: none; font-family: 'Segoe UI', sans-serif; }
body { margin: 0; background: #0f1810; overflow: hidden; color: white; }

/* TELAS */
.screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(10,20,10,0.95); z-index: 100; transition: 0.3s; }
.hidden { opacity: 0; pointer-events: none; }

h1 { color: #f1c40f; text-shadow: 0 4px 0 #d35400; font-size: 3rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
input { background: #222; border: 2px solid #555; color: #fff; padding: 15px; font-size: 18px; border-radius: 10px; text-align: center; margin: 5px; width: 250px; }
button { background: #27ae60; color: white; border: none; padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 10px; margin-top: 10px; cursor: pointer; box-shadow: 0 5px 0 #1e8449; transition: transform 0.1s; }
button:active { transform: translateY(4px); box-shadow: none; }

/* HUD */
#hud { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
.room-code { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-weight: bold; font-family: monospace; font-size: 16px; border: 1px solid #fff; }

.stats-box { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; }
.bar { width: 180px; height: 18px; background: #222; border: 2px solid #444; border-radius: 6px; overflow: hidden; position: relative; }
.fill { height: 100%; transition: width 0.3s; }
.hp-color { background: #e74c3c; } .xp-color { background: #3498db; }
.bar-txt { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 18px; font-weight: bold; text-shadow: 1px 1px 0 #000; }

.tools { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
.tool-slot { background: rgba(0,0,0,0.7); padding: 8px; border-radius: 8px; border: 1px solid #666; display: flex; align-items: center; gap: 5px; }

#buildBtn { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: #e67e22; pointer-events: auto; display: none; }
#minimap { position: absolute; top: 60px; right: 10px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 50%; width: 110px; height: 110px; }
#fps { position: absolute; bottom: 5px; left: 5px; color: #0f0; font-size: 10px; }

/* POPUPS */
#levelUp { background: rgba(0,0,0,0.9); z-index: 200; }
.cards { display: flex; gap: 15px; }
.card { background: #2c3e50; border: 2px solid #f1c40f; padding: 20px; border-radius: 10px; width: 120px; text-align: center; cursor: pointer; pointer-events: auto; }
#death { background: rgba(50,0,0,0.95); z-index: 200; }

canvas { display: block; }
</style>
</head>
<body>

<div id="menu" class="screen">
    <h1>RPG LEGENDS</h1>
    <input id="name" placeholder="Seu Nome">
    <button id="btnCreate">CRIAR MUNDO</button>
    <div style="margin:10px; color:#aaa">ou</div>
    <input id="code" placeholder="C√ìDIGO DA SALA">
    <button id="btnJoin" style="background:#2980b9">ENTRAR</button>
</div>

<div id="hud">
    <div class="room-code" id="roomDisplay">???</div>
    <div class="stats-box">
        <div class="bar"><div id="hpBar" class="fill hp-color" style="width:100%"></div><div class="bar-txt" id="hpTxt">100/100</div></div>
        <div class="bar"><div id="xpBar" class="fill xp-color" style="width:0%"></div><div class="bar-txt" id="xpTxt">LVL 1</div></div>
    </div>
    <div class="tools">
        <div class="tool-slot"><span style="font-size:20px">ü™ì</span> <span id="wood">0</span></div>
        <div class="tool-slot"><span style="font-size:20px">‚õèÔ∏è</span> <span id="stone">0</span></div>
    </div>
    <button id="buildBtn" onclick="build()">üî® Construir (20 Mad)</button>
    <canvas id="minimap"></canvas>
    <div id="fps">60 FPS</div>
</div>

<div id="levelUp" class="screen hidden">
    <h2 style="color:#f1c40f">LEVEL UP! ESCOLHA:</h2>
    <div class="cards">
        <div class="card" onclick="up('dmg')">‚öîÔ∏è<br>+DANO</div>
        <div class="card" onclick="up('hp')">‚ù§Ô∏è<br>+VIDA</div>
        <div class="card" onclick="up('spd')">‚ö°<br>+SPEED</div>
    </div>
</div>

<div id="death" class="screen hidden">
    <h1 style="color:red">VOC√ä MORREU</h1>
    <button onclick="respawn()">RENASCER</button>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const mCvs = document.getElementById('minimap');
const mCtx = mCvs.getContext('2d');
mCvs.width=110; mCvs.height=110;

let socket = io();
let myId = null, roomId = null;
let cam = { x:0, y:0 };
let me = { x:1200, y:1200, hp:100, maxHp:100, xp:0, level:1, wood:0, stone:0 };
let state = { players:{}, enemies:[], resources:[], buildings:[], orbs:[] };
let shots = []; // Tiros do Pet
let dmgPopups = [];

// Ajuste tela
function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
resize(); window.addEventListener('resize', resize);

/* === REDE === */
document.getElementById('btnCreate').onclick = () => socket.emit('createRoom', document.getElementById('name').value);
document.getElementById('btnJoin').onclick = () => socket.emit('joinRoom', { code:document.getElementById('code').value.toUpperCase(), name:document.getElementById('name').value });

const start = (id) => {
    roomId = id;
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('hud').style.display = 'block';
    document.getElementById('roomDisplay').innerText = "SALA: " + id;
};

socket.on('roomCreated', start);
socket.on('joinedRoom', start);
socket.on('connect', () => myId = socket.id);

socket.on('update', (data) => {
    state = data;
    if(state.players[myId]) {
        const s = state.players[myId];
        // Sincroniza dados vitais
        me.hp = s.hp; me.maxHp = s.maxHp; me.xp = s.xp; me.level = s.level;
        me.wood = s.wood; me.stone = s.stone; me.dead = s.dead; me.nextLevel = s.nextLevel;
        // Posi√ß√£o para o HUD, mas movimento visual usa predi√ß√£o
        updateHUD();
    }
});

socket.on('petShot', (d) => shots.push({x:d.x, y:d.y, tx:d.tx, ty:d.ty, t:1}));
socket.on('damage', (d) => dmgPopups.push({x:d.x, y:d.y, val:d.val, t:1}));
socket.on('shake', (id) => { /* Efeito visual opcional */ });
socket.on('levelUp', () => document.getElementById('levelUp').classList.remove('hidden'));

/* === CONTROLES === */
let joyL = { on:false, id:null, dx:0, dy:0, ox:0, oy:0 };
let joyR = { on:false, id:null, dx:0, dy:0, ox:0, oy:0, ang:0 };

cvs.addEventListener('touchstart', e => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.clientX < window.innerWidth/2 && !joyL.on) {
            joyL.on = true; joyL.id = t.identifier; joyL.ox = t.clientX; joyL.oy = t.clientY;
        } else if(t.clientX > window.innerWidth/2 && !joyR.on) {
            joyR.on = true; joyR.id = t.identifier; joyR.ox = t.clientX; joyR.oy = t.clientY;
        }
    }
}, {passive:false});

cvs.addEventListener('touchmove', e => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.identifier === joyL.id) {
            const dx = t.clientX - joyL.ox; const dy = t.clientY - joyL.oy;
            const d = Math.min(Math.hypot(dx,dy), 40); const a = Math.atan2(dy, dx);
            joyL.dx = Math.cos(a)*(d/40); joyL.dy = Math.sin(a)*(d/40);
        }
        if(t.identifier === joyR.id) {
            joyR.dx = t.clientX - joyR.ox; joyR.dy = t.clientY - joyR.oy;
            joyR.ang = Math.atan2(joyR.dy, joyR.dx);
        }
    }
}, {passive:false});

cvs.addEventListener('touchend', e => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.identifier === joyL.id) { joyL.on=false; joyL.dx=0; joyL.dy=0; }
        if(t.identifier === joyR.id) joyR.on=false;
    }
}, {passive:false});

/* === LOOP VISUAL === */
let lastShot = 0;

function loop() {
    requestAnimationFrame(loop);
    if(!roomId) return;

    // 1. MOVIMENTO & C√ÇMERA SUAVE
    if(joyL.on && !me.dead) {
        me.x += joyL.dx * 6; me.y += joyL.dy * 6;
        // Limites
        me.x = Math.max(0, Math.min(2400, me.x));
        me.y = Math.max(0, Math.min(2400, me.y));
    }

    // Micro delay na camera (LERP)
    cam.x += (me.x - cam.x - cvs.width/2) * 0.08;
    cam.y += (me.y - cam.y - cvs.height/2) * 0.08;

    // L√≥gica de Tiro
    let aim = joyR.on ? joyR.ang : null;
    if(!aim) {
        // Auto Aim
        let min=500, t=null;
        state.enemies.forEach(e => {
            const d = Math.hypot(e.x - me.x, e.y - me.y);
            if(d < min) { min=d; t=e; }
        });
        if(t) aim = Math.atan2(t.y-me.y, t.x-me.x);
    }

    // Envio pro Server
    socket.emit('move', { roomId, x:me.x, y:me.y, state: joyL.on?'run':'idle', facing: joyL.dx>0?1:-1, angle:aim });
    
    if((joyR.on || aim!==null) && Date.now() - lastShot > 300) {
        lastShot = Date.now();
        socket.emit('attack', { roomId, angle: aim });
    }

    // 2. DESENHAR (ARTE PROCEDURAL)
    // Fundo Grama
    ctx.fillStyle = "#1e2f23"; ctx.fillRect(0,0,cvs.width, cvs.height);
    
    ctx.save();
    ctx.translate(-cam.x, -cam.y);
    
    drawGround(); // Tiles de grama

    // Elementos
    state.buildings.forEach(b => {
        ctx.fillStyle="#e67e22"; ctx.fillRect(b.x-20, b.y-20, 40, 40);
        ctx.fillStyle="#d35400"; ctx.fillRect(b.x-15, b.y-15, 30, 30); // Detalhe tijolo
    });

    state.resources.forEach(r => drawRes(r));
    state.orbs.forEach(o => { 
        ctx.shadowBlur=10; ctx.shadowColor="#0af"; 
        ctx.fillStyle="#0af"; ctx.beginPath(); ctx.arc(o.x, o.y, 5, 0, 7); ctx.fill(); 
        ctx.shadowBlur=0;
    });

    // Inimigos
    state.enemies.forEach(e => {
        if(e.dead) return;
        const bob = Math.sin(Date.now()/100)*3;
        ctx.fillStyle="#c0392b"; ctx.beginPath(); ctx.arc(e.x, e.y-bob, 18, 0, 7); ctx.fill();
        ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(e.x-6, e.y-5-bob, 5, 0, 7); ctx.fill(); ctx.arc(e.x+6, e.y-5-bob, 5, 0, 7); ctx.fill();
        ctx.fillStyle="red"; ctx.fillRect(e.x-15, e.y-30-bob, 30, 4);
        ctx.fillStyle="#2ecc71"; ctx.fillRect(e.x-15, e.y-30-bob, 30*(e.hp/e.maxHp), 4);
    });

    // Players
    for(const id in state.players) {
        const p = state.players[id];
        if(p.dead) continue;
        const x = id===myId ? me.x : p.x;
        const y = id===myId ? me.y : p.y;
        
        drawPlayer(p, x, y);

        // Flecha de Amigo
        if(id !== myId) {
            const dx = x - me.x; const dy = y - me.y;
            if(Math.hypot(dx,dy) > cvs.width/2) {
                const ang = Math.atan2(dy, dx);
                const ax = cam.x + cvs.width/2 + Math.cos(ang)*(cvs.width/2 - 40);
                const ay = cam.y + cvs.height/2 + Math.sin(ang)*(cvs.height/2 - 40);
                ctx.save(); ctx.translate(ax, ay); ctx.rotate(ang);
                ctx.fillStyle="#3498db"; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-10,-5); ctx.lineTo(-10,5); ctx.fill();
                ctx.restore();
            }
        }
    }

    // VFX
    shots.forEach((s,i) => {
        s.t-=0.1;
        ctx.strokeStyle="#0ff"; ctx.lineWidth=2; 
        ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.tx, s.ty); ctx.stroke();
        if(s.t<=0) shots.splice(i,1);
    });
    
    dmgPopups.forEach((d,i) => {
        d.y-=1; d.t-=0.05; ctx.globalAlpha=d.t;
        ctx.fillStyle="#fff"; ctx.font="bold 20px Arial"; ctx.fillText(d.val, d.x, d.y);
        ctx.globalAlpha=1; if(d.t<=0) dmgPopups.splice(i,1);
    });

    ctx.restore();

    // UI Joysticks
    if(joyL.on) drawJoy(joyL, "#fff");
    if(joyR.on) drawJoy(joyR, "#f00");
    
    drawMinimap();
}
loop();

/* === FUN√á√ïES DE DESENHO BONITAS === */
function drawGround() {
    // Desenha grid de grama (Otimizado: desenha s√≥ o que a camera v√™)
    const TILE = 100;
    const sx = Math.floor(cam.x/TILE)*TILE;
    const sy = Math.floor(cam.y/TILE)*TILE;
    for(let i=sx; i<cam.x+cvs.width; i+=TILE) {
        for(let j=sy; j<cam.y+cvs.height; j+=TILE) {
            // Pseudo-aleat√≥rio baseado na posi√ß√£o pra n√£o piscar
            const rand = Math.sin(i*j); 
            ctx.fillStyle = rand > 0 ? "#27ae60" : "#2ecc71";
            ctx.fillRect(i, j, TILE, TILE);
        }
    }
}

function drawRes(r) {
    if(r.type === 'tree') {
        ctx.fillStyle="#795548"; ctx.fillRect(r.x-6, r.y, 12, 20); // Tronco
        ctx.fillStyle="#2196f3"; // Sombra copa
        ctx.beginPath(); ctx.arc(r.x+2, r.y-18, 20, 0, 7); ctx.fillStyle="rgba(0,0,0,0.2)"; ctx.fill();
        ctx.fillStyle="#27ae60"; ctx.beginPath(); ctx.arc(r.x, r.y-20, 20, 0, 7); ctx.fill(); // Copa
        ctx.fillStyle="#2ecc71"; ctx.beginPath(); ctx.arc(r.x-5, r.y-25, 10, 0, 7); ctx.fill(); // Brilho
    } else {
        ctx.fillStyle="#7f8c8d"; ctx.beginPath(); ctx.arc(r.x, r.y, 15, 0, 7); ctx.fill();
        ctx.fillStyle="#95a5a6"; ctx.beginPath(); ctx.arc(r.x-3, r.y-3, 10, 0, 7); ctx.fill();
    }
}

function drawPlayer(p, x, y) {
    const breath = Math.sin(Date.now()/200)*2;
    
    // Sombra
    ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(x, y+10, 15, 8, 0, 0, 7); ctx.fill();

    // PET
    const petX = x + Math.cos(Date.now()/500)*40;
    const petY = y + Math.sin(Date.now()/500)*40;
    ctx.fillStyle="#0ff"; ctx.beginPath(); ctx.arc(petX, petY, 6, 0, 7); ctx.fill();

    // Personagem
    ctx.save(); ctx.translate(x, y+breath);
    if(p.role === 'warrior') {
        ctx.fillStyle="#3498db"; ctx.beginPath(); ctx.arc(0,0,18,0,7); ctx.fill(); // Corpo
        ctx.fillStyle="#2980b9"; ctx.beginPath(); ctx.arc(0,0,18,0,3.14); ctx.fill(); // Detalhe
        // Capacete
        ctx.fillStyle="#95a5a6"; ctx.fillRect(-10,-18,20,6); 
    } else {
        ctx.fillStyle="#9b59b6"; ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(15,10); ctx.lineTo(-15,10); ctx.fill();
        ctx.fillStyle="#f1c40f"; ctx.beginPath(); ctx.arc(0,-20,5,0,7); ctx.fill(); // Topo
    }
    
    // Olhos
    ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(-6,-4,4,0,7); ctx.arc(6,-4,4,0,7); ctx.fill();
    ctx.fillStyle="#000"; ctx.beginPath(); ctx.arc(-6 + (p.facing||0),-4,2,0,7); ctx.arc(6 + (p.facing||0),-4,2,0,7); ctx.fill();

    // Arma
    ctx.rotate(p.angle||0);
    if(p.role==='warrior') {
        ctx.fillStyle="#bdc3c7"; ctx.fillRect(15,-3,25,6); // Lamina
        ctx.fillStyle="#e67e22"; ctx.fillRect(15,-6,5,12); // Guarda
    } else {
        ctx.fillStyle="#8e44ad"; ctx.fillRect(15,-2,25,4);
        ctx.fillStyle="#e74c3c"; ctx.beginPath(); ctx.arc(40,0,5,0,7); ctx.fill();
    }
    ctx.restore();

    // Nome
    ctx.fillStyle="#fff"; ctx.font="10px Arial"; ctx.textAlign="center"; ctx.fillText(p.name, x, y-30+breath);
}

function drawJoy(j, color) {
    ctx.strokeStyle=color; ctx.lineWidth=3; ctx.globalAlpha=0.5;
    ctx.beginPath(); ctx.arc(j.ox, j.oy, 40, 0, 7); ctx.stroke();
    ctx.fillStyle=color; ctx.beginPath(); ctx.arc(j.ox+(j.dx*40||Math.cos(j.ang)*40), j.oy+(j.dy*40||Math.sin(j.ang)*40), 20, 0, 7); ctx.fill();
    ctx.globalAlpha=1;
}

function drawMinimap() {
    mCtx.fillStyle="#000"; mCtx.fillRect(0,0,110,110);
    const s = 110/2400;
    state.resources.forEach(r => { mCtx.fillStyle=r.type==='tree'?"#0f0":"#777"; mCtx.fillRect(r.x*s, r.y*s, 2, 2); });
    state.buildings.forEach(b => { mCtx.fillStyle="#e67e22"; mCtx.fillRect(b.x*s, b.y*s, 3, 3); });
    Object.keys(state.players).forEach(id => {
        mCtx.fillStyle = id===myId ? "#fff" : "#00f";
        const p = id===myId ? me : state.players[id];
        mCtx.beginPath(); mCtx.arc(p.x*s, p.y*s, 3, 0, 7); mCtx.fill();
    });
}

function updateHUD() {
    document.getElementById('hpBar').style.width = (me.hp/me.maxHp*100)+'%';
    document.getElementById('hpTxt').innerText = Math.ceil(me.hp)+"/"+me.maxHp;
    document.getElementById('xpBar').style.width = (me.xp/me.nextLevel*100)+'%';
    document.getElementById('xpTxt').innerText = "LVL "+me.level;
    document.getElementById('wood').innerText = me.wood;
    document.getElementById('stone').innerText = me.stone;
    document.getElementById('buildBtn').style.display = me.wood>=20 ? 'block' : 'none';
    if(me.dead) document.getElementById('death').classList.remove('hidden');
    else document.getElementById('death').classList.add('hidden');
}

function up(c) { socket.emit('levelup',{roomId,choice:c}); document.getElementById('levelUp').classList.add('hidden'); }
function build() { socket.emit('build',{roomId}); }
function respawn() { socket.emit('respawn', roomId); }
</script>
</body>
</html>
