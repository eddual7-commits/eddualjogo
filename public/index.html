<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‚öîÔ∏è RPG Legends V7 - Ultimate</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Russo+One&display=swap" rel="stylesheet">
<style>
* { 
    box-sizing: border-box; 
    touch-action: none; 
    user-select: none; 
    -webkit-tap-highlight-color: transparent;
}
body { 
    margin: 0; 
    background: #0a0a0a; 
    overflow: hidden; 
    color: white; 
    font-family: 'Russo One', sans-serif;
}

/* === TELA DE MENU === */
.screen { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    z-index: 100; 
    transition: all 0.5s;
}
.hidden { display: none !important; }

#menu {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
}
#menu::before {
    content: '';
    position: absolute;
    width: 100%; height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="%23ffffff10"/></svg>');
    background-size: 50px 50px;
    animation: starsMove 20s linear infinite;
}
@keyframes starsMove {
    0% { transform: translateY(0); }
    100% { transform: translateY(50px); }
}

.logo {
    font-family: 'Press Start 2P', cursive;
    font-size: 2rem;
    background: linear-gradient(45deg, #f39c12, #e74c3c, #9b59b6, #3498db);
    background-size: 400% 400%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: rainbow 3s ease infinite;
    text-shadow: 0 0 30px rgba(243, 156, 18, 0.5);
    margin-bottom: 10px;
    text-align: center;
    z-index: 1;
}
.logo-sub {
    font-size: 1rem;
    color: #f39c12;
    text-shadow: 0 0 20px #f39c12;
    margin-bottom: 30px;
    z-index: 1;
}
@keyframes rainbow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.menu-box {
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(10px);
    border: 2px solid #f39c12;
    border-radius: 20px;
    padding: 30px;
    z-index: 1;
    box-shadow: 0 0 50px rgba(243, 156, 18, 0.3);
}

input { 
    background: rgba(255,255,255,0.1); 
    border: 2px solid #444; 
    padding: 15px; 
    font-size: 16px; 
    color: white; 
    border-radius: 10px; 
    text-align: center; 
    margin: 8px 0; 
    width: 100%;
    max-width: 280px;
    transition: all 0.3s;
    font-family: 'Russo One', sans-serif;
}
input:focus {
    border-color: #f39c12;
    box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
    outline: none;
}
input::placeholder { color: #666; }

.btn { 
    background: linear-gradient(135deg, #27ae60, #2ecc71); 
    color: white; 
    border: none; 
    padding: 15px 30px; 
    font-size: 16px; 
    font-weight: bold; 
    border-radius: 10px; 
    margin-top: 10px; 
    cursor: pointer; 
    width: 100%;
    max-width: 280px;
    text-transform: uppercase;
    letter-spacing: 2px;
    box-shadow: 0 5px 0 #1e8449, 0 0 30px rgba(46, 204, 113, 0.4);
    transition: all 0.2s;
    font-family: 'Russo One', sans-serif;
}
.btn:active { 
    transform: translateY(5px); 
    box-shadow: 0 0 0 #1e8449, 0 0 30px rgba(46, 204, 113, 0.4); 
}
.btn.blue {
    background: linear-gradient(135deg, #2980b9, #3498db);
    box-shadow: 0 5px 0 #1a5276, 0 0 30px rgba(52, 152, 219, 0.4);
}
.btn.blue:active {
    box-shadow: 0 0 0 #1a5276, 0 0 30px rgba(52, 152, 219, 0.4);
}

.divider {
    color: #555;
    margin: 15px 0;
    font-size: 14px;
}

/* === HUD === */
#hud { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    pointer-events: none; display: none; 
}

.hud-bars { 
    position: absolute; top: 15px; left: 15px; 
}
.bar-container { 
    width: 200px; height: 24px; 
    background: rgba(0,0,0,0.7); 
    border: 2px solid; 
    border-radius: 12px; 
    overflow: hidden; 
    margin-bottom: 8px; 
    position: relative;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.bar-container.hp { border-color: #e74c3c; }
.bar-container.xp { border-color: #3498db; }
.bar-fill { 
    height: 100%; 
    transition: width 0.3s ease-out;
    position: relative;
}
.bar-fill.hp { 
    background: linear-gradient(180deg, #e74c3c, #c0392b);
    box-shadow: inset 0 -2px 10px rgba(0,0,0,0.3);
}
.bar-fill.xp { 
    background: linear-gradient(180deg, #3498db, #2980b9);
    box-shadow: inset 0 -2px 10px rgba(0,0,0,0.3);
}
.bar-fill::after {
    content: '';
    position: absolute;
    top: 2px; left: 5px; right: 5px; height: 6px;
    background: linear-gradient(180deg, rgba(255,255,255,0.4), transparent);
    border-radius: 3px;
}
.bar-text { 
    position: absolute; 
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; 
    font-weight: bold; 
    text-shadow: 1px 1px 2px #000;
    font-family: 'Press Start 2P', cursive;
}

.hud-inv { 
    position: absolute; top: 15px; right: 15px; 
    display: flex; gap: 8px; 
}
.inv-slot { 
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    padding: 8px 15px; 
    border-radius: 10px; 
    border: 2px solid #555; 
    font-size: 14px; 
    display: flex; 
    align-items: center; 
    gap: 8px;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
}
.inv-slot span {
    font-family: 'Press Start 2P', cursive;
    font-size: 11px;
}

/* WAVE INDICATOR */
.wave-indicator {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(155, 89, 182, 0.8), rgba(142, 68, 173, 0.8));
    padding: 8px 25px;
    border-radius: 20px;
    border: 2px solid #9b59b6;
    font-family: 'Press Start 2P', cursive;
    font-size: 12px;
    box-shadow: 0 0 20px rgba(155, 89, 182, 0.5);
}

/* BOT√ÉO CRAFTING */
#craftBtn { 
    position: absolute; 
    bottom: 120px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: linear-gradient(135deg, #8e44ad, #9b59b6); 
    display: none; 
    pointer-events: auto; 
    animation: pulse 2s infinite;
    border: 2px solid #a569bd;
    box-shadow: 0 5px 0 #6c3483, 0 0 30px rgba(155, 89, 182, 0.5);
}
@keyframes pulse { 
    0%, 100% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.05); }
}

/* === POPUPS === */
#craftMenu, #levelUp, #death { 
    z-index: 200; 
    background: rgba(0,0,0,0.95); 
    backdrop-filter: blur(10px);
}

.popup-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 1.5rem;
    margin-bottom: 20px;
    text-shadow: 0 0 20px currentColor;
}
.popup-title.gold { color: #f1c40f; }
.popup-title.white { color: #fff; }
.popup-title.red { color: #e74c3c; }

.craft-grid { 
    display: flex; 
    gap: 15px; 
    flex-wrap: wrap; 
    justify-content: center; 
    max-width: 650px;
    padding: 10px;
}
.craft-item { 
    background: linear-gradient(135deg, #2c3e50, #34495e);
    border: 2px solid #5d6d7e; 
    padding: 15px; 
    border-radius: 15px; 
    width: 140px; 
    text-align: center; 
    cursor: pointer; 
    pointer-events: auto;
    transition: all 0.3s;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.craft-item:hover, .craft-item:active {
    transform: translateY(-5px);
    border-color: #f1c40f;
    box-shadow: 0 10px 30px rgba(241, 196, 15, 0.3);
}
.craft-item .icon {
    font-size: 2rem;
    margin-bottom: 8px;
}
.craft-item h3 { 
    font-size: 11px; 
    margin: 0 0 8px 0; 
    color: #f1c40f;
    font-family: 'Press Start 2P', cursive;
}
.craft-item .cost { 
    font-size: 11px; 
    color: #95a5a6; 
}

/* CARDS DE LEVEL UP */
.cards-container { 
    display: flex; 
    gap: 15px; 
    flex-wrap: wrap; 
    justify-content: center;
    max-width: 600px;
}
.upgrade-card { 
    background: linear-gradient(135deg, #1a1a2e, #2c3e50);
    border: 3px solid #f1c40f; 
    padding: 20px; 
    border-radius: 15px; 
    width: 130px; 
    text-align: center; 
    cursor: pointer; 
    pointer-events: auto;
    transition: all 0.3s;
    box-shadow: 0 0 20px rgba(241, 196, 15, 0.3);
}
.upgrade-card:hover, .upgrade-card:active {
    transform: scale(1.1);
    box-shadow: 0 0 40px rgba(241, 196, 15, 0.6);
}
.upgrade-card .icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}
.upgrade-card h3 {
    font-size: 10px;
    color: #f1c40f;
    margin: 0 0 5px 0;
    font-family: 'Press Start 2P', cursive;
}
.upgrade-card p {
    font-size: 11px;
    color: #bdc3c7;
    margin: 0;
}

.btn.close {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    box-shadow: 0 5px 0 #922b21, 0 0 20px rgba(231, 76, 60, 0.4);
    margin-top: 25px;
    width: 180px;
}

/* MINIMAP */
#minimap { 
    position: absolute; 
    bottom: 15px;
    right: 15px; 
    border: 3px solid #f39c12; 
    border-radius: 10px; 
    background: rgba(0,0,0,0.7);
    box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
}

/* WAVE ALERT */
.wave-alert {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Press Start 2P', cursive;
    font-size: 2rem;
    color: #e74c3c;
    text-shadow: 0 0 30px #e74c3c;
    animation: waveIn 3s forwards;
    z-index: 300;
    pointer-events: none;
}
@keyframes waveIn {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    80% { opacity: 1; }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
}

canvas { display: block; }
</style>
</head>
<body>

<div id="menu" class="screen">
    <div class="logo">‚öîÔ∏è RPG LEGENDS</div>
    <div class="logo-sub">‚ú® VERS√ÉO ULTIMATE ‚ú®</div>
    
    <div class="menu-box">
        <input id="name" placeholder="üéÆ Nome do Her√≥i">
        <button class="btn" id="btnCreate">üåç CRIAR MUNDO</button>
        <div class="divider">‚Äî OU ‚Äî</div>
        <input id="code" placeholder="üîë C√≥digo da Sala">
        <button class="btn blue" id="btnJoin">üö™ ENTRAR</button>
    </div>
</div>

<div id="hud">
    <div class="hud-bars">
        <div class="bar-container hp">
            <div id="hpBar" class="bar-fill hp" style="width:100%"></div>
            <div id="hpTxt" class="bar-text">‚ù§Ô∏è 100/100</div>
        </div>
        <div class="bar-container xp">
            <div id="xpBar" class="bar-fill xp" style="width:0%"></div>
            <div id="xpTxt" class="bar-text">‚≠ê LVL 1</div>
        </div>
    </div>
    
    <div class="wave-indicator" id="waveDisplay">üåä WAVE 1</div>
    
    <div class="hud-inv">
        <div class="inv-slot">ü™µ <span id="wood">0</span></div>
        <div class="inv-slot">ü™® <span id="stone">0</span></div>
    </div>
    
    <button class="btn" id="craftBtn" onclick="openCraft()">üõ†Ô∏è CRAFTING</button>
    <canvas id="minimap" width="120" height="120"></canvas>
</div>

<div id="craftMenu" class="screen hidden">
    <div class="popup-title white">üõ†Ô∏è CONSTRU√á√ÉO</div>
    <div class="craft-grid">
        <div class="craft-item" onclick="build('table')">
            <div class="icon">üì¶</div>
            <h3>BANCADA</h3>
            <p class="cost">ü™µ 5</p>
        </div>
        <div class="craft-item" onclick="build('wall_wood')">
            <div class="icon">üß±</div>
            <h3>PAREDE</h3>
            <p class="cost">ü™µ 10</p>
        </div>
        <div class="craft-item" onclick="build('wall_stone')">
            <div class="icon">üè∞</div>
            <h3>FORTE</h3>
            <p class="cost">ü™® 10</p>
        </div>
        <div class="craft-item" onclick="build('campfire')">
            <div class="icon">üî•</div>
            <h3>FOGUEIRA</h3>
            <p class="cost">ü™µ 15 ü™® 5</p>
        </div>
        <div class="craft-item" onclick="build('turret')">
            <div class="icon">üî´</div>
            <h3>TORRETA</h3>
            <p class="cost">ü™µ 20 ü™® 10</p>
        </div>
        <div class="craft-item" onclick="build('spike')">
            <div class="icon">üó°Ô∏è</div>
            <h3>ESPINHOS</h3>
            <p class="cost">ü™µ 5 ü™® 5</p>
        </div>
    </div>
    <button class="btn close" onclick="closeCraft()">‚ùå FECHAR</button>
</div>

<div id="levelUp" class="screen hidden">
    <div class="popup-title gold">üéâ LEVEL UP!</div>
    <div class="cards-container">
        <div class="upgrade-card" onclick="up('multi')">
            <div class="icon">üî´</div>
            <h3>TRIPLO</h3>
            <p>Atira 3 proj√©teis</p>
        </div>
        <div class="upgrade-card" onclick="up('vamp')">
            <div class="icon">ü©∏</div>
            <h3>VAMPIRO</h3>
            <p>Rouba vida</p>
        </div>
        <div class="upgrade-card" onclick="up('dmg')">
            <div class="icon">‚öîÔ∏è</div>
            <h3>FOR√áA</h3>
            <p>+40% dano</p>
        </div>
        <div class="upgrade-card" onclick="up('hp')">
            <div class="icon">‚ù§Ô∏è</div>
            <h3>VIDA</h3>
            <p>Cura total +20 max</p>
        </div>
        <div class="upgrade-card" onclick="up('speed')">
            <div class="icon">üí®</div>
            <h3>SPEED</h3>
            <p>+15% velocidade</p>
        </div>
        <div class="upgrade-card" onclick="up('range')">
            <div class="icon">üéØ</div>
            <h3>ALCANCE</h3>
            <p>+20% range</p>
        </div>
    </div>
</div>

<div id="death" class="screen hidden">
    <div class="popup-title red">üíÄ VOC√ä MORREU</div>
    <p style="color:#aaa; margin: 20px 0;">Seus recursos foram perdidos...</p>
    <button class="btn" onclick="respawn()">üîÑ RENASCER</button>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üéÆ RPG LEGENDS V7 - ENGINE PRINCIPAL
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// === AUDIO CONTEXT ===
const ac = new (window.AudioContext || window.webkitAudioContext)();

function sfx(type) {
    if(ac.state === 'suspended') ac.resume();
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.connect(g);
    g.connect(ac.destination);
    const t = ac.currentTime;
    
    const sounds = {
        hit: () => { o.frequency.setValueAtTime(200, t); o.frequency.exponentialRampToValueAtTime(50, t+0.1); g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t+0.1); o.start(); o.stop(t+0.1); },
        wood: () => { o.type='square'; o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(80, t+0.08); g.gain.setValueAtTime(0.15, t); g.gain.linearRampToValueAtTime(0, t+0.08); o.start(); o.stop(t+0.08); },
        shoot: () => { o.type='sawtooth'; o.frequency.setValueAtTime(800, t); o.frequency.exponentialRampToValueAtTime(200, t+0.1); g.gain.setValueAtTime(0.08, t); g.gain.linearRampToValueAtTime(0, t+0.1); o.start(); o.stop(t+0.1); },
        levelup: () => { o.type='sine'; o.frequency.setValueAtTime(400, t); o.frequency.linearRampToValueAtTime(800, t+0.2); g.gain.setValueAtTime(0.15, t); g.gain.linearRampToValueAtTime(0, t+0.3); o.start(); o.stop(t+0.3); },
        death: () => { o.type='sawtooth'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(50, t+0.5); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.5); o.start(); o.stop(t+0.5); },
        wave: () => { o.type='square'; o.frequency.setValueAtTime(200, t); o.frequency.linearRampToValueAtTime(400, t+0.15); o.frequency.linearRampToValueAtTime(200, t+0.3); g.gain.setValueAtTime(0.15, t); g.gain.linearRampToValueAtTime(0, t+0.4); o.start(); o.stop(t+0.4); }
    };
    
    if(sounds[type]) sounds[type]();
}

// === CANVAS SETUP ===
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const mCvs = document.getElementById('minimap');
const mCtx = mCvs.getContext('2d');

function resize() {
    cvs.width = window.innerWidth;
    cvs.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

// === GAME STATE ===
let socket = io();
let myId = null, roomId = null;
let cam = {x: 0, y: 0};
let me = {x: 1500, y: 1500, wood: 0, stone: 0, hp: 100, maxHp: 100, level: 1, xp: 0};
let state = {players: {}, enemies: [], resources: [], buildings: [], orbs: [], wave: 1, time: 0};
let particles = [], texts = [], shots = [], screenShake = 0;
let joyL = {on: false, dx: 0, dy: 0}, joyR = {on: false, dx: 0, dy: 0, ang: 0};

// === NETWORKING ===
document.getElementById('btnCreate').onclick = () => {
    socket.emit('createRoom', document.getElementById('name').value || 'Her√≥i');
};
document.getElementById('btnJoin').onclick = () => {
    socket.emit('joinRoom', {
        code: document.getElementById('code').value.toUpperCase(),
        name: document.getElementById('name').value || 'Her√≥i'
    });
};

function startGame(id) {
    roomId = id;
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('hud').style.display = 'block';
}

socket.on('connect', () => myId = socket.id);
socket.on('roomCreated', startGame);
socket.on('joinedRoom', startGame);

socket.on('update', data => {
    state = data;
    if(state.players[myId]) {
        const s = state.players[myId];
        me.hp = s.hp;
        me.maxHp = s.maxHp;
        me.xp = s.xp;
        me.level = s.level;
        me.wood = s.wood;
        me.stone = s.stone;
        me.dead = s.dead;
        me.nextLevel = s.nextLevel;
        updateHUD();
    }
});

socket.on('resBreak', d => {
    sfx('wood');
    for(let i = 0; i < 10; i++) {
        particles.push({
            x: d.x, y: d.y,
            vx: (Math.random() - 0.5) * 12,
            vy: (Math.random() - 0.5) * 12 - 3,
            life: 1,
            color: d.type === 'tree' ? '#5d4037' : '#7f8c8d',
            size: 3 + Math.random() * 4
        });
    }
});

socket.on('dmg', d => {
    sfx('hit');
    texts.push({x: d.x, y: d.y, val: d.val, t: 1, crit: d.crit});
    screenShake = 5;
});

socket.on('turretShot', d => {
    shots.push({x: d.sx, y: d.sy, tx: d.ex, ty: d.ey, t: 1, color: '#00ffff'});
    sfx('shoot');
});

socket.on('enemyDeath', d => {
    for(let i = 0; i < 20; i++) {
        particles.push({
            x: d.x, y: d.y,
            vx: (Math.random() - 0.5) * 15,
            vy: (Math.random() - 0.5) * 15,
            life: 1,
            color: d.isBoss ? '#f1c40f' : '#e74c3c',
            size: d.isBoss ? 6 : 4
        });
    }
    if(d.isBoss) screenShake = 15;
});

socket.on('playerHit', d => {
    if(d.id === myId) screenShake = 8;
});

socket.on('playerDeath', name => {
    if(state.players[myId]?.dead) {
        sfx('death');
        document.getElementById('death').classList.remove('hidden');
    }
});

socket.on('levelUp', () => {
    sfx('levelup');
    document.getElementById('levelUp').classList.remove('hidden');
    
    // Efeito visual de level up
    for(let i = 0; i < 30; i++) {
        particles.push({
            x: me.x, y: me.y,
            vx: Math.cos(i / 30 * Math.PI * 2) * 8,
            vy: Math.sin(i / 30 * Math.PI * 2) * 8,
            life: 1.5,
            color: '#f1c40f',
            size: 5
        });
    }
});

socket.on('newWave', wave => {
    sfx('wave');
    document.getElementById('waveDisplay').textContent = `üåä WAVE ${wave}`;
    
    // Mostrar alerta de wave
    const alert = document.createElement('div');
    alert.className = 'wave-alert';
    alert.textContent = `WAVE ${wave}`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
});

// === INPUT HANDLING ===
cvs.addEventListener('touchstart', e => {
    e.preventDefault();
    for(let touch of e.changedTouches) {
        if(touch.clientX < window.innerWidth / 2 && !joyL.on) {
            joyL.on = true;
            joyL.id = touch.identifier;
            joyL.ox = touch.clientX;
            joyL.oy = touch.clientY;
        } else if(touch.clientX >= window.innerWidth / 2 && !joyR.on) {
            joyR.on = true;
            joyR.id = touch.identifier;
            joyR.ox = touch.clientX;
            joyR.oy = touch.clientY;
        }
    }
}, {passive: false});

cvs.addEventListener('touchmove', e => {
    e.preventDefault();
    for(let touch of e.changedTouches) {
        if(touch.identifier === joyL.id) {
            const dx = touch.clientX - joyL.ox;
            const dy = touch.clientY - joyL.oy;
            const d = Math.min(Math.hypot(dx, dy), 50);
            const a = Math.atan2(dy, dx);
            joyL.dx = Math.cos(a) * (d / 50);
            joyL.dy = Math.sin(a) * (d / 50);
        }
        if(touch.identifier === joyR.id) {
            joyR.dx = touch.clientX - joyR.ox;
            joyR.dy = touch.clientY - joyR.oy;
            joyR.ang = Math.atan2(joyR.dy, joyR.dx);
        }
    }
}, {passive: false});

cvs.addEventListener('touchend', e => {
    e.preventDefault();
    for(let touch of e.changedTouches) {
        if(touch.identifier === joyL.id) {
            joyL.on = false;
            joyL.dx = 0;
            joyL.dy = 0;
        }
        if(touch.identifier === joyR.id) {
            joyR.on = false;
        }
    }
}, {passive: false});

// === HUD UPDATE ===
function updateHUD() {
    const hpPercent = (me.hp / me.maxHp) * 100;
    const xpPercent = (me.xp / me.nextLevel) * 100;
    
    document.getElementById('hpBar').style.width = hpPercent + '%';
    document.getElementById('hpTxt').textContent = `‚ù§Ô∏è ${Math.floor(me.hp)}/${me.maxHp}`;
    document.getElementById('xpBar').style.width = xpPercent + '%';
    document.getElementById('xpTxt').textContent = `‚≠ê LVL ${me.level}`;
    document.getElementById('wood').textContent = me.wood;
    document.getElementById('stone').textContent = me.stone;
    
    // Mostrar bot√£o de craft se tiver recursos
    document.getElementById('craftBtn').style.display = (me.wood >= 5 || me.stone >= 5) ? 'block' : 'none';
}

// === DRAWING FUNCTIONS ===
function drawGradientCircle(x, y, r, colors) {
    const grad = ctx.createRadialGradient(x, y - r * 0.3, 0, x, y, r);
    colors.forEach((c, i) => grad.addColorStop(i / (colors.length - 1), c));
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
}

function drawShadow(x, y, rx, ry) {
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(x, y, rx, ry, 0, 0, Math.PI * 2);
    ctx.fill();
}

function drawResource(r) {
    const wobble = Math.sin(Date.now() / 500 + r.x * 0.1) * 3;
    
    drawShadow(r.x, r.y + 10, 20, 8);
    
    if(r.type === 'tree') {
        // Tronco com gradiente
        const trunkGrad = ctx.createLinearGradient(r.x - 8, 0, r.x + 8, 0);
        trunkGrad.addColorStop(0, '#3e2723');
        trunkGrad.addColorStop(0.5, '#6d4c41');
        trunkGrad.addColorStop(1, '#3e2723');
        ctx.fillStyle = trunkGrad;
        ctx.fillRect(r.x - 8, r.y - 15, 16, 30);
        
        // Copa da √°rvore (m√∫ltiplas camadas)
        const colors = r.variant === 0 ? ['#4caf50', '#2e7d32'] : 
                       r.variant === 1 ? ['#8bc34a', '#558b2f'] : ['#009688', '#00695c'];
        
        drawGradientCircle(r.x + wobble, r.y - 35, 28, colors);
        drawGradientCircle(r.x - 12 + wobble, r.y - 20, 18, colors);
        drawGradientCircle(r.x + 12 + wobble, r.y - 20, 18, colors);
        
        // Brilho
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath();
        ctx.arc(r.x - 8 + wobble, r.y - 40, 8, 0, Math.PI * 2);
        ctx.fill();
    } else {
        // Pedra com gradiente 3D
        const stoneGrad = ctx.createRadialGradient(r.x - 5, r.y - 10, 0, r.x, r.y, 25);
        stoneGrad.addColorStop(0, '#bdc3c7');
        stoneGrad.addColorStop(0.5, '#7f8c8d');
        stoneGrad.addColorStop(1, '#5d6d7e');
        ctx.fillStyle = stoneGrad;
        
        ctx.beginPath();
        ctx.arc(r.x, r.y, 22, 0, Math.PI * 2);
        ctx.fill();
        
        // Detalhes
        ctx.fillStyle = '#95a5a6';
        ctx.beginPath();
        ctx.arc(r.x - 8, r.y - 8, 10, 0, Math.PI * 2);
        ctx.fill();
        
        // Brilho
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.beginPath();
        ctx.arc(r.x - 10, r.y - 12, 5, 0, Math.PI * 2);
        ctx.fill();
    }
}

function drawEnemy(e) {
    if(e.dead) return;
    
    const bob = Math.sin(Date.now() / 100 + e.x) * 4;
    const pulse = e.isBoss ? 1 + Math.sin(Date.now() / 200) * 0.1 : 1;
    
    drawShadow(e.x, e.y + 5, 20 * pulse, 10);
    
    ctx.save();
    ctx.translate(e.x, e.y);
    
    // Aura de boss
    if(e.isBoss) {
        ctx.shadowBlur = 30;
        ctx.shadowColor = e.color;
    }
    
    // Corpo baseado no tipo
    const size = (e.isBoss ? 35 : 25) * pulse;
    
    if(e.type === 'slime') {
        // Slime gelatinoso
        const squish = 1 + Math.sin(Date.now() / 150) * 0.2;
        drawGradientCircle(0, -10 - bob, size * squish, ['#58d68d', '#27ae60', '#1e8449']);
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.beginPath();
        ctx.ellipse(-size * 0.3, -15 - bob, size * 0.2, size * 0.15, 0, 0, Math.PI * 2);
        ctx.fill();
    } else if(e.type === 'goblin') {
        // Corpo verde
        drawGradientCircle(0, -15 - bob, size, ['#52be80', '#229954', '#1e8449']);
        // Orelhas pontudas
        ctx.fillStyle = '#27ae60';
        ctx.beginPath();
        ctx.moveTo(-size, -15 - bob);
        ctx.lineTo(-size - 10, -35 - bob);
        ctx.lineTo(-size + 5, -20 - bob);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(size, -15 - bob);
        ctx.lineTo(size + 10, -35 - bob);
        ctx.lineTo(size - 5, -20 - bob);
        ctx.fill();
    } else if(e.type === 'skeleton') {
        // Cr√¢nio
        drawGradientCircle(0, -15 - bob, size, ['#fdfefe', '#d5dbdb', '#aeb6bf']);
        // Olhos vazios
        ctx.fillStyle = '#1a1a1a';
        ctx.beginPath();
        ctx.ellipse(-8, -18 - bob, 6, 8, 0, 0, Math.PI * 2);
        ctx.ellipse(8, -18 - bob, 6, 8, 0, 0, Math.PI * 2);
        ctx.fill();
    } else if(e.type === 'demon') {
        // Corpo vermelho ardente
        drawGradientCircle(0, -15 - bob, size, ['#f5b041', '#e74c3c', '#922b21']);
        // Chifres
        ctx.fillStyle = '#1a1a1a';
        ctx.beginPath();
        ctx.moveTo(-12, -30 - bob);
        ctx.lineTo(-8, -50 - bob);
        ctx.lineTo(-4, -30 - bob);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(12, -30 - bob);
        ctx.lineTo(8, -50 - bob);
        ctx.lineTo(4, -30 - bob);
        ctx.fill();
    } else if(e.type === 'ghost') {
        // Fantasma transl√∫cido
        ctx.globalAlpha = 0.7 + Math.sin(Date.now() / 200) * 0.2;
        drawGradientCircle(0, -15 - bob, size, ['#d2b4de', '#9b59b6', '#7d3c98']);
        // Cauda ondulada
        ctx.fillStyle = '#9b59b6';
        ctx.beginPath();
        for(let i = 0; i < 3; i++) {
            const wave = Math.sin(Date.now() / 100 + i) * 5;
            ctx.ellipse(-15 + i * 15, 10 + wave, 8, 15, 0, 0, Math.PI * 2);
        }
        ctx.fill();
        ctx.globalAlpha = 1;
    }
    
    // Olhos (exceto skeleton)
    if(e.type !== 'skeleton' && e.type !== 'ghost') {
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(-7 + e.facing * 2, -18 - bob, 6, 0, Math.PI * 2);
        ctx.arc(7 + e.facing * 2, -18 - bob, 6, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#c0392b';
        ctx.beginPath();
        ctx.arc(-7 + e.facing * 3, -18 - bob, 3, 0, Math.PI * 2);
        ctx.arc(7 + e.facing * 3, -18 - bob, 3, 0, Math.PI * 2);
        ctx.fill();
    }
    
    ctx.restore();
    
    // Barra de HP
    const barWidth = e.isBoss ? 60 : 40;
    const hpPercent = e.hp / e.maxHp;
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(e.x - barWidth/2, e.y - 50, barWidth, 8);
    ctx.fillStyle = hpPercent > 0.5 ? '#2ecc71' : hpPercent > 0.25 ? '#f39c12' : '#e74c3c';
    ctx.fillRect(e.x - barWidth/2, e.y - 50, barWidth * hpPercent, 8);
    
    // Label de boss
    if(e.isBoss) {
        ctx.fillStyle = '#f1c40f';
        ctx.font = 'bold 12px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillText('‚≠ê BOSS', e.x, e.y - 60);
    }
}

function drawPlayer(p, x, y, isMe) {
    const wobble = p.state === 'run' ? Math.sin(Date.now() / 80) * 4 : 0;
    const breathe = Math.sin(Date.now() / 400) * 2;
    
    drawShadow(x, y + 15, 18, 8);
    
    ctx.save();
    ctx.translate(x, y + wobble);
    
    // Aura do jogador (se tiver upgrades)
    if(isMe && me.level > 1) {
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#f1c40f';
    }
    
    // P√©s com anima√ß√£o
    ctx.fillStyle = '#2c3e50';
    ctx.beginPath();
    ctx.arc(-10, 15 - wobble, 7, 0, Math.PI * 2);
    ctx.arc(10, 15 + wobble, 7, 0, Math.PI * 2);
    ctx.fill();
    
    // Corpo
    const bodyGrad = ctx.createLinearGradient(-15, -20, 15, 10);
    if(p.role === 'warrior') {
        bodyGrad.addColorStop(0, '#5dade2');
        bodyGrad.addColorStop(1, '#2874a6');
    } else {
        bodyGrad.addColorStop(0, '#af7ac5');
        bodyGrad.addColorStop(1, '#7d3c98');
    }
    ctx.fillStyle = bodyGrad;
    ctx.beginPath();
    ctx.roundRect(-15, -18 + breathe, 30, 32, 8);
    ctx.fill();
    
    // Detalhes do corpo
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(-10, -10 + breathe);
    ctx.lineTo(-10, 10 + breathe);
    ctx.moveTo(10, -10 + breathe);
    ctx.lineTo(10, 10 + breathe);
    ctx.stroke();
    
    // Cabe√ßa
    drawGradientCircle(0, -28 + breathe, 16, ['#f5d79e', '#f0b27a', '#dc7633']);
    
    // Cabelo/Capacete
    if(p.role === 'warrior') {
        ctx.fillStyle = '#7f8c8d';
        ctx.beginPath();
        ctx.arc(0, -28 + breathe, 17, Math.PI, 0);
        ctx.fill();
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.ellipse(0, -45 + breathe, 4, 8, 0, 0, Math.PI * 2);
        ctx.fill();
    } else {
        ctx.fillStyle = '#8e44ad';
        ctx.beginPath();
        ctx.moveTo(-18, -28 + breathe);
        ctx.lineTo(0, -55 + breathe);
        ctx.lineTo(18, -28 + breathe);
        ctx.fill();
        ctx.fillStyle = '#f1c40f';
        ctx.beginPath();
        ctx.arc(0, -55 + breathe, 5, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // Olhos
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.ellipse(-5, -30 + breathe, 4, 5, 0, 0, Math.PI * 2);
    ctx.ellipse(5, -30 + breathe, 4, 5, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#2c3e50';
    ctx.beginPath();
    ctx.arc(-5 + p.facing * 2, -30 + breathe, 2, 0, Math.PI * 2);
    ctx.arc(5 + p.facing * 2, -30 + breathe, 2, 0, Math.PI * 2);
    ctx.fill();
    
    // Arma
    ctx.rotate(p.angle || 0);
    if(p.role === 'warrior') {
        // Espada √©pica
        const swordGrad = ctx.createLinearGradient(15, 0, 50, 0);
        swordGrad.addColorStop(0, '#bdc3c7');
        swordGrad.addColorStop(0.5, '#ecf0f1');
        swordGrad.addColorStop(1, '#95a5a6');
        ctx.fillStyle = swordGrad;
        ctx.fillRect(20, -4, 35, 8);
        ctx.fillStyle = '#f39c12';
        ctx.fillRect(15, -8, 8, 16);
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.arc(19, 0, 3, 0, Math.PI * 2);
        ctx.fill();
    } else {
        // Cajado m√°gico
        ctx.fillStyle = '#6c3483';
        ctx.fillRect(18, -3, 35, 6);
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#e74c3c';
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.arc(55, 0, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }
    
    ctx.restore();
    
    // Nome
    ctx.fillStyle = isMe ? '#f1c40f' : '#fff';
    ctx.font = 'bold 12px "Russo One"';
    ctx.textAlign = 'center';
    ctx.fillText(p.name, x, y - 55);
    
    // N√≠vel
    ctx.fillStyle = '#3498db';
    ctx.font = '10px "Press Start 2P"';
    ctx.fillText(`Lv${p.level}`, x, y - 65);
}

function drawBuilding(b) {
    ctx.save();
    ctx.translate(b.x, b.y);
    
    drawShadow(0, 15, 25, 10);
    
    if(b.type === 'table') {
        ctx.fillStyle = '#5d4037';
        ctx.fillRect(-25, -5, 50, 20);
        ctx.fillStyle = '#8d6e63';
        ctx.fillRect(-20, -10, 40, 8);
        ctx.fillStyle = '#4e342e';
        ctx.fillRect(-20, 10, 8, 15);
        ctx.fillRect(12, 10, 8, 15);
    } else if(b.type === 'campfire') {
        // Pedras
        ctx.fillStyle = '#5d6d7e';
        for(let i = 0; i < 6; i++) {
            ctx.beginPath();
            ctx.arc(Math.cos(i / 6 * Math.PI * 2) * 18, Math.sin(i / 6 * Math.PI * 2) * 10, 8, 0, Math.PI * 2);
            ctx.fill();
        }
        // Fogo animado
        const flicker = Math.random() * 5;
        ctx.shadowBlur = 30;
        ctx.shadowColor = '#e67e22';
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.ellipse(0, -10, 12 + flicker, 20 + flicker, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#f39c12';
        ctx.beginPath();
        ctx.ellipse(0, -5, 8 + flicker * 0.5, 15 + flicker * 0.5, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#f1c40f';
        ctx.beginPath();
        ctx.ellipse(0, 0, 4, 8, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    } else if(b.type === 'turret') {
        ctx.fillStyle = '#5d6d7e';
        ctx.fillRect(-15, -10, 30, 25);
        ctx.fillStyle = '#2c3e50';
        ctx.fillRect(-20, 10, 40, 10);
        ctx.fillStyle = '#7f8c8d';
        ctx.fillRect(10, -5, 20, 10);
    } else if(b.type === 'spike') {
        ctx.fillStyle = '#7f8c8d';
        for(let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.moveTo(-20 + i * 10, 10);
            ctx.lineTo(-15 + i * 10, -15);
            ctx.lineTo(-10 + i * 10, 10);
            ctx.fill();
        }
    } else {
        // Paredes
        const isStone = b.type === 'wall_stone';
        const wallGrad = ctx.createLinearGradient(-25, -25, 25, 25);
        if(isStone) {
            wallGrad.addColorStop(0, '#95a5a6');
            wallGrad.addColorStop(1, '#5d6d7e');
        } else {
            wallGrad.addColorStop(0, '#a1887f');
            wallGrad.addColorStop(1, '#6d4c41');
        }
        ctx.fillStyle = wallGrad;
        ctx.fillRect(-25, -25, 50, 50);
        ctx.strokeStyle = isStone ? '#2c3e50' : '#4e342e';
        ctx.lineWidth = 3;
        ctx.strokeRect(-25, -25, 50, 50);
    }
    
    ctx.restore();
}

function drawOrb(o) {
    const pulse = 1 + Math.sin(Date.now() / 150 + o.x) * 0.3;
    ctx.shadowBlur = 15;
    ctx.shadowColor = '#00ffff';
    ctx.fillStyle = '#00ffff';
    ctx.beginPath();
    ctx.arc(o.x, o.y, 6 * pulse, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
}

// === MAIN GAME LOOP ===
let lastShot = 0;

function loop() {
    requestAnimationFrame(loop);
    if(!roomId) return;
    
    const speedMult = 1 + (state.players[myId]?.upgrades?.speed || 0) * 0.15;
    
    // Movimento
    if(joyL.on && !me.dead) {
        me.x += joyL.dx * 6 * speedMult;
        me.y += joyL.dy * 6 * speedMult;
        me.x = Math.max(50, Math.min(2950, me.x));
        me.y = Math.max(50, Math.min(2950, me.y));
    }
    
    // Auto-aim
    let aim = joyR.on ? joyR.ang : null;
    if(!aim) {
        let minDist = 300, target = null;
        state.enemies.forEach(e => {
            if(e.dead) return;
            const d = Math.hypot(e.x - me.x, e.y - me.y);
            if(d < minDist) { minDist = d; target = e; }
        });
        if(target) aim = Math.atan2(target.y - me.y, target.x - me.x);
    }
    
    // C√¢mera suave com shake
    const shakeX = screenShake > 0 ? (Math.random() - 0.5) * screenShake : 0;
    const shakeY = screenShake > 0 ? (Math.random() - 0.5) * screenShake : 0;
    cam.x += (me.x - cam.x - cvs.width/2 + shakeX) * 0.08;
    cam.y += (me.y - cam.y - cvs.height/2 + shakeY) * 0.08;
    if(screenShake > 0) screenShake -= 0.5;
    
    // Enviar dados pro servidor
    socket.emit('move', {
        roomId,
        x: me.x,
        y: me.y,
        state: joyL.on ? 'run' : 'idle',
        facing: joyL.dx > 0 ? 1 : -1,
        angle: aim || 0
    });
    
    // Atirar
    if((joyR.on || aim !== null) && Date.now() - lastShot > 250 && !me.dead) {
        lastShot = Date.now();
        socket.emit('attack', {roomId, angle: aim});
        sfx('shoot');
        
        // Efeito de tiro
        shots.push({
            x: me.x + Math.cos(aim) * 30,
            y: me.y + Math.sin(aim) * 30,
            tx: me.x + Math.cos(aim) * 250,
            ty: me.y + Math.sin(aim) * 250,
            t: 1,
            color: '#f1c40f'
        });
    }
    
    // === RENDERIZA√á√ÉO ===
    
    // Calcular ciclo dia/noite
    const dayNight = state.time / 300000; // 0 a 1
    const brightness = 0.5 + Math.cos(dayNight * Math.PI * 2) * 0.3;
    
    // Background com gradiente
    const bgGrad = ctx.createLinearGradient(0, 0, 0, cvs.height);
    bgGrad.addColorStop(0, `rgba(30, 39, 46, ${1 - brightness * 0.3})`);
    bgGrad.addColorStop(1, `rgba(20, 29, 36, 1)`);
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, cvs.width, cvs.height);
    
    ctx.save();
    ctx.translate(-cam.x, -cam.y);
    
    // Grid do ch√£o
    const TILE = 80;
    const startX = Math.floor(cam.x / TILE) * TILE;
    const startY = Math.floor(cam.y / TILE) * TILE;
    
    for(let x = startX; x < cam.x + cvs.width + TILE; x += TILE) {
        for(let y = startY; y < cam.y + cvs.height + TILE; y += TILE) {
            const variation = Math.sin(x * 0.01) * Math.cos(y * 0.01);
            const baseGreen = Math.floor(100 + variation * 30);
            ctx.fillStyle = `rgb(${baseGreen * 0.4}, ${baseGreen}, ${baseGreen * 0.3})`;
            ctx.fillRect(x, y, TILE - 1, TILE - 1);
            
            // Grama detalhada
            if(Math.random() > 0.7) {
                ctx.fillStyle = `rgba(${baseGreen * 0.5}, ${baseGreen + 20}, ${baseGreen * 0.4}, 0.5)`;
                ctx.fillRect(x + Math.random() * TILE, y + Math.random() * TILE, 3, 8);
            }
        }
    }
    
    // Objetos do jogo
    state.resources.forEach(r => drawResource(r));
    state.buildings.forEach(b => drawBuilding(b));
    state.orbs.forEach(o => drawOrb(o));
    state.enemies.forEach(e => drawEnemy(e));
    
    // Jogadores
    for(const id in state.players) {
        const p = state.players[id];
        if(p.dead) continue;
        const x = id === myId ? me.x : p.x;
        const y = id === myId ? me.y : p.y;
        drawPlayer(p, x, y, id === myId);
    }
    
    // Part√≠culas
    particles = particles.filter(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.3; // Gravidade
        p.life -= 0.03;
        
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        
        return p.life > 0;
    });
    
    // Textos de dano
    texts = texts.filter(t => {
        t.y -= 2;
        t.t -= 0.03;
        
        ctx.globalAlpha = t.t;
        ctx.font = t.crit ? 'bold 28px "Press Start 2P"' : 'bold 18px "Russo One"';
        ctx.fillStyle = t.crit ? '#f1c40f' : '#fff';
        ctx.textAlign = 'center';
        ctx.fillText((t.crit ? 'üí• ' : '') + t.val, t.x, t.y);
        ctx.globalAlpha = 1;
        
        return t.t > 0;
    });
    
    // Tiros
    shots = shots.filter(s => {
        s.t -= 0.08;
        
        ctx.globalAlpha = s.t;
        ctx.strokeStyle = s.color;
        ctx.lineWidth = 4;
        ctx.shadowBlur = 10;
        ctx.shadowColor = s.color;
        ctx.beginPath();
        ctx.moveTo(s.x, s.y);
        ctx.lineTo(s.tx, s.ty);
        ctx.stroke();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
        
        return s.t > 0;
    });
    
    ctx.restore();
    
    // === UI OVERLAY ===
    
    // Joystick esquerdo (movimento)
    if(joyL.on) {
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(joyL.ox, joyL.oy, 50, 0, Math.PI * 2);
        ctx.stroke();
        
        const jGrad = ctx.createRadialGradient(joyL.ox + joyL.dx * 50, joyL.oy + joyL.dy * 50, 0, joyL.ox + joyL.dx * 50, joyL.oy + joyL.dy * 50, 25);
        jGrad.addColorStop(0, 'rgba(255,255,255,0.8)');
        jGrad.addColorStop(1, 'rgba(255,255,255,0.3)');
        ctx.fillStyle = jGrad;
        ctx.beginPath();
        ctx.arc(joyL.ox + joyL.dx * 50, joyL.oy + joyL.dy * 50, 25, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // Joystick direito (mira)
    if(joyR.on) {
        ctx.strokeStyle = 'rgba(255,100,100,0.3)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(joyR.ox, joyR.oy, 50, 0, Math.PI * 2);
        ctx.stroke();
        
        const aGrad = ctx.createRadialGradient(joyR.ox + Math.cos(joyR.ang) * 50, joyR.oy + Math.sin(joyR.ang) * 50, 0, joyR.ox + Math.cos(joyR.ang) * 50, joyR.oy + Math.sin(joyR.ang) * 50, 25);
        aGrad.addColorStop(0, 'rgba(255,100,100,0.8)');
        aGrad.addColorStop(1, 'rgba(255,100,100,0.3)');
        ctx.fillStyle = aGrad;
        ctx.beginPath();
        ctx.arc(joyR.ox + Math.cos(joyR.ang) * 50, joyR.oy + Math.sin(joyR.ang) * 50, 25, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // === MINIMAP ===
    mCtx.fillStyle = 'rgba(0,0,0,0.8)';
    mCtx.fillRect(0, 0, 120, 120);
    
    const scale = 120 / 3000;
    
    // Recursos no minimap
    state.resources.forEach(r => {
        mCtx.fillStyle = r.type === 'tree' ? '#2ecc71' : '#7f8c8d';
        mCtx.fillRect(r.x * scale, r.y * scale, 2, 2);
    });
    
    // Inimigos no minimap
    state.enemies.forEach(e => {
        if(e.dead) return;
        mCtx.fillStyle = e.isBoss ? '#f1c40f' : '#e74c3c';
        mCtx.beginPath();
        mCtx.arc(e.x * scale, e.y * scale, e.isBoss ? 4 : 2, 0, Math.PI * 2);
        mCtx.fill();
    });
    
    // Jogadores no minimap
    for(const id in state.players) {
        const p = state.players[id];
        if(p.dead) continue;
        mCtx.fillStyle = id === myId ? '#f1c40f' : '#3498db';
        mCtx.beginPath();
        mCtx.arc(p.x * scale, p.y * scale, 4, 0, Math.PI * 2);
        mCtx.fill();
    }
    
    // Borda do minimap
    mCtx.strokeStyle = '#f39c12';
    mCtx.lineWidth = 2;
    mCtx.strokeRect(0, 0, 120, 120);
}

loop();

// === UI FUNCTIONS ===
function openCraft() {
    document.getElementById('craftMenu').classList.remove('hidden');
}

function closeCraft() {
    document.getElementById('craftMenu').classList.add('hidden');
}

function build(type) {
    socket.emit('build', {roomId, type});
    closeCraft();
}

function up(choice) {
    socket.emit('levelup', {roomId, choice});
    document.getElementById('levelUp').classList.add('hidden');
}

function respawn() {
    socket.emit('respawn', roomId);
    document.getElementById('death').classList.add('hidden');
    me.x = 1500;
    me.y = 1500;
}
</script>
</body>
    </html>
