<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>coop game</title>
<script src="/socket.io/socket.io.js"></script>
<style>
html,body{
  margin:0;
  padding:0;
  background:#0f172a;
  overflow:hidden;
  touch-action:none;
  font-family:sans-serif;
}
canvas{display:block}
#ui{
  position:fixed;
  top:10px;left:10px;right:10px;
  display:flex;
  gap:6px;
  z-index:10;
}
#ui input,#ui button{
  padding:6px;
  border-radius:6px;
  border:none;
}
#menu{
  position:fixed;
  inset:0;
  background:#020617;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:16px;
  z-index:20;
}
.classBtn{
  padding:14px 22px;
  font-size:18px;
  border-radius:10px;
  border:none;
}
#atk{
  position:fixed;
  right:24px;
  bottom:24px;
  width:80px;
  height:80px;
  border-radius:50%;
  background:#ef4444;
  color:white;
  font-size:18px;
  border:none;
}
</style>
</head>

<body>

<!-- MENU -->
<div id="menu">
  <h2 style="color:white">Escolha sua classe</h2>
  <button class="classBtn" onclick="chooseClass('warrior')">⚔️ Guerreiro</button>
  <button class="classBtn" onclick="chooseClass('mage')">✨ Mago</button>
</div>

<!-- UI SALA -->
<div id="ui">
  <button id="create">Criar sala</button>
  <input id="roomInput" placeholder="Sala">
  <button id="join">Entrar</button>
  <span id="roomLabel"></span>
</div>

<canvas id="game"></canvas>
<button id="atk">ATK</button>

<script>
const socket = io()

const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();addEventListener("resize",resize)

// ---------- STATE ----------
let myId=null
let roomId=null
let myClass=null
let players={}
let smoothPlayers={}
let enemies=[]
let local={x:0,y:0,hp:100}
const SPEED=4

// ---------- MENU ----------
function chooseClass(c){
  myClass=c
  document.getElementById("menu").style.display="none"
}

// ---------- SOCKET ----------
socket.on("connect",()=>myId=socket.id)

create.onclick=()=>socket.emit("createRoom")
join.onclick=()=>{
  const id=roomInput.value.trim()
  if(id) socket.emit("joinRoom",id)
}

socket.on("roomCreated",id=>{
  roomId=id
  roomLabel.textContent="Sala: "+id
})

socket.on("updatePlayers",data=>{
  players=data
  for(const id in players){
    if(!smoothPlayers[id]){
      smoothPlayers[id]={x:players[id].x,y:players[id].y}
    }
  }
  if(players[myId]){
    local.x=players[myId].x
    local.y=players[myId].y
    local.hp=players[myId].hp
  }
})

// ---------- INPUT ----------
let joy={x:0,y:0}
canvas.addEventListener("pointerdown",e=>{
  joy.x=e.clientX
  joy.y=e.clientY
})

// ---------- INIMIGOS ----------
function spawnEnemy(){
  enemies.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    hp:40,
    speed:1.4,
    lastHit:0
  })
}
setInterval(spawnEnemy,2000)

// ---------- ATAQUE ----------
atk.onclick=()=>{
  enemies.forEach(e=>{
    const dx=e.x-local.x
    const dy=e.y-local.y
    const dist=Math.hypot(dx,dy)
    const range=myClass==="mage"?90:50
    const dmg=myClass==="mage"?6:12
    if(dist<range) e.hp-=dmg
  })
  enemies=enemies.filter(e=>e.hp>0)
}

// ---------- LOOP ----------
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height)

  // movimento local
  if(roomId){
    local.x+=Math.sign(joy.x-canvas.width/2)*SPEED
    local.y+=Math.sign(joy.y-canvas.height/2)*SPEED
    socket.emit("move",{roomId,x:local.x,y:local.y})
  }

  // interpolação players
  for(const id in smoothPlayers){
    if(players[id]){
      smoothPlayers[id].x+=(players[id].x-smoothPlayers[id].x)*0.15
      smoothPlayers[id].y+=(players[id].y-smoothPlayers[id].y)*0.15
    }
  }

  // draw players
  for(const id in smoothPlayers){
    const p=id===myId?local:smoothPlayers[id]
    ctx.fillStyle=id===myId?"#38bdf8":"#22c55e"
    ctx.beginPath()
    ctx.arc(p.x,p.y,14,0,Math.PI*2)
    ctx.fill()
  }

  // inimigos IA
  enemies.forEach(e=>{
    const dx=local.x-e.x
    const dy=local.y-e.y
    const d=Math.hypot(dx,dy)
    e.x+=dx/d*e.speed
    e.y+=dy/d*e.speed

    if(d<28 && performance.now()-e.lastHit>800){
      local.hp-=10
      e.lastHit=performance.now()
    }

    ctx.fillStyle="red"
    ctx.beginPath()
    ctx.arc(e.x,e.y,12,0,Math.PI*2)
    ctx.fill()
  })

  // hp
  ctx.fillStyle="red"
  ctx.fillRect(local.x-20,local.y-28,(local.hp/100)*40,5)

  requestAnimationFrame(loop)
}
loop()
</script>
</body>
</html>
