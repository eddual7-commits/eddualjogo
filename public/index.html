<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>eddual arena</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: #0b0d14;
  color: white;
  font-family: system-ui, Arial, sans-serif;
  overflow: hidden;
}

/* menu */
#menu {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  z-index: 10;
}

button, input {
  padding: 6px 8px;
  font-size: 14px;
  background: #1a1d2a;
  color: white;
  border: 1px solid #333;
  border-radius: 6px;
}

#roomCode {
  font-weight: bold;
}

/* jogo */
#gameWrapper {
  position: fixed;
  inset: 0;
}

canvas {
  display: block;
}

/* minimapa */
#minimap {
  position: fixed;
  top: 12px;
  right: 12px;
  width: 130px;
  height: 130px;
  background: #0a0c12;
  border: 2px solid #2a2e44;
  border-radius: 6px;
}
</style>
</head>

<body>

<div id="menu">
  <span id="roomCode"></span>
  <button id="createBtn">Criar sala</button>
  <input id="roomInput" placeholder="CÃ³digo">
  <button id="joinBtn">Entrar</button>
</div>

<div id="gameWrapper">
  <canvas id="game"></canvas>
  <canvas id="minimap"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
/* =====================================================
   SETUP
===================================================== */
const socket = io()

const canvas = document.getElementById("game")
const ctx = canvas.getContext("2d")

const minimap = document.getElementById("minimap")
const mctx = minimap.getContext("2d")

function resize() {
  canvas.width = innerWidth
  canvas.height = innerHeight
}
resize()
addEventListener("resize", resize)

/* =====================================================
   ESTADO
===================================================== */
let roomId = null
let players = {}
let myId = null

let localPlayer = { x: 1200, y: 1200 }
let localInit = false

const WORLD = { width: 2400, height: 2400 }
let camera = { x: 0, y: 0 }

/* =====================================================
   UI / SOCKET
===================================================== */
const createBtn = document.getElementById("createBtn")
const joinBtn = document.getElementById("joinBtn")
const roomInput = document.getElementById("roomInput")
const roomCode = document.getElementById("roomCode")

socket.on("connect", () => myId = socket.id)

createBtn.onclick = () => socket.emit("createRoom")

joinBtn.onclick = () => {
  const code = roomInput.value.trim()
  if (!code) return
  roomId = code
  roomCode.innerText = "Sala: " + code
  socket.emit("joinRoom", code)
}

socket.on("roomCreated", id => {
  roomId = id
  roomCode.innerText = "Sala: " + id
  roomInput.value = id
})

socket.on("updatePlayers", data => {
  players = data
  if (!localInit && players[myId]) {
    localPlayer.x = players[myId].x
    localPlayer.y = players[myId].y
    localInit = true
  }
})

/* =====================================================
   FADINHAS
===================================================== */
const fairies = [
  { angle: 0, dist: 26, speed: 0.04, color: "#b36bff" },
  { angle: Math.PI, dist: 26, speed: -0.04, color: "#6be1ff" }
]

function updateFairies() {
  fairies.forEach(f => f.angle += f.speed)
}

function drawFairies(p) {
  fairies.forEach(f => {
    const x = p.x + Math.cos(f.angle) * f.dist
    const y = p.y + Math.sin(f.angle) * f.dist

    ctx.globalAlpha = 0.8
    ctx.fillStyle = f.color
    ctx.beginPath()
    ctx.arc(x, y, 4.5, 0, Math.PI * 2)
    ctx.fill()

    ctx.globalAlpha = 0.2
    ctx.beginPath()
    ctx.arc(x, y, 10, 0, Math.PI * 2)
    ctx.fill()

    ctx.globalAlpha = 1
  })
}

/* =====================================================
   FUNDO (GRID REAL)
===================================================== */
function drawBackground() {
  const grid = 120
  ctx.strokeStyle = "#171a26"
  ctx.lineWidth = 1

  const startX = Math.floor(camera.x / grid) * grid
  const startY = Math.floor(camera.y / grid) * grid

  for (let x = startX; x < camera.x + canvas.width; x += grid) {
    ctx.beginPath()
    ctx.moveTo(x, camera.y)
    ctx.lineTo(x, camera.y + canvas.height)
    ctx.stroke()
  }

  for (let y = startY; y < camera.y + canvas.height; y += grid) {
    ctx.beginPath()
    ctx.moveTo(camera.x, y)
    ctx.lineTo(camera.x + canvas.width, y)
    ctx.stroke()
  }
}

/* =====================================================
   LOOP
===================================================== */
let sendTimer = 0

function loop(dt) {
  ctx.clearRect(0, 0, canvas.width, canvas.height)

  /* movimento local */
  if (roomId && window.joystick) {
    const speed = 5
    localPlayer.x += window.joystick.dx * speed
    localPlayer.y += window.joystick.dy * speed

    localPlayer.x = Math.max(0, Math.min(WORLD.width, localPlayer.x))
    localPlayer.y = Math.max(0, Math.min(WORLD.height, localPlayer.y))
  }

  /* envio pro server (intervalo fixo) */
  sendTimer += dt
  if (sendTimer > 80 && roomId) {
    sendTimer = 0
    socket.emit("move", {
      roomId,
      x: localPlayer.x,
      y: localPlayer.y
    })
  }

  /* camera suave */
  camera.x += (localPlayer.x - camera.x - canvas.width / 2) * 0.12
  camera.y += (localPlayer.y - camera.y - canvas.height / 2) * 0.12

  ctx.save()
  ctx.translate(-camera.x, -camera.y)

  drawBackground()

  /* players */
  for (const id in players) {
    const p = id === myId ? localPlayer : players[id]

    ctx.fillStyle = "rgba(0,0,0,0.35)"
    ctx.beginPath()
    ctx.ellipse(p.x, p.y + 12, 12, 4, 0, 0, Math.PI * 2)
    ctx.fill()

    if (id !== myId) ctx.globalAlpha = 0.55

    ctx.fillStyle = id === myId ? "#5aa9ff" : "#ffb86b"
    ctx.beginPath()
    ctx.arc(p.x, p.y, 12, 0, Math.PI * 2)
    ctx.fill()

    ctx.globalAlpha = 1

    if (id === myId) {
      updateFairies()
      drawFairies(p)
    }
  }

  ctx.restore()

  /* minimapa */
  mctx.clearRect(0, 0, minimap.width, minimap.height)
  mctx.fillStyle = "#0d0f17"
  mctx.fillRect(0, 0, minimap.width, minimap.height)

  for (const id in players) {
    const p = id === myId ? localPlayer : players[id]
    const mx = (p.x / WORLD.width) * minimap.width
    const my = (p.y / WORLD.height) * minimap.height
    mctx.fillStyle = id === myId ? "#5aa9ff" : "#ffb86b"
    mctx.fillRect(mx - 2, my - 2, 4, 4)
  }

  requestAnimationFrame(ts => loop(ts - (dt || ts)))
}

requestAnimationFrame(loop)
</script>

<script src="js/joystick.js"></script>

</body>
</html>
