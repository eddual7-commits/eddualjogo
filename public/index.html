<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Legends: Reborn</title>
<style>
/* CSS GERAL */
* { box-sizing: border-box; touch-action: none; user-select: none; font-family: 'Segoe UI', sans-serif; }
body { margin: 0; background: #1a1a1a; overflow: hidden; color: white; }

/* TELAS */
.screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 100; transition: opacity 0.3s; }
.hidden { opacity: 0; pointer-events: none; }

h1 { color: #ffd700; text-shadow: 0 0 15px #ff4500; font-size: 2.5rem; text-transform: uppercase; margin-bottom: 20px; }
input { background: #333; border: 2px solid #555; color: #fff; padding: 12px; font-size: 18px; border-radius: 8px; text-align: center; width: 80%; max-width: 300px; margin: 5px; }
button { background: #2e8b57; color: white; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 8px; margin-top: 15px; cursor: pointer; box-shadow: 0 4px 0 #1e5c39; }
button:active { transform: translateY(3px); box-shadow: none; }

/* HUD DE JOGO */
#hud { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: none; }

/* Barras e Level */
.top-bar { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; }
.bar-container { width: 200px; height: 20px; background: #222; border: 2px solid #444; border-radius: 10px; overflow: hidden; position: relative; }
.fill { height: 100%; transition: width 0.3s; }
.hp-fill { background: #ff4444; }
.xp-fill { background: #4488ff; }
.bar-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 20px; text-shadow: 1px 1px 0 #000; font-weight: bold; }

/* Invent√°rio R√°pido */
.inventory { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
.inv-slot { background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; border: 1px solid #555; font-size: 14px; display: flex; align-items: center; gap: 5px; }

/* Bot√µes de A√ß√£o */
#buildBtn { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: #d35400; padding: 10px 20px; font-size: 14px; pointer-events: auto; display: none; }

/* Level Up Modal */
#levelUpScreen { background: rgba(0,0,0,0.8); z-index: 200; }
.cards-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
.card { background: #2c3e50; border: 2px solid #f1c40f; padding: 20px; width: 140px; border-radius: 10px; text-align: center; cursor: pointer; pointer-events: auto; transition: transform 0.2s; }
.card:active { transform: scale(0.95); background: #34495e; }
.card h3 { color: #f1c40f; font-size: 16px; margin: 0 0 10px 0; }

/* MiniMapa */
#minimap { position: absolute; top: 60px; right: 10px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 50%; width: 120px; height: 120px; }

/* FPS */
#fpsCounter { position: absolute; bottom: 5px; left: 5px; font-size: 10px; color: #0f0; opacity: 0.5; }

/* TELA DE MORTE */
#deathScreen { background: rgba(50, 0, 0, 0.9); z-index: 150; }
</style>
</head>
<body>

<div id="menuScreen" class="screen">
    <h1>RPG LEGENDS</h1>
    <input id="playerName" placeholder="SEU NOME">
    <div style="height:20px"></div>
    <button id="createBtn">CRIAR MUNDO</button>
    <div style="margin:10px; opacity:0.7">--- OU ---</div>
    <input id="roomInput" placeholder="C√ìDIGO DA SALA">
    <button id="joinBtn">ENTRAR</button>
</div>

<div id="levelUpScreen" class="screen hidden">
    <h2 style="color:#f1c40f">LEVEL UP! ESCOLHA UM PODER:</h2>
    <div class="cards-container">
        <div class="card" onclick="chooseCard('dmg')"><h3>‚öîÔ∏è FOR√áA</h3><p>+20% Dano</p></div>
        <div class="card" onclick="chooseCard('hp')"><h3>‚ù§Ô∏è VITALIDADE</h3><p>+50 Vida M√°x</p><p>Cura Total</p></div>
        <div class="card" onclick="chooseCard('spd')"><h3>‚ö° AGILIDADE</h3><p>+10% Velocidade</p></div>
    </div>
</div>

<div id="deathScreen" class="screen hidden">
    <h1 style="color:red">VOC√ä MORREU</h1>
    <button onclick="respawn()">RENASCER</button>
</div>

<div id="hud">
    <div class="top-bar">
        <div class="bar-container"><div id="hpBar" class="fill hp-fill"></div><div id="hpText" class="bar-text">100/100</div></div>
        <div class="bar-container"><div id="xpBar" class="fill xp-fill"></div><div id="xpText" class="bar-text">LVL 1</div></div>
    </div>
    <div class="inventory">
        <div class="inv-slot">ü™µ <span id="woodCount">0</span></div>
        <div class="inv-slot">ü™® <span id="stoneCount">0</span></div>
    </div>
    <button id="buildBtn" onclick="buildWall()">üî® CONSTRUIR PAREDE (10 Mad)</button>
    <canvas id="minimap"></canvas>
    <div id="fpsCounter">60 FPS</div>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
/* === ENGINE VISUAL FOFINHA (CANVAS) === */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const mCanvas = document.getElementById("minimap");
const mCtx = mCanvas.getContext("2d");
mCanvas.width = 120; mCanvas.height = 120;

let socket = io();
let myId = null;
let roomId = null;
let camera = { x: 0, y: 0 };
let state = { players: {}, enemies: [], resources: [], buildings: [], xpOrbs: [] };
let localPlayer = {};
let particles = [];
let damageNums = [];

// Configura√ß√µes
let settings = { showFps: true, quality: 'high' };
let lastTime = 0;

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resize(); window.addEventListener("resize", resize);

/* === CONTROLES (DUAL STICK) === */
let joyLeft = { active: false, id: null, dx: 0, dy: 0, originX: 0, originY: 0 };
let joyRight = { active: false, id: null, dx: 0, dy: 0, originX: 0, originY: 0, angle: 0 };

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.clientX < window.innerWidth/2 && !joyLeft.active) {
            // Esquerda (Move)
            joyLeft.active = true; joyLeft.id = t.identifier;
            joyLeft.originX = t.clientX; joyLeft.originY = t.clientY;
        } else if(t.clientX > window.innerWidth/2 && !joyRight.active) {
            // Direita (Aim/Attack)
            joyRight.active = true; joyRight.id = t.identifier;
            joyRight.originX = t.clientX; joyRight.originY = t.clientY;
        }
    }
}, {passive:false});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.identifier === joyLeft.id) {
            const dx = t.clientX - joyLeft.originX;
            const dy = t.clientY - joyLeft.originY;
            const dist = Math.min(Math.hypot(dx,dy), 50);
            const angle = Math.atan2(dy, dx);
            joyLeft.dx = Math.cos(angle) * (dist/50);
            joyLeft.dy = Math.sin(angle) * (dist/50);
        }
        if(t.identifier === joyRight.id) {
            const dx = t.clientX - joyRight.originX;
            const dy = t.clientY - joyRight.originY;
            joyRight.dx = dx; joyRight.dy = dy;
            joyRight.angle = Math.atan2(dy, dx);
        }
    }
}, {passive:false});

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.identifier === joyLeft.id) { joyLeft.active = false; joyLeft.dx=0; joyLeft.dy=0; }
        if(t.identifier === joyRight.id) { joyRight.active = false; }
    }
}, {passive:false});

/* === REDE === */
document.getElementById('createBtn').onclick = () => {
    const name = document.getElementById('playerName').value || "Heroi";
    socket.emit('createRoom', name);
}
document.getElementById('joinBtn').onclick = () => {
    const name = document.getElementById('playerName').value || "Visitante";
    const code = document.getElementById('roomInput').value.trim().toUpperCase();
    socket.emit('joinRoom', {code, name});
}

function startGame(code) {
    roomId = code;
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('hud').style.display = 'block';
}

socket.on('roomCreated', startGame);
socket.on('joinedRoom', startGame);
socket.on('connect', () => myId = socket.id);

socket.on('updateWorld', (data) => {
    state = data;
    if(state.players[myId]) {
        const p = state.players[myId];
        localPlayer = p;
        
        // HUD Updates
        document.getElementById('hpBar').style.width = (p.hp/p.maxHp*100) + "%";
        document.getElementById('hpText').innerText = Math.ceil(p.hp) + "/" + p.maxHp;
        document.getElementById('xpBar').style.width = (p.xp/p.nextLevel*100) + "%";
        document.getElementById('xpText').innerText = "LVL " + p.level;
        document.getElementById('woodCount').innerText = p.inv.wood;
        document.getElementById('stoneCount').innerText = p.inv.stone;
        
        if(p.inv.wood >= 10) document.getElementById('buildBtn').style.display = 'block';
        else document.getElementById('buildBtn').style.display = 'none';

        if(p.dead) document.getElementById('deathScreen').classList.remove('hidden');
        else document.getElementById('deathScreen').classList.add('hidden');
    }
});

socket.on('levelUp', () => {
    document.getElementById('levelUpScreen').classList.remove('hidden');
});

socket.on('damageEffect', (data) => {
    damageNums.push({x: data.x, y: data.y, val: data.dmg, life: 1});
});

socket.on('shakeRes', (data) => {
    // Efeito visual simples de shake
});

/* === A√á√ïES === */
function chooseCard(type) {
    socket.emit('levelUpChoice', { roomId, choice: type });
    document.getElementById('levelUpScreen').classList.add('hidden');
}

function buildWall() {
    socket.emit('build', { roomId, type: 'wall' });
}

function respawn() {
    socket.emit('respawn', roomId);
}

/* === DRAWING FUNCTIONS (CUTE STYLE) === */
function drawCircle(ctx, x, y, r, color, stroke) {
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2);
    ctx.fillStyle = color; ctx.fill();
    if(stroke) { ctx.lineWidth=2; ctx.strokeStyle=stroke; ctx.stroke(); }
}

function drawPlayer(ctx, p, x, y) {
    const breath = Math.sin(Date.now()/200) * 2;
    const walk = p.state === 'run' ? Math.sin(Date.now()/100) * 3 : 0;
    
    // Sombra
    ctx.fillStyle = "rgba(0,0,0,0.3)";
    ctx.beginPath(); ctx.ellipse(x, y+10, 15, 8, 0, 0, Math.PI*2); ctx.fill();

    // Corpo
    ctx.save();
    ctx.translate(x, y + walk);
    
    if(p.role === 'warrior') {
        // Guerreiro: Corpo arredondado azul
        drawCircle(ctx, 0, 0, 18, "#3498db", "#2980b9");
        // Olhos
        ctx.fillStyle = "white"; 
        ctx.fillRect(-8, -5, 6, 6); ctx.fillRect(2, -5, 6, 6);
        ctx.fillStyle = "black";
        ctx.fillRect(-6 + p.facing, -3, 2, 2); ctx.fillRect(4 + p.facing, -3, 2, 2);
        
        // Espada (Gira com mira)
        ctx.save();
        ctx.rotate(p.aimAngle || 0);
        ctx.fillStyle = "#ecf0f1"; ctx.fillRect(15, -2, 20, 4); // Lamina
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(15, -4, 4, 8); // Guarda
        ctx.restore();
    } else {
        // Mago: Triangulo Roxo
        ctx.fillStyle = "#9b59b6";
        ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(15, 10); ctx.lineTo(-15, 10); ctx.fill();
        // Chapeu
        ctx.fillStyle = "#8e44ad";
        ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(10, -10); ctx.lineTo(-10, -10); ctx.fill();
        // Cajado
        ctx.save();
        ctx.rotate(p.aimAngle || 0);
        ctx.fillStyle = "#8e44ad"; ctx.fillRect(15, -15, 2, 30);
        ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.arc(16, -15, 4, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }
    
    // Nome
    ctx.fillStyle = "#fff"; ctx.font = "10px Arial"; ctx.textAlign = "center";
    ctx.fillText(p.name, 0, -25);
    
    ctx.restore();
}

function drawResource(ctx, r, x, y) {
    if(r.type === 'tree') {
        ctx.fillStyle = "#795548"; ctx.fillRect(x-5, y, 10, 20); // Tronco
        drawCircle(ctx, x, y-10, 20, "#2ecc71", "#27ae60"); // Copa 1
        drawCircle(ctx, x-10, y-5, 15, "#27ae60", null); // Copa 2
        drawCircle(ctx, x+10, y-5, 15, "#27ae60", null); // Copa 3
    } else {
        // Pedra
        ctx.fillStyle = "#95a5a6";
        ctx.beginPath(); 
        ctx.moveTo(x, y-15); ctx.lineTo(x+15, y); ctx.lineTo(x+10, y+15);
        ctx.lineTo(x-15, y+10); ctx.lineTo(x-10, y-10); 
        ctx.fill(); ctx.strokeStyle="#7f8c8d"; ctx.stroke();
    }
    // Barra HP Resource
    if(r.hp < r.maxHp) {
        ctx.fillStyle = "red"; ctx.fillRect(x-15, y-30, 30, 4);
        ctx.fillStyle = "lime"; ctx.fillRect(x-15, y-30, 30*(r.hp/r.maxHp), 4);
    }
}

/* === LOOP PRINCIPAL === */
function loop() {
    requestAnimationFrame(loop);
    if(!localPlayer || !roomId) return;
    
    // 1. INPUT HANDLING & AUTO-AIM
    let moveState = 'idle';
    let myFacing = 0;
    
    if(joyLeft.active) {
        localPlayer.x += joyLeft.dx * (5 * (localPlayer.speedMult||1));
        localPlayer.y += joyLeft.dy * (5 * (localPlayer.speedMult||1));
        localPlayer.x = Math.max(0, Math.min(2400, localPlayer.x));
        localPlayer.y = Math.max(0, Math.min(2400, localPlayer.y));
        moveState = 'run';
        myFacing = joyLeft.dx > 0 ? 1 : -1;
    }

    let aimAngle = localPlayer.aimAngle || 0;
    let shooting = false;

    if(joyRight.active) {
        // Mira manual
        aimAngle = joyRight.angle;
        shooting = true;
    } else {
        // Auto-Aim (Nearest Enemy)
        let minDist = 400; // Alcance do auto-aim
        let target = null;
        state.enemies.forEach(e => {
            const d = Math.hypot(e.x - localPlayer.x, e.y - localPlayer.y);
            if(d < minDist) { minDist = d; target = e; }
        });
        if(target) {
            aimAngle = Math.atan2(target.y - localPlayer.y, target.x - localPlayer.x);
            shooting = true;
        }
    }

    // Envia dados (Com Throttling leve se precisar)
    socket.emit('move', { 
        roomId, x: localPlayer.x, y: localPlayer.y, 
        state: moveState, facing: myFacing, angle: aimAngle 
    });

    if(shooting && Date.now() - lastTime > 200) { // Cad√™ncia de tiro
        lastTime = Date.now();
        socket.emit('attack', { roomId, angle: aimAngle });
    }

    // 2. CAMERA LERP (Micro delay)
    camera.x += (localPlayer.x - camera.x - canvas.width/2) * 0.1;
    camera.y += (localPlayer.y - camera.y - canvas.height/2) * 0.1;

    // 3. RENDERIZA√á√ÉO
    ctx.fillStyle = "#2c3e50"; // Fundo Escuro
    ctx.fillRect(0,0,canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Ch√£o (Grid suave)
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    ctx.lineWidth = 2;
    const gridSize = 100;
    const sx = Math.floor(camera.x/gridSize)*gridSize;
    const sy = Math.floor(camera.y/gridSize)*gridSize;
    for(let i=sx; i<camera.x+canvas.width; i+=gridSize) { ctx.beginPath(); ctx.moveTo(i, camera.y); ctx.lineTo(i, camera.y+canvas.height); ctx.stroke(); }
    for(let i=sy; i<camera.y+canvas.height; i+=gridSize) { ctx.beginPath(); ctx.moveTo(camera.x, i); ctx.lineTo(camera.x+canvas.width, i); ctx.stroke(); }

    // Objetos
    state.resources.forEach(r => drawResource(ctx, r, r.x, r.y));
    state.buildings.forEach(b => {
        ctx.fillStyle = "#d35400"; ctx.fillRect(b.x-20, b.y-20, 40, 40); // Parede
        ctx.strokeStyle = "#a04000"; ctx.strokeRect(b.x-20, b.y-20, 40, 40);
    });
    
    // XP Orbs
    state.xpOrbs.forEach(o => drawCircle(ctx, o.x, o.y, 5, "#3498db", "#fff"));

    // Inimigos
    state.enemies.forEach(e => {
        if(e.dead) return;
        drawCircle(ctx, e.x, e.y, 15, "#e74c3c", "#c0392b");
        // Barra HP
        ctx.fillStyle = "red"; ctx.fillRect(e.x-15, e.y-25, 30, 4);
        ctx.fillStyle = "lime"; ctx.fillRect(e.x-15, e.y-25, 30*(e.hp/e.maxHp), 4);
    });

    // Players
    Object.keys(state.players).forEach(id => {
        const p = state.players[id];
        if(!p.dead) drawPlayer(ctx, p, p.x, p.y);
    });

    // Danos Flutuantes
    damageNums.forEach((d, i) => {
        d.y -= 1; d.life -= 0.02;
        ctx.globalAlpha = d.life;
        ctx.fillStyle = "#fff"; ctx.font = "bold 16px Arial";
        ctx.fillText(Math.floor(d.val), d.x, d.y);
        ctx.globalAlpha = 1;
        if(d.life <= 0) damageNums.splice(i,1);
    });

    ctx.restore();

    /* === UI OVERLAYS === */
    // Minimapa
    mCtx.clearRect(0,0,120,120);
    mCtx.fillStyle = "rgba(0,0,0,0.6)"; mCtx.fillRect(0,0,120,120);
    const scale = 120/2400;
    // Desenha tudo no minimapa
    mCtx.fillStyle = "#2ecc71"; state.resources.forEach(r => mCtx.fillRect(r.x*scale, r.y*scale, 2, 2));
    mCtx.fillStyle = "#e74c3c"; state.enemies.forEach(e => { if(!e.dead) mCtx.fillRect(e.x*scale, e.y*scale, 3, 3); });
    Object.keys(state.players).forEach(id => {
        const p = state.players[id];
        mCtx.fillStyle = id === myId ? "#fff" : "#3498db";
        mCtx.beginPath(); mCtx.arc(p.x*scale, p.y*scale, 3, 0, Math.PI*2); mCtx.fill();
        
        // Seta Indicadora se for outro player
        if(id !== myId && !p.dead) {
            // Desenha seta na tela principal se estiver longe
            const dx = p.x - localPlayer.x; const dy = p.y - localPlayer.y;
            const dist = Math.hypot(dx,dy);
            if(dist > window.innerWidth/2) {
                const angle = Math.atan2(dy, dx);
                const ax = canvas.width/2 + Math.cos(angle)*(canvas.width/2 - 50);
                const ay = canvas.height/2 + Math.sin(angle)*(canvas.height/2 - 50);
                ctx.save(); ctx.translate(ax, ay); ctx.rotate(angle);
                ctx.fillStyle = "#3498db"; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-10, -5); ctx.lineTo(-10, 5); ctx.fill();
                ctx.restore();
            }
        }
    });

    // Joystick Visuais
    if(joyLeft.active) {
        ctx.beginPath(); ctx.arc(joyLeft.originX, joyLeft.originY, 40, 0, Math.PI*2); ctx.strokeStyle="rgba(255,255,255,0.3)"; ctx.stroke();
        ctx.beginPath(); ctx.arc(joyLeft.originX+joyLeft.dx*40, joyLeft.originY+joyLeft.dy*40, 20, 0, Math.PI*2); ctx.fillStyle="rgba(255,255,255,0.5)"; ctx.fill();
    }
    if(joyRight.active) {
        ctx.beginPath(); ctx.arc(joyRight.originX, joyRight.originY, 40, 0, Math.PI*2); ctx.strokeStyle="rgba(255,50,50,0.3)"; ctx.stroke();
        ctx.beginPath(); ctx.arc(joyRight.originX+Math.cos(joyRight.angle)*40, joyRight.originY+Math.sin(joyRight.angle)*40, 20, 0, Math.PI*2); ctx.fillStyle="rgba(255,50,50,0.5)"; ctx.fill();
    }
}
loop();
</script>
</body>
</html>

