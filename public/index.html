<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>eddual jogo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #menu {
      margin: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button, input {
      padding: 6px;
      font-size: 14px;
    }

    #roomCode {
      width: 100%;
      text-align: center;
      font-weight: bold;
    }

    #gameWrapper {
      position: relative;
    }

    canvas {
      background: #222;
      border: 2px solid #444;
      touch-action: none;
    }
  </style>
</head>

<body>

  <!-- MENU -->
  <div id="menu">
    <div id="roomCode"></div>
    <button id="createBtn">Criar sala</button>
    <input id="roomInput" placeholder="Código da sala">
    <button id="joinBtn">Entrar</button>
  </div>

  <!-- JOGO -->
  <div id="gameWrapper">
    <canvas id="game"></canvas>
  </div>

  <!-- SOCKET -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- JOGO -->
  <script>
    const socket = io()

    // ===== canvas =====
    const canvas = document.getElementById("game")
    const ctx = canvas.getContext("2d")

    canvas.width = Math.min(window.innerWidth - 20, 420)
    canvas.height = Math.min(window.innerHeight - 140, 420)

    // ===== estado =====
    let roomId = null
    let players = {}
    let myId = null

    // posição local (ANTI-TREMIDA)
    let localPlayer = { x: 200, y: 200 }
    let localInit = false

    // ===== ui =====
    const createBtn = document.getElementById("createBtn")
    const joinBtn = document.getElementById("joinBtn")
    const roomInput = document.getElementById("roomInput")
    const roomCode = document.getElementById("roomCode")

    // ===== socket =====
    socket.on("connect", () => {
      myId = socket.id
    })

    createBtn.onclick = () => {
      socket.emit("createRoom")
    }

    joinBtn.onclick = () => {
      const code = roomInput.value.trim()
      if (!code) return
      roomId = code
      roomCode.innerText = "Sala: " + code
      socket.emit("joinRoom", code)
    }

    socket.on("roomCreated", id => {
      roomId = id
      roomCode.innerText = "Sala: " + id
      roomInput.value = id
    })

    socket.on("updatePlayers", data => {
      players = data

      // inicializa posição local uma vez
      if (!localInit && players[myId]) {
        localPlayer.x = players[myId].x
        localPlayer.y = players[myId].y
        localInit = true
      }
    })

    // ===== colisão simples =====
    function resolvePlayerCollision(a, b) {
      const dx = a.x - b.x
      const dy = a.y - b.y
      const dist = Math.hypot(dx, dy)
      const minDist = 24

      if (dist > 0 && dist < minDist) {
        const overlap = (minDist - dist) / 2
        const nx = dx / dist
        const ny = dy / dist

        a.x += nx * overlap
        a.y += ny * overlap
        b.x -= nx * overlap
        b.y -= ny * overlap
      }
    }

    // ===== loop =====
    function loop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height)

      // movimento LOCAL (suave, sem tremida)
      if (roomId && window.joystick) {
        const speed = 5
        localPlayer.x += window.joystick.dx * speed
        localPlayer.y += window.joystick.dy * speed

        // envia pro server com throttling
        if (Math.random() < 0.3) {
          socket.emit("move", {
            roomId,
            x: localPlayer.x,
            y: localPlayer.y
          })
        }
      }

      // colisão (2 players)
      const ids = Object.keys(players)
      if (ids.length === 2) {
        const a = ids[0] === myId ? localPlayer : players[ids[0]]
        const b = ids[1] === myId ? localPlayer : players[ids[1]]
        resolvePlayerCollision(a, b)
      }

      // desenha players
      for (const id in players) {
        const p = id === myId ? localPlayer : players[id]
        ctx.fillStyle = id === myId ? "#4da6ff" : "#ffa94d"
        ctx.beginPath()
        ctx.arc(p.x, p.y, 12, 0, Math.PI * 2)
        ctx.fill()
      }

      requestAnimationFrame(loop)
    }

    loop()
  </script>

  <!-- JOYSTICK -->
  <script src="js/joystick.js"></script>

</body>
</html>        const p = players[id]
        ctx.fillStyle = id === myId ? "#4da6ff" : "#ffa94d"
        ctx.beginPath()
        ctx.arc(p.x, p.y, 12, 0, Math.PI * 2)
        ctx.fill()
      }

      requestAnimationFrame(loop)
    }

    loop()
  </script>

  <!-- JOYSTICK -->
  <script src="js/joystick.js"></script>

</body>
</html>
