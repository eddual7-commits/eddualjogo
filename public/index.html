<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‚öîÔ∏è RPG Legends - Miku Edition</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    touch-action: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

@font-face {
    font-family: 'GameFont';
    src: local('Arial');
}

:root {
    --primary: #39C5BB;
    --primary-dark: #2A9D8F;
    --secondary: #00BFFF;
    --danger: #E74C3C;
    --warning: #F1C40F;
    --dark: #0a1628;
    --darker: #060d17;
}

body {
    background: var(--darker);
    color: white;
    font-family: 'Segoe UI', Arial, sans-serif;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
}

/* ==================== MENU PRINCIPAL ==================== */
#menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, #1a2a4a 0%, #0a1628 50%, #060d17 100%);
    z-index: 1000;
    overflow: hidden;
}

#menuParticles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.menu-content {
    position: relative;
    z-index: 10;
    text-align: center;
}

.logo-container {
    margin-bottom: 30px;
    animation: logoFloat 3s ease-in-out infinite;
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.logo {
    font-size: clamp(2rem, 8vw, 4rem);
    font-weight: bold;
    background: linear-gradient(135deg, #39C5BB 0%, #00BFFF 50%, #00D4AA 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 60px rgba(57, 197, 187, 0.5);
    letter-spacing: 3px;
}

.logo-sub {
    font-size: clamp(0.8rem, 3vw, 1.2rem);
    color: var(--primary);
    margin-top: 5px;
    opacity: 0.9;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

.menu-box {
    background: linear-gradient(145deg, rgba(0,0,0,0.7), rgba(20,40,60,0.5));
    padding: clamp(20px, 5vw, 40px);
    border-radius: 25px;
    border: 2px solid var(--primary);
    box-shadow: 
        0 0 50px rgba(57, 197, 187, 0.2),
        inset 0 0 30px rgba(57, 197, 187, 0.05);
    backdrop-filter: blur(10px);
    min-width: 300px;
    max-width: 90vw;
}

.input-group {
    margin: 15px 0;
    position: relative;
}

.input-group label {
    display: block;
    text-align: left;
    margin-bottom: 8px;
    color: var(--primary);
    font-size: 0.9rem;
    font-weight: 500;
}

input {
    width: 100%;
    padding: 15px 20px;
    border: 2px solid rgba(57, 197, 187, 0.3);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
}

input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 20px rgba(57, 197, 187, 0.3);
    background: rgba(57, 197, 187, 0.1);
}

input::placeholder {
    color: rgba(255,255,255,0.4);
}

.btn {
    width: 100%;
    padding: 15px 25px;
    margin: 10px 0;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    box-shadow: 0 5px 0 var(--primary-dark), 0 10px 30px rgba(57, 197, 187, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 7px 0 var(--primary-dark), 0 15px 40px rgba(57, 197, 187, 0.4);
}

.btn-primary:active {
    transform: translateY(3px);
    box-shadow: 0 2px 0 var(--primary-dark);
}

.btn-secondary {
    background: linear-gradient(135deg, rgba(57,197,187,0.2), rgba(0,191,255,0.2));
    color: var(--primary);
    border: 2px solid var(--primary);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, rgba(57,197,187,0.3), rgba(0,191,255,0.3));
}

.divider {
    display: flex;
    align-items: center;
    margin: 20px 0;
    color: rgba(255,255,255,0.5);
    font-size: 0.9rem;
}

.divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(57,197,187,0.5), transparent);
}

.divider span {
    padding: 0 15px;
}

.hidden {
    display: none !important;
}

/* ==================== TELA DE LOADING ==================== */
#loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--darker);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999;
}

.loader {
    width: 80px;
    height: 80px;
    border: 4px solid rgba(57,197,187,0.2);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 20px;
    color: var(--primary);
    font-size: 1.2rem;
}

/* ==================== HUD ==================== */
#hud {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
}

.room-info {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,40,60,0.6));
    padding: 10px 25px;
    border-radius: 25px;
    border: 2px solid var(--primary);
    display: flex;
    align-items: center;
    gap: 20px;
}

.room-code {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--primary);
    letter-spacing: 2px;
}

.wave-info {
    font-size: 1rem;
    color: #9B59B6;
}

.stats-container {
    position: absolute;
    top: 15px;
    left: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.stat-bar {
    width: clamp(150px, 25vw, 220px);
    height: 28px;
    background: rgba(0,0,0,0.7);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 14px;
    overflow: hidden;
    position: relative;
}

.stat-fill {
    height: 100%;
    transition: width 0.3s ease;
    position: relative;
}

.hp-fill {
    background: linear-gradient(90deg, #C0392B, #E74C3C, #FF6B6B);
    box-shadow: inset 0 -3px 0 rgba(0,0,0,0.3), 0 0 10px rgba(231,76,60,0.5);
}

.xp-fill {
    background: linear-gradient(90deg, #2A9D8F, #39C5BB, #00D4AA);
    box-shadow: inset 0 -3px 0 rgba(0,0,0,0.3), 0 0 10px rgba(57,197,187,0.5);
}

.stat-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: bold;
    text-shadow: 1px 1px 2px black;
    white-space: nowrap;
}

.stat-icon {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
}

.level-badge {
    position: absolute;
    right: -5px;
    top: -5px;
    background: linear-gradient(135deg, #F1C40F, #F39C12);
    color: #000;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    border: 2px solid #FFF;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

/* ==================== INVENT√ÅRIO ==================== */
.inventory {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.inv-item {
    background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,40,60,0.6));
    padding: 8px 15px;
    border-radius: 12px;
    border: 2px solid rgba(57,197,187,0.5);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    min-width: 80px;
}

.inv-item .icon {
    font-size: 18px;
}

.inv-item .count {
    font-weight: bold;
    color: var(--primary);
}

/* ==================== BOT√ïES DE A√á√ÉO ==================== */
.action-buttons {
    position: absolute;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    pointer-events: auto;
}

.action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(145deg, rgba(57,197,187,0.3), rgba(0,0,0,0.5));
    border: 3px solid var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.action-btn:active {
    transform: scale(0.9);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.action-btn.disabled {
    opacity: 0.5;
    border-color: #666;
}

/* ==================== MINIMAP ==================== */
.minimap-container {
    position: absolute;
    bottom: 15px;
    right: 15px;
    width: clamp(100px, 20vw, 160px);
    height: clamp(100px, 20vw, 160px);
    border: 3px solid var(--primary);
    border-radius: 15px;
    overflow: hidden;
    background: rgba(0,0,0,0.7);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
}

#minimap {
    width: 100%;
    height: 100%;
}

/* ==================== CRAFT MENU ==================== */
#craftMenu {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(145deg, rgba(10,22,40,0.98), rgba(5,15,30,0.98));
    padding: 25px;
    border-radius: 20px;
    border: 2px solid var(--primary);
    z-index: 200;
    min-width: 320px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    pointer-events: auto;
}

.menu-title {
    text-align: center;
    font-size: 1.5rem;
    color: var(--primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.craft-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.craft-item {
    background: linear-gradient(145deg, rgba(57,197,187,0.15), rgba(0,0,0,0.3));
    padding: 15px;
    border-radius: 12px;
    border: 2px solid rgba(57,197,187,0.3);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.craft-item:hover {
    border-color: var(--primary);
    background: linear-gradient(145deg, rgba(57,197,187,0.25), rgba(0,0,0,0.4));
    transform: translateY(-2px);
}

.craft-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.craft-icon {
    font-size: 2rem;
    margin-bottom: 8px;
}

.craft-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.craft-cost {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.7);
}

/* ==================== LEVEL UP POPUP ==================== */
#levelUp {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(145deg, rgba(20,15,30,0.98), rgba(10,5,20,0.98));
    padding: 30px;
    border-radius: 20px;
    border: 3px solid #F1C40F;
    z-index: 200;
    text-align: center;
    box-shadow: 0 0 60px rgba(241,196,15,0.3);
    pointer-events: auto;
    animation: levelUpPop 0.5s ease;
}

@keyframes levelUpPop {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.1); }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

.level-title {
    font-size: 2rem;
    color: #F1C40F;
    margin-bottom: 10px;
    text-shadow: 0 0 20px rgba(241,196,15,0.5);
}

.level-number {
    font-size: 3rem;
    font-weight: bold;
    color: #FFF;
    margin-bottom: 20px;
}

.upgrades-grid {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
}

.upgrade-card {
    background: linear-gradient(145deg, rgba(241,196,15,0.2), rgba(0,0,0,0.3));
    padding: 20px;
    border-radius: 15px;
    border: 2px solid rgba(241,196,15,0.5);
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
}

.upgrade-card:hover {
    border-color: #F1C40F;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(241,196,15,0.3);
}

.upgrade-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.upgrade-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.upgrade-desc {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.7);
}

/* ==================== DEATH SCREEN ==================== */
#death {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 300;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.death-title {
    font-size: 3rem;
    color: var(--danger);
    margin-bottom: 20px;
    text-shadow: 0 0 30px rgba(231,76,60,0.5);
}

.death-stats {
    margin: 20px 0;
    text-align: center;
}

.death-stat {
    font-size: 1.2rem;
    margin: 10px 0;
    color: rgba(255,255,255,0.8);
}

/* ==================== WAVE ALERT ==================== */
.wave-alert {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: clamp(2rem, 8vw, 4rem);
    font-weight: bold;
    color: #9B59B6;
    text-shadow: 0 0 40px #9B59B6, 0 0 80px #9B59B6;
    animation: waveAlert 3s forwards;
    pointer-events: none;
    z-index: 150;
}

@keyframes waveAlert {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    15% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    25% { transform: translate(-50%, -50%) scale(1); }
    75% { opacity: 1; }
    100% { opacity: 0; transform: translate(-50%, -50%) translateY(-50px); }
}

/* ==================== TOAST NOTIFICATIONS ==================== */
.toast {
    position: fixed;
    bottom: 150px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    padding: 12px 25px;
    border-radius: 25px;
    border: 2px solid var(--primary);
    animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s;
    z-index: 150;
}

@keyframes toastIn {
    from { opacity: 0; transform: translateX(-50%) translateY(20px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes toastOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* ==================== CANVAS ==================== */
#game {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 600px) {
    .menu-box {
        padding: 20px;
        margin: 0 15px;
    }
    
    .craft-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .craft-item {
        padding: 10px;
    }
    
    .upgrades-grid {
        gap: 10px;
    }
    
    .upgrade-card {
        padding: 15px;
        min-width: 80px;
    }
}
</style>
</head>
<body>

<!-- ==================== LOADING ==================== -->
<div id="loading" class="hidden">
    <div class="loader"></div>
    <div class="loading-text">Conectando...</div>
</div>

<!-- ==================== MENU ==================== -->
<div id="menu">
    <canvas id="menuParticles"></canvas>
    
    <div class="menu-content">
        <div class="logo-container">
            <div class="logo">‚öîÔ∏è RPG LEGENDS</div>
            <div class="logo-sub">üíô Miku Edition üíô</div>
        </div>
        
        <div class="menu-box">
            <div class="input-group">
                <label>üë§ Nome do Her√≥i</label>
                <input type="text" id="playerName" placeholder="Digite seu nome..." maxlength="12">
            </div>
            
            <button class="btn btn-primary" onclick="createRoom()">
                üåç CRIAR MUNDO
            </button>
            
            <div class="divider"><span>ou entre em um mundo</span></div>
            
            <div class="input-group">
                <label>üîë C√≥digo da Sala</label>
                <input type="text" id="roomCodeInput" placeholder="EX: ABC12" maxlength="5" style="text-transform: uppercase;">
            </div>
            
            <button class="btn btn-secondary" onclick="joinRoom()">
                üö™ ENTRAR
            </button>
        </div>
    </div>
</div>

<!-- ==================== HUD ==================== -->
<div id="hud" class="hidden">
    <div class="room-info">
        <div class="room-code">üîë <span id="roomCodeDisplay">-----</span></div>
        <div class="wave-info">üåä Wave <span id="waveDisplay">1</span></div>
    </div>
    
    <div class="stats-container">
        <div class="stat-bar">
            <div class="stat-fill hp-fill" id="hpBar" style="width: 100%"></div>
            <span class="stat-icon">‚ù§Ô∏è</span>
            <span class="stat-text"><span id="hpText">100</span>/<span id="hpMaxText">100</span></span>
            <div class="level-badge" id="levelBadge">1</div>
        </div>
        <div class="stat-bar">
            <div class="stat-fill xp-fill" id="xpBar" style="width: 0%"></div>
            <span class="stat-icon">‚≠ê</span>
            <span class="stat-text"><span id="xpText">0</span>/<span id="xpNextText">80</span></span>
        </div>
    </div>
    
    <div class="inventory">
        <div class="inv-item"><span class="icon">ü™µ</span><span class="count" id="woodCount">0</span></div>
        <div class="inv-item"><span class="icon">ü™®</span><span class="count" id="stoneCount">0</span></div>
        <div class="inv-item"><span class="icon">üíé</span><span class="count" id="crystalCount">0</span></div>
        <div class="inv-item"><span class="icon">üçñ</span><span class="count" id="foodCount">5</span></div>
    </div>
    
    <div class="action-buttons">
        <div class="action-btn" id="btnCraft" onclick="openCraft()">üõ†Ô∏è</div>
        <div class="action-btn" id="btnFood" onclick="useFood()">üçñ</div>
    </div>
    
    <div class="minimap-container">
        <canvas id="minimap"></canvas>
    </div>
</div>

<!-- ==================== CRAFT MENU ==================== -->
<div id="craftMenu" class="hidden">
    <div class="menu-title">üõ†Ô∏è Constru√ß√µes</div>
    <div class="craft-grid" id="craftGrid"></div>
    <button class="btn btn-secondary" onclick="closeCraft()" style="pointer-events: auto;">Fechar</button>
</div>

<!-- ==================== LEVEL UP ==================== -->
<div id="levelUp" class="hidden">
    <div class="level-title">üéâ LEVEL UP!</div>
    <div class="level-number">Lv.<span id="newLevel">2</span></div>
    <div class="upgrades-grid" id="upgradesGrid"></div>
</div>

<!-- ==================== DEATH ==================== -->
<div id="death" class="hidden">
    <div class="death-title">üíÄ VOC√ä MORREU</div>
    <div class="death-stats">
        <div class="death-stat">Inimigos derrotados: <span id="deathKills">0</span></div>
        <div class="death-stat">N√≠vel alcan√ßado: <span id="deathLevel">1</span></div>
        <div class="death-stat">Recursos perdidos: 50%</div>
    </div>
    <button class="btn btn-primary" onclick="respawn()" style="pointer-events: auto; width: auto; padding: 15px 40px;">
        üîÑ RENASCER
    </button>
</div>

<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
// ==================== CONFIGURA√á√ïES ====================
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const minimap = document.getElementById('minimap');
const miniCtx = minimap.getContext('2d');
const menuCanvas = document.getElementById('menuParticles');
const menuCtx = menuCanvas.getContext('2d');

// Tamanhos
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    menuCanvas.width = window.innerWidth;
    menuCanvas.height = window.innerHeight;
    minimap.width = minimap.parentElement.clientWidth;
    minimap.height = minimap.parentElement.clientHeight;
}
resize();
window.addEventListener('resize', resize);

// ==================== VARI√ÅVEIS GLOBAIS ====================
const MAP_SIZE = 3200;
const BIOME_SIZE = 800;

let socket = null;
let myId = null;
let roomCode = null;
let buildCosts = {};
let biomes = {};
let inGame = false;

let gameState = {
    players: {},
    enemies: [],
    resources: [],
    buildings: [],
    orbs: [],
    damageTexts: [],
    wave: 1
};

let localPlayer = {
    x: MAP_SIZE / 2,
    y: MAP_SIZE / 2,
    vx: 0,
    vy: 0,
    hp: 100,
    maxHp: 100,
    level: 1,
    xp: 0,
    nextXp: 80,
    wood: 0,
    stone: 0,
    crystal: 0,
    food: 5,
    speed: 4,
    state: 'idle',
    animFrame: 0,
    facing: 1,
    angle: 0,
    attackAngle: 0,
    isAttacking: false,
    attackFrame: 0,
    color: '#39C5BB',
    kills: 0,
    alive: true
};

let camera = { x: 0, y: 0 };
let particles = [];
let damageTexts = [];
let turretShots = [];

// Controles
let joystickLeft = { active: false, x: 0, y: 0, dx: 0, dy: 0, id: null };
let joystickRight = { active: false, x: 0, y: 0, angle: 0, id: null };

// ==================== MENU PARTICLES ====================
let menuParticles = [];

function initMenuParticles() {
    menuParticles = [];
    for(let i = 0; i < 50; i++) {
        menuParticles.push({
            x: Math.random() * menuCanvas.width,
            y: Math.random() * menuCanvas.height,
            size: Math.random() * 3 + 1,
            speedX: (Math.random() - 0.5) * 0.5,
            speedY: (Math.random() - 0.5) * 0.5,
            opacity: Math.random() * 0.5 + 0.2
        });
    }
}

function animateMenuParticles() {
    if(inGame) return;
    
    menuCtx.clearRect(0, 0, menuCanvas.width, menuCanvas.height);
    
    menuParticles.forEach(p => {
        p.x += p.speedX;
        p.y += p.speedY;
        
        if(p.x < 0) p.x = menuCanvas.width;
        if(p.x > menuCanvas.width) p.x = 0;
        if(p.y < 0) p.y = menuCanvas.height;
        if(p.y > menuCanvas.height) p.y = 0;
        
        menuCtx.beginPath();
        menuCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        menuCtx.fillStyle = `rgba(57, 197, 187, ${p.opacity})`;
        menuCtx.fill();
    });
    
    // Conectar part√≠culas pr√≥ximas
    for(let i = 0; i < menuParticles.length; i++) {
        for(let j = i + 1; j < menuParticles.length; j++) {
            const dx = menuParticles[i].x - menuParticles[j].x;
            const dy = menuParticles[i].y - menuParticles[j].y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if(dist < 100) {
                menuCtx.beginPath();
                menuCtx.moveTo(menuParticles[i].x, menuParticles[i].y);
                menuCtx.lineTo(menuParticles[j].x, menuParticles[j].y);
                menuCtx.strokeStyle = `rgba(57, 197, 187, ${0.1 * (1 - dist / 100)})`;
                menuCtx.stroke();
            }
        }
    }
    
    requestAnimationFrame(animateMenuParticles);
}

initMenuParticles();
animateMenuParticles();

// ==================== CONEX√ÉO ====================
function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
}

function showToast(message, duration = 3000) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

function createRoom() {
    const name = document.getElementById('playerName').value.trim() || 'Miku';
    showLoading();
    
    socket = io();
    
    socket.on('connect', () => {
        myId = socket.id;
        socket.emit('createRoom', name);
    });
    
    socket.on('roomJoined', (data) => {
        roomCode = data.roomCode;
        buildCosts = data.buildCosts;
        biomes = data.biomes;
        hideLoading();
        startGame();
    });
    
    socket.on('error', (data) => {
        hideLoading();
        showToast(data.message);
    });
    
    setupSocketEvents();
}

function joinRoom() {
    const name = document.getElementById('playerName').value.trim() || 'Miku';
    const code = document.getElementById('roomCodeInput').value.toUpperCase().trim();
    
    if(!code || code.length < 5) {
        showToast('Digite um c√≥digo v√°lido!');
        return;
    }
    
    showLoading();
    socket = io();
    
    socket.on('connect', () => {
        myId = socket.id;
        socket.emit('joinRoom', { code, name });
    });
    
    socket.on('roomJoined', (data) => {
        roomCode = data.roomCode;
        buildCosts = data.buildCosts;
        biomes = data.biomes;
        hideLoading();
        startGame();
    });
    
    socket.on('error', (data) => {
        hideLoading();
        showToast(data.message);
    });
    
    setupSocketEvents();
}

function startGame() {
    inGame = true;
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('hud').classList.remove('hidden');
    document.getElementById('roomCodeDisplay').textContent = roomCode;
    
    initCraftMenu();
    gameLoop();
}

// ==================== SOCKET EVENTS ====================
function setupSocketEvents() {
    socket.on('gameState', (state) => {
        gameState = state;
        
        if(gameState.players[myId]) {
            const p = gameState.players[myId];
            localPlayer.hp = p.hp;
            localPlayer.maxHp = p.maxHp;
            localPlayer.level = p.level;
            localPlayer.xp = p.xp;
            localPlayer.nextXp = p.nextXp;
            localPlayer.wood = p.wood;
            localPlayer.stone = p.stone;
            localPlayer.crystal = p.crystal;
            localPlayer.food = p.food;
            localPlayer.color = p.color;
            localPlayer.kills = p.kills;
            localPlayer.alive = p.alive;
            
            updateHUD();
        }
        
        // Adicionar damage texts
        state.damageTexts.forEach(dt => {
            if(!damageTexts.find(d => d.x === dt.x && d.y === dt.y && d.damage === dt.damage)) {
                damageTexts.push({...dt});
            }
        });
    });
    
    socket.on('levelUp', (data) => {
        document.getElementById('newLevel').textContent = data.level;
        showUpgradeOptions();
        document.getElementById('levelUp').classList.remove('hidden');
    });
    
    socket.on('newWave', (data) => {
        document.getElementById('waveDisplay').textContent = data.wave;
        
        const alert = document.createElement('div');
        alert.className = 'wave-alert';
        alert.textContent = `‚öîÔ∏è WAVE ${data.wave}`;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    });
    
    socket.on('playerDied', (data) => {
        if(data.playerId === myId) {
            document.getElementById('deathKills').textContent = localPlayer.kills;
            document.getElementById('deathLevel').textContent = localPlayer.level;
            document.getElementById('death').classList.remove('hidden');
        }
    });
    
    socket.on('playerHit', (data) => {
        if(data.playerId === myId) {
            // Efeito de hit
            particles.push({
                x: localPlayer.x,
                y: localPlayer.y,
                vx: (Math.random() - 0.5) * 8,
                vy: -Math.random() * 5,
                color: '#E74C3C',
                life: 20
            });
        }
    });
    
    socket.on('turretShot', (data) => {
        turretShots.push({
            from: data.from,
            to: data.to,
            life: 10
        });
    });
    
    socket.on('enemySpeak', (data) => {
        // Criar bal√£o de fala
        const screenX = data.x - camera.x;
        const screenY = data.y - camera.y - 60;
        
        if(screenX > -100 && screenX < canvas.width + 100 && screenY > -100 && screenY < canvas.height + 100) {
            const speech = document.createElement('div');
            speech.style.cssText = `
                position: fixed;
                left: ${screenX}px;
                top: ${screenY}px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 5px 12px;
                border-radius: 10px;
                border: 2px solid #E74C3C;
                font-size: 12px;
                pointer-events: none;
                z-index: 50;
                animation: fadeInOut 2s forwards;
                transform: translateX(-50%);
            `;
            speech.textContent = data.message;
            document.body.appendChild(speech);
            setTimeout(() => speech.remove(), 2000);
        }
    });
    
    socket.on('buildSuccess', (data) => {
        localPlayer.wood = data.resources.wood;
        localPlayer.stone = data.resources.stone;
        localPlayer.crystal = data.resources.crystal;
        showToast('‚úÖ Constru√ß√£o criada!');
        updateHUD();
    });
    
    socket.on('buildError', (data) => {
        showToast('‚ùå ' + data.message);
    });
    
    socket.on('resourceCollected', (data) => {
        localPlayer.wood = data.wood;
        localPlayer.stone = data.stone;
        localPlayer.crystal = data.crystal;
        localPlayer.food = data.food;
        updateHUD();
    });
    
    socket.on('foodUsed', (data) => {
        localPlayer.hp = data.hp;
        localPlayer.food = data.food;
        updateHUD();
        showToast('‚ù§Ô∏è +35 HP');
    });
    
    socket.on('respawned', (data) => {
        localPlayer.x = data.x;
        localPlayer.y = data.y;
        localPlayer.hp = data.hp;
        localPlayer.alive = true;
        localPlayer.wood = data.resources.wood;
        localPlayer.stone = data.resources.stone;
        localPlayer.crystal = data.resources.crystal;
        updateHUD();
    });
}

// ==================== HUD ====================
function updateHUD() {
    document.getElementById('hpBar').style.width = (localPlayer.hp / localPlayer.maxHp * 100) + '%';
    document.getElementById('hpText').textContent = Math.floor(localPlayer.hp);
    document.getElementById('hpMaxText').textContent = localPlayer.maxHp;
    
    document.getElementById('xpBar').style.width = (localPlayer.xp / localPlayer.nextXp * 100) + '%';
    document.getElementById('xpText').textContent = localPlayer.xp;
    document.getElementById('xpNextText').textContent = localPlayer.nextXp;
    
    document.getElementById('levelBadge').textContent = localPlayer.level;
    
    document.getElementById('woodCount').textContent = localPlayer.wood;
    document.getElementById('stoneCount').textContent = localPlayer.stone;
    document.getElementById('crystalCount').textContent = localPlayer.crystal;
    document.getElementById('foodCount').textContent = localPlayer.food;
    
    // Atualizar estado do bot√£o de comida
    const btnFood = document.getElementById('btnFood');
    if(localPlayer.food <= 0 || localPlayer.hp >= localPlayer.maxHp) {
        btnFood.classList.add('disabled');
    } else {
        btnFood.classList.remove('disabled');
    }
}

// ==================== CRAFT MENU ====================
function initCraftMenu() {
    const grid = document.getElementById('craftGrid');
    grid.innerHTML = '';
    
    const items = [
        { type: 'wall', icon: 'üß±', name: 'Parede' },
        { type: 'turret', icon: 'üî´', name: 'Torreta' },
        { type: 'campfire', icon: 'üî•', name: 'Fogueira' },
        { type: 'spikes', icon: 'üó°Ô∏è', name: 'Espinhos' },
        { type: 'tower', icon: 'üè∞', name: 'Torre' }
    ];
    
    items.forEach(item => {
        const cost = buildCosts[item.type];
        if(!cost) return;
        
        const div = document.createElement('div');
        div.className = 'craft-item';
        div.onclick = () => craft(item.type);
        div.innerHTML = `
            <div class="craft-icon">${item.icon}</div>
            <div class="craft-name">${item.name}</div>
            <div class="craft-cost">
                ${cost.wood > 0 ? `ü™µ${cost.wood} ` : ''}
                ${cost.stone > 0 ? `ü™®${cost.stone} ` : ''}
                ${cost.crystal > 0 ? `üíé${cost.crystal}` : ''}
            </div>
        `;
        grid.appendChild(div);
    });
}

function openCraft() {
    document.getElementById('craftMenu').classList.remove('hidden');
}

function closeCraft() {
    document.getElementById('craftMenu').classList.add('hidden');
}

function craft(type) {
    socket.emit('build', { type });
    closeCraft();
}

// ==================== UPGRADES ====================
function showUpgradeOptions() {
    const grid = document.getElementById('upgradesGrid');
    grid.innerHTML = '';
    
    const upgrades = [
        { id: 'damage', icon: '‚öîÔ∏è', name: 'Dano', desc: '+5 ATK' },
        { id: 'health', icon: '‚ù§Ô∏è', name: 'Vida', desc: '+30 HP' },
        { id: 'speed', icon: 'üí®', name: 'Velocidade', desc: '+1 SPD' },
        { id: 'range', icon: 'üéØ', name: 'Alcance', desc: '+20 Range' },
        { id: 'attackSpeed', icon: '‚ö°', name: 'Atk Speed', desc: '-50ms' },
        { id: 'lifesteal', icon: 'ü©∏', name: 'Roubo Vida', desc: '+10%' }
    ];
    
    // Selecionar 3 upgrades aleat√≥rios
    const selected = upgrades.sort(() => Math.random() - 0.5).slice(0, 3);
    
    selected.forEach(up => {
        const div = document.createElement('div');
        div.className = 'upgrade-card';
        div.onclick = () => chooseUpgrade(up.id);
        div.innerHTML = `
            <div class="upgrade-icon">${up.icon}</div>
            <div class="upgrade-name">${up.name}</div>
            <div class="upgrade-desc">${up.desc}</div>
        `;
        grid.appendChild(div);
    });
}

function chooseUpgrade(upgrade) {
    socket.emit('chooseUpgrade', upgrade);
    document.getElementById('levelUp').classList.add('hidden');
}

function useFood() {
    if(localPlayer.food > 0 && localPlayer.hp < localPlayer.maxHp) {
        socket.emit('useFood');
    }
}

function respawn() {
    socket.emit('respawn');
    document.getElementById('death').classList.add('hidden');
}

// ==================== CONTROLES ====================
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.clientX < canvas.width / 2) {
            joystickLeft.active = true;
            joystickLeft.x = touch.clientX;
            joystickLeft.y = touch.clientY;
            joystickLeft.id = touch.identifier;
        } else {
            joystickRight.active = true;
            joystickRight.x = touch.clientX;
            joystickRight.y = touch.clientY;
            joystickRight.id = touch.identifier;
        }
    }
}, { passive: false });

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.identifier === joystickLeft.id) {
            const dx = touch.clientX - joystickLeft.x;
            const dy = touch.clientY - joystickLeft.y;
            const dist = Math.min(Math.hypot(dx, dy), 60);
            const angle = Math.atan2(dy, dx);
            
            joystickLeft.dx = Math.cos(angle) * (dist / 60);
            joystickLeft.dy = Math.sin(angle) * (dist / 60);
        }
        
        if(touch.identifier === joystickRight.id) {
            const dx = touch.clientX - joystickRight.x;
            const dy = touch.clientY - joystickRight.y;
            joystickRight.angle = Math.atan2(dy, dx);
        }
    }
}, { passive: false });

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    
    for(let touch of e.changedTouches) {
        if(touch.identifier === joystickLeft.id) {
            joystickLeft.active = false;
            joystickLeft.dx = 0;
            joystickLeft.dy = 0;
        }
        
        if(touch.identifier === joystickRight.id) {
            joystickRight.active = false;
        }
    }
}, { passive: false });

// Teclado (para testes)
const keys = {};
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// ==================== BIOMAS ====================
const BIOME_COLORS = {
    plains: { bg: '#2d4a2d', ground: '#3d5c3d' },
    forest: { bg: '#1a472a', ground: '#2d5a3a' },
    desert: { bg: '#a08050', ground: '#c2a366' },
    ice: { bg: '#6a9fb5', ground: '#a8d4e6' },
    swamp: { bg: '#2d3a2d', ground: '#3a4a3a' },
    volcano: { bg: '#3a1a1a', ground: '#4a2a2a' }
};

function getBiomeAt(x, y) {
    const biomeX = Math.floor(x / BIOME_SIZE);
    const biomeY = Math.floor(y / BIOME_SIZE);
    const biomeIndex = (biomeX + biomeY * 4) % 6;
    const biomeNames = ['plains', 'forest', 'desert', 'ice', 'swamp', 'volcano'];
    return biomeNames[biomeIndex];
}

// ==================== DESENHO ====================
function drawBackground() {
    // Desenhar biomas vis√≠veis
    const startX = Math.floor((camera.x - 100) / BIOME_SIZE) * BIOME_SIZE;
    const startY = Math.floor((camera.y - 100) / BIOME_SIZE) * BIOME_SIZE;
    const endX = camera.x + canvas.width + BIOME_SIZE;
    const endY = camera.y + canvas.height + BIOME_SIZE;
    
    for(let x = startX; x < endX; x += BIOME_SIZE) {
        for(let y = startY; y < endY; y += BIOME_SIZE) {
            if(x < 0 || y < 0 || x >= MAP_SIZE || y >= MAP_SIZE) continue;
            
            const biome = getBiomeAt(x + BIOME_SIZE/2, y + BIOME_SIZE/2);
            const colors = BIOME_COLORS[biome] || BIOME_COLORS.plains;
            
            const screenX = x - camera.x;
            const screenY = y - camera.y;
            
            // Background
            ctx.fillStyle = colors.bg;
            ctx.fillRect(screenX, screenY, BIOME_SIZE, BIOME_SIZE);
            
            // Grid pattern
            ctx.strokeStyle = colors.ground;
            ctx.lineWidth = 1;
            for(let gx = 0; gx < BIOME_SIZE; gx += 80) {
                ctx.beginPath();
                ctx.moveTo(screenX + gx, screenY);
                ctx.lineTo(screenX + gx, screenY + BIOME_SIZE);
                ctx.stroke();
            }
            for(let gy = 0; gy < BIOME_SIZE; gy += 80) {
                ctx.beginPath();
                ctx.moveTo(screenX, screenY + gy);
                ctx.lineTo(screenX + BIOME_SIZE, screenY + gy);
                ctx.stroke();
            }
        }
    }
    
    // Borda do mapa
    ctx.strokeStyle = '#39C5BB';
    ctx.lineWidth = 4;
    ctx.strokeRect(-camera.x, -camera.y, MAP_SIZE, MAP_SIZE);
}

function drawMikuCharacter(x, y, player, isLocal = false) {
    const screenX = x - camera.x;
    const screenY = y - camera.y;
    
    // Fora da tela?
    if(screenX < -100 || screenX > canvas.width + 100 || 
       screenY < -100 || screenY > canvas.height + 100) return;
    
    ctx.save();
    ctx.translate(screenX, screenY);
    
    // Anima√ß√£o
    const time = Date.now() / 100;
    const bobY = Math.sin(time + (isLocal ? 0 : x)) * 2;
    const breathe = Math.sin(time * 0.5) * 0.05 + 1;
    
    // Sombra
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(0, 28, 18, 8, 0, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.translate(0, bobY);
    ctx.scale(player.facing || 1, 1);
    
    // Cores baseadas no player
    const hairColor = player.color || '#39C5BB';
    const skinColor = '#FDB7B2';
    
    // Twintails (cabelo comprido)
    ctx.fillStyle = hairColor;
    
    // Twintail esquerdo
    ctx.beginPath();
    ctx.moveTo(-15, -25);
    ctx.quadraticCurveTo(-25, 10, -20, 35 + Math.sin(time) * 3);
    ctx.quadraticCurveTo(-15, 40, -10, 35);
    ctx.quadraticCurveTo(-12, 10, -10, 
